<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ScuolaBoard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#1a1a2e}
textarea,input,select,button{font-family:inherit}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes fadein{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pulse{animation:pulse 2s infinite}
.fadein{animation:fadein .3s ease}
.card-wrap{transition:opacity .2s,transform .2s}
.card-wrap.dragging{opacity:.35;transform:scale(.97)}
.card-wrap.drag-over{outline:2px dashed #6366f1;border-radius:16px;outline-offset:2px}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
(function(){
firebase.initializeApp({
  apiKey:"AIzaSyDIC39upI9VnY10MdP7__7l3omyGqspHNA",
  authDomain:"scuolaboard-874d4.firebaseapp.com",
  projectId:"scuolaboard-874d4",
  storageBucket:"scuolaboard-874d4.firebasestorage.app",
  messagingSenderId:"249372381209",
  appId:"1:249372381209:web:737697d4d10b3ae06eda88"
});
var db=firebase.firestore(),auth=firebase.auth();
var h=React.createElement,useState=React.useState,useEffect=React.useEffect,useRef=React.useRef,Fragment=React.Fragment;
var PROF_TOKEN="sb_prof_2025_xK9mNpQr";
var CLASSI_COLORS=["#f59e0b","#22c55e","#3b82f6","#ec4899","#8b5cf6","#ef4444","#06b6d4","#f97316","#84cc16","#a855f7"];
function classeColor(nome,lista){var idx=lista.indexOf(nome);return CLASSI_COLORS[idx%CLASSI_COLORS.length]||"#f59e0b";}
var CLASSI_DEFAULT=["1AO","1AI","1BO","1CO","2AO","2AI","2BO","2CO","3AO","3AI","3BO","4AO","4AI","4BO","5AO","5AA","5AI","5BO"];
function fbClassiSave(arr){return db.collection("config").doc("classi_custom").set({lista:arr,aggiornato:new Date().toISOString()});}
function fbFavSave(uid,ids){return db.collection("preferiti").doc(uid).set({ids:ids,aggiornato:new Date().toISOString()});}
function fbFavListen(uid,cb){return db.collection("preferiti").doc(uid).onSnapshot(function(doc){cb(doc.exists&&doc.data().ids?doc.data().ids:[]);});}
function fbClassiListen(cb){return db.collection("config").doc("classi_custom").onSnapshot(function(doc){cb(doc.exists&&doc.data().lista?doc.data().lista:[]);});}
var FORM0={tipo:"domanda",titolo:"",testo:"",opzioni:["",""],links:[{url:"",label:""}],classi:["TUTTE"]};

function fmt(d){return new Date(d).toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"});}
function fmtDT(d){if(!d)return"";var dt=new Date(d);return dt.toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"})+" "+dt.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});}
function isNew(d){return Date.now()-new Date(d).getTime()<86400000;}
function badgeBg(t){return t==="domanda"?"#6366f1":t==="nota"?"#f59e0b":t==="sondaggio"?"#22c55e":"#94a3b8";}
function tipoIcon(t){return t==="domanda"?"üí¨":t==="nota"?"üìÑ":t==="sondaggio"?"üó≥Ô∏è":"üìå";}
function fbSave(c){return db.collection("cards").doc(String(c.id)).set(c);}
function fbDel(id){return db.collection("cards").doc(String(id)).delete();}
function fbListen(cb){return db.collection("cards").orderBy("ordine","asc").onSnapshot(function(s){var a=[];s.forEach(function(d){a.push(d.data());});cb(a);});}
function normalizeLinks(c){
  if(c.links&&Array.isArray(c.links))return c.links;
  if(c.linkEsterno&&typeof c.linkEsterno==="string")return[{url:c.linkEsterno,label:""}];
  return[];
}

// ‚îÄ‚îÄ Firestore AI results ‚îÄ‚îÄ
function aiSave(cardId,data){
  return db.collection("ai_results").doc(String(cardId)).set(data,{merge:true});
}
function aiLoad(cb){
  return db.collection("ai_results").onSnapshot(function(s){
    var m={};s.forEach(function(d){m[d.id]=d.data();});cb(m);
  });
}

// ‚îÄ‚îÄ Groq ‚îÄ‚îÄ
var GROQ_MODELS=["llama-3.3-70b-versatile","llama3-70b-8192","llama3-8b-8192"];
function callGroqJSON(k,prompt,mx){return _groq(k,prompt,mx||700,0,true);}
function callGroqText(k,prompt,mx){return _groq(k,prompt,mx||600,0,false);}
function _groq(k,prompt,mx,mi,json){
  if(mi>=GROQ_MODELS.length)return Promise.reject(new Error("Nessun modello disponibile."));
  return fetch("https://api.groq.com/openai/v1/chat/completions",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+k},
    body:JSON.stringify({
      model:GROQ_MODELS[mi],max_tokens:mx,temperature:0.7,
      messages:[
        {role:"system",content:json?"Sei un assistente pedagogico italiano. Rispondi SOLO con JSON valido. Nessun testo, nessun markdown.":"Sei un assistente pedagogico italiano. Rispondi in italiano in modo diretto e utile."},
        {role:"user",content:prompt}
      ]
    })
  }).then(function(r){
    if(r.status===429||r.status===503)return _groq(k,prompt,mx,mi+1,json);
    if(!r.ok)return r.json().then(function(e){throw new Error(e.error&&e.error.message||"Errore "+r.status);});
    return r.json();
  }).then(function(d){
    var raw=(d.choices&&d.choices[0]&&d.choices[0].message&&d.choices[0].message.content||"").trim();
    if(!raw)return _groq(k,prompt,mx,mi+1,json);
    if(!json)return raw;
    raw=raw.replace(/^```(?:json)?[\r\n]*/i,"").replace(/[\r\n]*```$/,"").trim();
    var m=raw.match(/\{[\s\S]*\}/);
    if(!m)return _groq(k,prompt,mx,mi+1,json);
    try{return JSON.parse(m[0]);}catch(e){return _groq(k,prompt,mx,mi+1,json);}
  });
}

var S={
  input:{width:"100%",padding:"8px 10px",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,fontSize:13,background:"rgba(255,255,255,.08)",color:"#f1f5f9"},
  filterBtn:function(a){return{display:"flex",alignItems:"center",gap:4,padding:"5px 12px",borderRadius:20,border:"1px solid "+(a?"#6366f1":"rgba(255,255,255,.15)"),background:a?"#6366f1":"rgba(255,255,255,.05)",color:a?"#fff":"rgba(255,255,255,.6)",fontSize:12,fontWeight:700,cursor:"pointer"};}
};

function renderLinks(card){
  var links=normalizeLinks(card);
  if(!links.length)return null;
  return h("div",{style:{marginTop:8,display:"flex",flexDirection:"column",gap:5}},
    links.map(function(l,i){
      if(!l.url)return null;
      return h("a",{key:i,href:l.url,target:"_blank",rel:"noopener noreferrer",
        style:{display:"inline-flex",alignItems:"center",gap:6,background:"rgba(59,130,246,.15)",color:"#60a5fa",padding:"5px 10px",borderRadius:7,textDecoration:"none",fontSize:11,fontWeight:600,border:"1px solid rgba(59,130,246,.3)"}},
        "üîó "+(l.label||"Approfondisci"));
    })
  );
}

function App(){
  var [user,setUser]=useState(null);
  var [authLoad,setAuthLoad]=useState(true);
  var [cards,setCards]=useState([]);
  var [view,setView]=useState("bacheca");
  var [previewSt,setPreviewSt]=useState(false);
  var [showModal,setSM]=useState(false);
  var [showCard,setSC]=useState(null);
  var [showQR,setSQR]=useState(false);
  var [showReset,setSR]=useState(false);
  var [form,setForm]=useState(Object.assign({},FORM0));
  var [editMode,setEditMode]=useState(null);
  var [nc,setNc]=useState({testo:""});
  var [editingCm,setEditingCm]=useState(null);
  var [replyTo,setReplyTo]=useState(null);
  var [replyTesto,setReplyTesto]=useState("");
  var [confirmDel,setConfirmDel]=useState(null);
  var [showResetOpt,setShowResetOpt]=useState(false);
  var [orKey,setOrKey]=useState(localStorage.getItem("groq_key")||"");
  var [askKey,setAskKey]=useState(false);
  var [akInput,setAkInput]=useState("");
  var [aiRunning,setAiRunning]=useState(false);
  var [aiResult,setAiR]=useState(null);
  var [aiTarget,setAIT]=useState("tutte");
  var [aiErr,setAiErr]=useState("");
  // AI results da Firestore ‚Äî { cardId: { q, risposta, data, sintesi, dinamica, spunto } }
  var [aiMap,setAiMap]=useState({});
  // AI inline card
  var [cardAiLoad,setCardAIL]=useState(null);
  var [cardAiOpen,setCardAiOpen]=useState(null);
  // AI domanda libera
  var [cardQ,setCardQ]=useState("");
  var [cardQLoad,setCardQLoad]=useState(false);
  var [cardQErr,setCardQErr]=useState("");
  var [cardQOpen,setCardQOpen]=useState({});
  // Classe
  var [showClasseModal,setShowClasseModal]=useState(false);
  var [classeInput,setClasseInput]=useState("");
  var [filterClasse,setFilterClasse]=useState("tutte");
  var [viewStudenti,setViewStudenti]=useState(false);
  var [studenti,setStudenti]=useState([]);
  // Classi custom
  var [classiCustom,setClassiCustom]=useState([]);
  var [addingClasse,setAddingClasse]=useState(false);
  var [newClasseInput,setNewClasseInput]=useState("");
  // Preferiti
  var [preferiti,setPreferiti]=useState([]);
  // Rinomina classe
  var [rinominaClasse,setRinominaClasse]=useState(null);
  var [rinominaInput,setRinominaInput]=useState("");
  var [rinominaConferma,setRinominaConferma]=useState(false);
  // Badge NEW: set di id card gi√† lette (localStorage)
  var seenRef=useRef((function(){try{var s=localStorage.getItem("seen_cards");return new Set(s?JSON.parse(s):[]);}catch(e){return new Set();}})());
  function markSeen(id){if(!seenRef.current.has(String(id))){seenRef.current.add(String(id));try{localStorage.setItem("seen_cards",JSON.stringify([...seenRef.current]));}catch(e){}}}
  // Export PDF
  var [showExport,setShowExport]=useState(false);
  var [exportFiltro,setExportFiltro]=useState("tutte");
  var [exportTipo,setExportTipo]=useState("tutti");
  var [exportIncludiCommenti,setExportIncludiCommenti]=useState(true);
  var [exportIncludiVoti,setExportIncludiVoti]=useState(true);
  var [exportIncludiAI,setExportIncludiAI]=useState(true);
  // Duplica
  var [showDuplica,setShowDuplica]=useState(null);
  var [duplicaClassi,setDuplicaClassi]=useState([]);
  var myLikes=useRef(new Set());
  var CLASSI_LIST=CLASSI_DEFAULT.concat(classiCustom.filter(function(c){return CLASSI_DEFAULT.indexOf(c)<0;}));
  function addClasseCustom(){
    var v=newClasseInput.trim().toUpperCase();
    if(!v)return;
    if(CLASSI_LIST.indexOf(v)>=0){setAddingClasse(false);setNewClasseInput("");return;}
    var next=classiCustom.concat([v]);
    setClassiCustom(next);fbClassiSave(next);
    setAddingClasse(false);setNewClasseInput("");
  }
  function removeClasseCustom(cl){
    var next=classiCustom.filter(function(c){return c!==cl;});
    setClassiCustom(next);fbClassiSave(next);
  }
  function apriRinomina(cl){setRinominaClasse(cl);setRinominaInput(cl);setRinominaConferma(false);}
  function eseguiRinomina(){
    var oldN=rinominaClasse,newN=rinominaInput.trim().toUpperCase();
    if(!newN||newN===oldN){setRinominaClasse(null);return;}
    if(!rinominaConferma){setRinominaConferma(true);return;}
    // aggiorna lista classi
    var next=classiCustom.map(function(c){return c===oldN?newN:c;});
    setClassiCustom(next);fbClassiSave(next);
    // aggiorna tutte le card che contengono oldN
    var toUpdate=cards.filter(function(c){return (c.classi||[]).indexOf(oldN)>=0;});
    toUpdate.forEach(function(c){fbSave(Object.assign({},c,{classi:c.classi.map(function(x){return x===oldN?newN:x;})}) );});
    // aggiorna studenti con quella classe
    db.collection("users").where("classe","==",oldN).get().then(function(snap){snap.forEach(function(d){d.ref.update({classe:newN});});});
    setRinominaClasse(null);setRinominaConferma(false);
  }
  function togglePreferito(cardId){
    var id=String(cardId);
    var next=preferiti.indexOf(id)>=0?preferiti.filter(function(x){return x!==id;}):[].concat(preferiti,[id]);
    setPreferiti(next);fbFavSave(user.uid,next);
  }
  async function generaPDF(){
    var cardsDaEsportare=cards.filter(function(c){
      if(c.proposta)return false;
      if(exportTipo!=="tutti"&&c.tipo!==exportTipo)return false;
      if(exportFiltro==="tutte")return true;
      var cc=c.classi||["TUTTE"];
      return cc.indexOf("TUTTE")>=0||cc.indexOf(exportFiltro)>=0;
    });
    var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>';
    html+='body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:24px;color:#1e293b;}';
    html+='h1{font-size:22px;border-bottom:3px solid #6366f1;padding-bottom:8px;margin-bottom:20px;}';
    html+='.card{border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:18px;page-break-inside:avoid;}';
    html+='.badge{display:inline-block;padding:2px 8px;border-radius:5px;font-size:11px;font-weight:700;color:#fff;margin-bottom:8px;}';
    html+='.titolo{font-size:15px;font-weight:700;margin-bottom:6px;}';
    html+='.testo{font-size:13px;color:#475569;margin-bottom:8px;line-height:1.6;}';
    html+='.meta{font-size:11px;color:#94a3b8;margin-bottom:8px;}';
    html+='.classe{display:inline-block;background:#fef3c7;color:#92400e;border-radius:4px;padding:1px 6px;font-size:10px;font-weight:700;margin-right:4px;}';
    html+='.commenti{margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;}';
    html+='.cm{background:#f8fafc;border-radius:6px;padding:7px 10px;margin-bottom:5px;font-size:12px;}';
    html+='.opzione{margin-bottom:6px;}.bar{height:8px;background:#e2e8f0;border-radius:4px;margin-top:3px;}.fill{height:8px;background:#6366f1;border-radius:4px;}';
    html+='@media print{body{padding:0;}}</style></head><body>';
    html+='<h1>üìå ScuolaBoard ‚Äî Export</h1>';
    html+='<p style="font-size:12px;color:#94a3b8;margin-bottom:20px;">Generato il '+new Date().toLocaleDateString("it-IT",{day:"2-digit",month:"long",year:"numeric"})+(exportFiltro!=="tutte"?" ¬∑ Classe: "+exportFiltro:"")+(exportTipo!=="tutti"?" ¬∑ Tipo: "+exportTipo:"")+'</p>';
    for(var ci=0;ci<cardsDaEsportare.length;ci++){
      var c=cardsDaEsportare[ci];
      var bgBadge=c.tipo==="domanda"?"#6366f1":c.tipo==="nota"?"#f59e0b":c.tipo==="sondaggio"?"#22c55e":"#94a3b8";
      var cc=(c.classi||["TUTTE"]);
      html+='<div class="card">';
      html+='<span class="badge" style="background:'+bgBadge+'">'+tipoIcon(c.tipo)+' '+c.tipo.toUpperCase()+'</span>';
      if(cc.indexOf("TUTTE")<0)cc.forEach(function(cl){html+='<span class="classe">'+cl+'</span>';});
      html+='<div class="titolo">'+escHtml(c.titolo)+'</div>';
      if(c.testo)html+='<div class="testo">'+escHtml(c.testo)+'</div>';
      html+='<div class="meta">üë§ '+escHtml(c.autore||"")+'&nbsp;&nbsp;üìÖ '+fmt(c.data)+'&nbsp;&nbsp;üëç '+(c.likes||0)+'</div>';
      if(exportIncludiAI){
        var aiD=aiMap[String(c.id)];
        var cRes=aiD&&aiD.analisi;
        var debugInfo='';
        var rawSnap=null;
        if(!cRes){
          try{
            var snap=await db.collection("ai_results").doc(String(c.id)).get();
            rawSnap=snap;
            if(snap.exists)cRes=snap.data().analisi;
          }catch(e){debugInfo='Errore Firestore: '+e.message;}
        }
        // DEBUG: mostra struttura raw nel PDF
        html+='<div style="background:#fffbeb;border:1px dashed #f59e0b;border-radius:6px;padding:8px;margin-bottom:6px;font-size:10px;color:#92400e;">';
        html+='<b>DEBUG card id:</b> '+escHtml(String(c.id))+'<br>';
        html+='<b>aiMap keys:</b> '+escHtml(Object.keys(aiMap).join(', '))+'<br>';
        html+='<b>aiD from aiMap:</b> '+escHtml(JSON.stringify(aiD))+'<br>';
        if(rawSnap){html+='<b>Firestore snap exists:</b> '+rawSnap.exists+'<br>';if(rawSnap.exists)html+='<b>Firestore raw data:</b> '+escHtml(JSON.stringify(rawSnap.data()))+'<br>';}
        html+='<b>cRes finale:</b> '+escHtml(JSON.stringify(cRes))+'<br>';
        if(debugInfo)html+='<b>Errore:</b> '+escHtml(debugInfo)+'<br>';
        html+='</div>';
        if(cRes&&(cRes.sintesi||cRes.dinamica||cRes.spunto)){
          html+='<div style="margin-top:10px;background:#f0f4ff;border:1px solid #c7d2fe;border-radius:8px;padding:10px 14px;">';
          html+='<div style="font-size:11px;font-weight:700;color:#6366f1;margin-bottom:8px;">ü§ñ Analisi AI</div>';
          if(cRes.sintesi)html+='<div style="margin-bottom:7px;"><span style="font-size:10px;font-weight:700;color:#6366f1;letter-spacing:1px;">üìã SINTESI</span><div style="font-size:12px;color:#334155;margin-top:3px;line-height:1.6;">'+escHtml(cRes.sintesi)+'</div></div>';
          if(cRes.dinamica)html+='<div style="margin-bottom:7px;"><span style="font-size:10px;font-weight:700;color:#3b82f6;letter-spacing:1px;">üí¨ DINAMICA</span><div style="font-size:12px;color:#334155;margin-top:3px;line-height:1.6;">'+escHtml(cRes.dinamica)+'</div></div>';
          if(cRes.spunto)html+='<div><span style="font-size:10px;font-weight:700;color:#22c55e;letter-spacing:1px;">üí° SPUNTO</span><div style="font-size:12px;color:#334155;margin-top:3px;line-height:1.6;font-style:italic;">'+escHtml(cRes.spunto)+'</div></div>';
          html+='</div>';
        }
      }
      if(exportIncludiVoti&&c.tipo==="sondaggio"&&c.opzioni){
        var totV=c.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
        html+='<div style="margin-top:8px;font-size:12px;font-weight:700;margin-bottom:6px;">üó≥Ô∏è Risultati ('+totV+' voti)</div>';
        c.opzioni.forEach(function(o){var pct=totV>0?Math.round(o.voti.length/totV*100):0;html+='<div class="opzione"><span style="font-size:12px;">'+escHtml(o.testo)+'</span> <span style="font-size:11px;color:#6366f1;font-weight:700;">'+pct+'% ('+o.voti.length+')</span><div class="bar"><div class="fill" style="width:'+pct+'%"></div></div></div>';});
      }
      if(exportIncludiCommenti&&(c.commenti||[]).length>0){
        html+='<div class="commenti"><div style="font-size:11px;font-weight:700;color:#6366f1;margin-bottom:6px;">üí¨ Commenti ('+c.commenti.length+')</div>';
        c.commenti.forEach(function(cm){html+='<div class="cm"><b>'+escHtml(cm.autore)+'</b>: '+escHtml(cm.testo)+'<span style="font-size:10px;color:#94a3b8;margin-left:8px;">'+fmt(cm.data||"")+'</span>';if(cm.risposte&&cm.risposte.length){cm.risposte.forEach(function(r){html+='<div style="margin-left:12px;margin-top:4px;padding-left:8px;border-left:2px solid #e2e8f0;font-size:11px;"><b>'+escHtml(r.autore)+'</b>: '+escHtml(r.testo)+'</div>';});}html+='</div>';});
        html+='</div>';
      }
      html+='</div>';
    }
    html+='</body></html>';
    var blob=new Blob([html],{type:"text/html"});
    var url=URL.createObjectURL(blob);
    var w=window.open(url,"_blank");
    setTimeout(function(){if(w)w.print();},600);
    setShowExport(false);
  }
  function escHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
  var nextOrd=useRef(100);
  var dragId=useRef(null);

  function myName(u){return u?(u.role==="prof"?"Prof":(u.nome+" "+u.cognome).trim()||u.email):"?";}
  function closeCard(){setSC(null);setEditingCm(null);setReplyTo(null);setCardQErr("");setCardQ("");}

  useEffect(function(){
    auth.getRedirectResult().then(function(cr){
      if(!cr||!cr.user)return;
      var fu=cr.user;
      db.collection("users").doc(fu.uid).get().then(function(ud){
        if(!ud.exists){var np=(fu.displayName||"").split(" ");db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google"});}
      });
    }).catch(function(){});
    var unsub=auth.onAuthStateChanged(function(fu){
      if(fu){
        db.collection("users").doc(fu.uid).get().then(function(doc){
          var base={uid:fu.uid,email:fu.email,displayName:fu.displayName,photoURL:fu.photoURL};
          if(doc.exists){var d=doc.data();setUser(Object.assign({},base,{role:d.role||"studente",nome:d.nome||"Utente",cognome:d.cognome||"",classe:d.classe||null}));}
          else{setUser(Object.assign({},base,{role:"studente",nome:fu.displayName?fu.displayName.split(" ")[0]:"Utente",cognome:"",classe:null}));}
          setAuthLoad(false);
        }).catch(function(){setAuthLoad(false);});
      } else {setUser(null);setAuthLoad(false);}
    });
    return unsub;
  },[]);

  useEffect(function(){
    if(!user)return;
    var u1=fbListen(function(remote){
      if(remote.length===0&&user.role==="prof"){
        [{id:"demo1",tipo:"domanda",titolo:"Benvenuto in ScuolaBoard",testo:"Questa √® una card demo!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:1,commenti:[],links:[],visibile:true,classi:["TUTTE"]},
         {id:"demo2",tipo:"sondaggio",titolo:"Ti piace questa bacheca?",testo:"Vota!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:2,commenti:[],links:[],visibile:true,classi:["TUTTE"],opzioni:[{id:"o1",testo:"S√¨, molto!",voti:[]},{id:"o2",testo:"Cos√¨ cos√¨",voti:[]},{id:"o3",testo:"Da migliorare",voti:[]}]}
        ].forEach(function(c){fbSave(c);});
      } else {
        nextOrd.current=Math.max.apply(null,remote.map(function(c){return c.ordine||0;}).concat([0]))+1;
        setCards(remote);
        setSC(function(prev){return prev?remote.find(function(c){return c.id===prev.id;})||null:null;});
      }
    });
    // Ascolta classi custom (tutti gli utenti)
    var u3=fbClassiListen(function(lista){setClassiCustom(lista);});
    // Ascolta preferiti studente
    var u4=fbFavListen(user.uid,function(ids){setPreferiti(ids);});
    // Ascolta ai_results solo per prof
    var u2=null;
    if(user.role==="prof"){
      u2=aiLoad(function(m){setAiMap(m);});
    }
    return function(){u1();if(u2)u2();u3();u4();};
  },[user]);

  async function loginGoogle(){
    try{
      var provider=new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:"select_account"});
      var cr=await auth.signInWithPopup(provider);
      var fu=cr.user,ud=await db.collection("users").doc(fu.uid).get();
      if(!ud.exists){var np=(fu.displayName||"").split(" ");await db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google"});}
    }catch(e){if(e.code==="auth/popup-blocked"){try{await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());}catch(e2){}}}
  }
  function logout(){auth.signOut();setUser(null);localStorage.removeItem("groq_key");}

  function saveClasse(){
    if(!classeInput)return;
    db.collection("users").doc(user.uid).update({classe:classeInput}).then(function(){
      setUser(function(u){return Object.assign({},u,{classe:classeInput});});
      setShowClasseModal(false);
    });
  }
  function loadStudenti(){
    db.collection("users").where("role","==","studente").get().then(function(snap){
      var arr=[];snap.forEach(function(d){arr.push(Object.assign({uid:d.id},d.data()));});
      arr.sort(function(a,b){return(a.cognome||"").localeCompare(b.cognome||"","it");});
      setStudenti(arr);
    });
  }
  function aggiornaClasseStudente(uid,cl){
    db.collection("users").doc(uid).update({classe:cl||null}).then(function(){
      setStudenti(function(prev){return prev.map(function(s){return s.uid===uid?Object.assign({},s,{classe:cl||null}):s;});});
    });
  }
  function rimuoviStudente(uid){
    if(!window.confirm("Rimuovere questo studente?"))return;
    db.collection("users").doc(uid).update({classe:null}).then(function(){
      setStudenti(function(prev){return prev.map(function(s){return s.uid===uid?Object.assign({},s,{classe:null}):s;});});
    });
  }

  function toggleVisibile(card,e){e.stopPropagation();fbSave(Object.assign({},card,{visibile:card.visibile===false}));}
  function onDragStart(e,id){dragId.current=id;e.dataTransfer.effectAllowed="move";setTimeout(function(){var el=document.getElementById("card-"+id);if(el)el.classList.add("dragging");},0);}
  function onDragEnd(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("dragging");document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});}
  function onDragOver(e,id){e.preventDefault();if(String(dragId.current)===String(id))return;var el=document.getElementById("card-"+id);if(el)el.classList.add("drag-over");}
  function onDragLeave(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("drag-over");}
  function onDrop(e,targetId){
    e.preventDefault();document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});
    var fromId=dragId.current;if(!fromId||String(fromId)===String(targetId))return;
    var arr=cards.slice().sort(function(a,b){return(a.ordine||0)-(b.ordine||0);});
    var fi=arr.findIndex(function(c){return String(c.id)===String(fromId);});
    var ti=arr.findIndex(function(c){return String(c.id)===String(targetId);});
    if(fi<0||ti<0)return;
    var moved=arr.splice(fi,1)[0];arr.splice(ti,0,moved);
    arr.forEach(function(c,i){fbSave(Object.assign({},c,{ordine:i+1}));});
    dragId.current=null;
  }

  function apriDuplica(card,e){e.stopPropagation();setShowDuplica(card);setDuplicaClassi([]);}
  function confermaDuplica(){
    if(!showDuplica||!duplicaClassi.length)return;
    duplicaClassi.forEach(function(cl){
      var newId=Date.now()+"_"+Math.random().toString(36).slice(2,7);
      var copia=Object.assign({},showDuplica,{id:newId,classi:[cl],ordine:nextOrd.current++,commenti:[],likes:0,data:new Date().toISOString().slice(0,10),titolo:showDuplica.titolo+" ["+cl+"]"});
      if(showDuplica.opzioni&&Array.isArray(showDuplica.opzioni)){copia.opzioni=showDuplica.opzioni.map(function(o){return Object.assign({},o,{voti:[]});});}
      else{delete copia.opzioni;}
      fbSave(copia);
    });
    setShowDuplica(null);setDuplicaClassi([]);
  }

  var totC=cards.reduce(function(a,c){return a+(c.commenti||[]).length;},0);
  var proposte=cards.filter(function(c){return c.proposta;});
  var isProf=user&&user.role==="prof";
  var simulaSt=isProf&&previewSt;

  var visible=cards.filter(function(c){
    if(simulaSt||!isProf){
      if(c.proposta||c.visibile===false)return false;
      var cc=c.classi||["TUTTE"];if(cc.length===0)return false;
      var stC=user&&user.classe;
      if(!stC)return cc.indexOf("TUTTE")>=0;
      return cc.indexOf("TUTTE")>=0||cc.indexOf(stC)>=0;
    }
    if(filterClasse!=="tutte"){var cc=c.classi||["TUTTE"];if(cc.indexOf("TUTTE")<0&&cc.indexOf(filterClasse)<0)return false;}
    return true;
  });

  function addCard(){
    if(!form.titolo.trim()||!user)return;
    var opzioni=null;
    if(form.tipo==="sondaggio")opzioni=form.opzioni.filter(function(o){return o.trim();}).map(function(o,i){return{id:"o"+Date.now()+"_"+i,testo:o,voti:[]};});
    var cleanLinks=(form.links||[]).filter(function(l){return l.url&&l.url.trim();}).map(function(l){return{url:l.url.trim(),label:(l.label||"").trim()};});
    var classiSalvate=form.classi&&form.classi.length?form.classi:[];
    if(editMode){
      var c=Object.assign({},editMode,{tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),links:cleanLinks,linkEsterno:null,classi:classiSalvate});
      if(opzioni)c.opzioni=opzioni;fbSave(c);setEditMode(null);
    } else {
      var c={id:Date.now(),tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),data:new Date().toISOString().slice(0,10),autore:myName(user),likes:0,commenti:[],ordine:nextOrd.current++,links:cleanLinks,linkEsterno:null,visibile:true,_token:isProf?PROF_TOKEN:null,classi:classiSalvate};
      if(opzioni)c.opzioni=opzioni;
      if(!isProf){c.proposta=true;if(user.classe)c.classi=[user.classe];}
      fbSave(c);
    }
    setSM(false);setForm(Object.assign({},FORM0));
  }
  function editCard(card){
    setEditMode(card);
    var links=normalizeLinks(card);
    setForm({tipo:card.tipo,titolo:card.titolo,testo:card.testo||"",opzioni:card.opzioni?card.opzioni.map(function(o){return o.testo;}):["",""],links:links.length?links:[{url:"",label:""}],classi:card.classi||["TUTTE"]});
    setSM(true);
  }
  function delCard(id){setConfirmDel({type:"card",id:id});}
  function appCard(id){var c=cards.find(function(x){return x.id===id;});if(c)fbSave(Object.assign({},c,{proposta:false}));}
  function toggleLike(cardId){
    var card=cards.find(function(c){return c.id===cardId;});if(!card)return;
    var key=String(cardId),liked=myLikes.current.has(key);
    liked?myLikes.current.delete(key):myLikes.current.add(key);
    fbSave(Object.assign({},card,{likes:(card.likes||0)+(liked?-1:1)}));
  }
  function vote(cid,oid){
    if(!user)return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    var vn=myName(user);
    fbSave(Object.assign({},card,{opzioni:card.opzioni.map(function(o){var voti=o.voti.filter(function(v){return v!==vn;});if(o.id===oid)voti=voti.concat([vn]);return Object.assign({},o,{voti:voti});})}));
  }
  function addCom(){
    if(!user||!nc.testo.trim())return;
    var card=cards.find(function(c){return c.id===showCard.id;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:(card.commenti||[]).concat([{id:Date.now(),autore:myName(user),testo:nc.testo.trim(),data:new Date().toISOString().slice(0,10),risposte:[]}])}));
    setNc({testo:""});
  }
  function addReply(cmId){
    if(!user||!replyTesto.trim())return;
    var card=cards.find(function(c){return String(c.id)===String(showCard.id);});if(!card)return;
    var nuova={id:Date.now(),autore:myName(user),testo:replyTesto.trim(),data:new Date().toISOString().slice(0,10),risposte:[]};
    function ins(lista){return lista.map(function(item){if(String(item.id)===String(cmId))return Object.assign({},item,{risposte:(item.risposte||[]).concat([nuova])});if(item.risposte&&item.risposte.length)return Object.assign({},item,{risposte:ins(item.risposte)});return item;});}
    fbSave(Object.assign({},card,{commenti:ins(card.commenti)}));
    setReplyTo(null);setReplyTesto("");
  }
  function executeDelReply(cmId,rId,cardId){
    var card=cards.find(function(c){return String(c.id)===String(cardId);});if(!card)return;
    function rem(lista){return lista.map(function(item){if(String(item.id)===String(cmId))return Object.assign({},item,{risposte:(item.risposte||[]).filter(function(r){return String(r.id)!==String(rId);})});if(item.risposte&&item.risposte.length)return Object.assign({},item,{risposte:rem(item.risposte)});return item;});}
    fbSave(Object.assign({},card,{commenti:rem(card.commenti)}));
  }
  function executeDelCom(cid,cmid){var card=cards.find(function(c){return c.id===cid;});if(!card)return;fbSave(Object.assign({},card,{commenti:card.commenti.filter(function(cm){return cm.id!==cmid;})}));}
  function saveEditCm(cid){
    if(!editingCm||!editingCm.testo.trim())return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:card.commenti.map(function(cm){return cm.id===editingCm.id?Object.assign({},cm,{testo:editingCm.testo.trim(),modificato:true}):cm;})}));
    setEditingCm(null);
  }
  function resetAll(){cards.forEach(function(c){fbDel(c.id);});setAiR(null);setSR(false);}
  function resetComments(){cards.forEach(function(c){if(c.commenti&&c.commenti.length>0)fbSave(Object.assign({},c,{commenti:[]}));});setShowResetOpt(false);}
  function resetVotes(){cards.forEach(function(c){if(c.opzioni)fbSave(Object.assign({},c,{opzioni:c.opzioni.map(function(o){return Object.assign({},o,{voti:[]});})}));});setShowResetOpt(false);}
  function resetSondaggio(cardId){var card=cards.find(function(c){return String(c.id)===String(cardId);});if(!card)return;var u=Object.assign({},card,{commenti:[]});if(u.opzioni)u.opzioni=u.opzioni.map(function(o){return Object.assign({},o,{voti:[]});});fbSave(u);}
  function saveAIKey(){if(akInput.trim()){localStorage.setItem("groq_key",akInput.trim());setOrKey(akInput.trim());setAskKey(false);setAkInput("");}}

  function cardContext(card){
    var commTxt=(card.commenti||[]).length
      ?(card.commenti||[]).map(function(cm){var r="  - "+cm.autore+": \""+cm.testo+"\"";if(cm.risposte&&cm.risposte.length)r+=cm.risposte.map(function(rep){return"\n    ‚Ü≥ "+rep.autore+": \""+rep.testo+"\"";}).join("");return r;}).join("\n")
      :"nessun commento";
    var votiTxt="";
    if(card.opzioni){var tv=card.opzioni.reduce(function(a,o){return a+o.voti.length;},0);votiTxt="\nVoti (totale "+tv+"):\n"+card.opzioni.map(function(o){var p=tv>0?Math.round(o.voti.length/tv*100):0;return"  - \""+o.testo+"\": "+o.voti.length+" ("+p+"%)";}).join("\n");}
    return 'Titolo: "'+card.titolo+'"\nTipo: '+card.tipo+'\nTesto: '+(card.testo||"(nessuno)")+'\nLike: '+(card.likes||0)+votiTxt+'\nCommenti:\n'+commTxt;
  }

  // AI analisi globale
  function runAI(){
    if(!orKey){setAskKey(true);return;}
    setAiRunning(true);setAiR(null);setAiErr("");
    var target=aiTarget==="tutte"?cards.filter(function(c){return !c.proposta;}):[cards.find(function(c){return String(c.id)===String(aiTarget);})].filter(Boolean);
    if(!target.length){setAiErr("Nessuna card.");setAiRunning(false);return;}
    var det=target.map(function(c){return "CARD: \""+c.titolo+"\" (tipo:"+c.tipo+", like:"+(c.likes||0)+")\n"+cardContext(c);}).join("\n\n---\n\n");
    var prompt='Sei un assistente pedagogico per un insegnante di Religione (scuola secondaria II grado).\nAnalizza SOLO i dati reali.\nRispondi con JSON:\n{"riepilogo":"...","dibattito":"...","punti_chiave":["..."],"spunti_dibattito":["..."]}\n\nDATI:\n'+det.slice(0,2500);
    callGroqJSON(orKey,prompt,900)
      .then(function(r){if(r&&(r.riepilogo||r.dibattito))setAiR(r);else setAiErr("Risposta non valida.");})
      .catch(function(e){setAiErr(e.message||"Errore AI.");})
      .then(function(){setAiRunning(false);});
  }

  // AI analisi inline ‚Äî salva su Firestore
  function runCardAI(card,e){
    e.stopPropagation();
    if(!orKey){setAskKey(true);return;}
    setCardAIL(card.id);setCardAiOpen(card.id);
    var prompt='Sei un assistente pedagogico.\nAnalizza SOLO i dati reali.\nRispondi con JSON:\n{"sintesi":"...","dinamica":"...","spunto":"..."}\n\nDATI:\n'+cardContext(card);
    callGroqJSON(orKey,prompt,600)
      .then(function(r){
        if(r&&!r.error){
          var data={sintesi:r.sintesi||"",dinamica:r.dinamica||"",spunto:r.spunto||"",data:new Date().toISOString(),cardTitolo:card.titolo};
          aiSave(card.id,{analisi:data});
        }
      })
      .catch(function(){})
      .then(function(){setCardAIL(null);});
  }

  // AI domanda libera ‚Äî salva su Firestore (array di domande)
  function runCardQ(){
    if(!cardQ.trim()||!showCard)return;
    if(!orKey){setAskKey(true);return;}
    setCardQLoad(true);setCardQErr("");
    var card=showCard;
    var prompt='Sei un assistente pedagogico italiano per un insegnante di Religione (scuola secondaria II grado).\nRispondi in italiano, diretto e conciso, basandoti ESCLUSIVAMENTE sui dati reali. Se insufficienti dillo.\n\nDATI CARD:\n'+cardContext(card)+'\n\nDOMANDA PROFESSORE:\n'+cardQ.trim();
    callGroqText(orKey,prompt,600)
      .then(function(txt){
        var aiD=aiMap[String(card.id)];
        var esistenti=aiD&&Array.isArray(aiD.domande)?aiD.domande:(aiD&&aiD.domanda?[aiD.domanda]:[]);
        var nuova={id:Date.now(),q:cardQ.trim(),risposta:txt,data:new Date().toISOString()};
        var aggiornate=esistenti.concat([nuova]);
        aiSave(card.id,{domande:aggiornate,domanda:null});
        setCardQ("");
      })
      .catch(function(e){setCardQErr(e.message||"Errore di rete.");})
      .then(function(){setCardQLoad(false);});
  }

  var qrUrl="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data="+encodeURIComponent(window.location.href);
  useEffect(function(){if(user&&user.role==="studente"&&!user.classe)setShowClasseModal(true);},[user]);
  useEffect(function(){if(viewStudenti&&isProf)loadStudenti();},[viewStudenti]);

  if(authLoad)return h("div",{style:{minHeight:"100vh",background:"linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}},
    h("div",{style:{width:48,height:48,border:"3px solid rgba(255,255,255,.2)",borderTop:"3px solid #6366f1",borderRadius:"50%",animation:"spin 1s linear infinite"}}),
    h("div",{style:{color:"rgba(255,255,255,.8)",fontWeight:700,fontSize:16,letterSpacing:2}},"SCUOLABOARD")
  );
  if(!user)return h("div",{style:{minHeight:"100vh",background:"linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)",display:"flex",alignItems:"center",justifyContent:"center",padding:20}},
    h("div",{style:{background:"rgba(255,255,255,.05)",backdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,.1)",borderRadius:24,padding:36,width:"100%",maxWidth:420,textAlign:"center"}},
      h("div",{style:{fontSize:48,marginBottom:12}},"üéì"),
      h("h1",{style:{margin:"0 0 4px",color:"#fff",fontSize:24,fontWeight:800,letterSpacing:1}},"ScuolaBoard"),
      h("p",{style:{margin:"0 0 28px",color:"rgba(255,255,255,.5)",fontSize:13}},"Bacheca digitale interattiva con AI"),
      h("button",{onClick:loginGoogle,style:{padding:14,background:"#fff",border:"1px solid rgba(0,0,0,.1)",borderRadius:14,cursor:"pointer",fontSize:15,fontWeight:700,color:"#333",display:"flex",alignItems:"center",justifyContent:"center",gap:8,width:"100%"}},
        h("img",{src:"https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg",width:20,height:20,alt:"G"}),"Accedi con Google"),
      h("div",{style:{margin:"16px 0",color:"rgba(255,255,255,.3)",fontSize:12}},"üîí Accesso sicuro")
    )
  );

  return h("div",{style:{minHeight:"100vh",background:"linear-gradient(160deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)",display:"flex",flexDirection:"column"}},

    // HEADER
    h("div",{style:{background:"rgba(255,255,255,.04)",backdropFilter:"blur(12px)",borderBottom:"1px solid rgba(255,255,255,.08)",padding:"8px 14px",display:"flex",alignItems:"center",gap:8,position:"sticky",top:0,zIndex:50,flexWrap:"wrap"}},
      h("span",{style:{fontWeight:900,fontSize:16,color:"#fff",letterSpacing:2}},"SCUOLA"),
      h("span",{style:{fontWeight:900,fontSize:16,color:"#6366f1",letterSpacing:2}},"BOARD"),
      h("span",{style:{background:isProf?"rgba(99,102,241,.2)":"rgba(34,197,94,.15)",color:isProf?"#a5b4fc":"#4ade80",borderRadius:20,padding:"2px 9px",fontSize:11,fontWeight:700,display:"flex",alignItems:"center",gap:4}},
        user.photoURL&&h("img",{src:user.photoURL,alt:"",style:{width:16,height:16,borderRadius:"50%"}}),
        isProf?"üë®‚Äçüè´ Prof":"üéí "+user.nome),
      !isProf&&user.classe&&h("span",{style:{background:"rgba(251,146,60,.2)",color:"#fb923c",borderRadius:20,padding:"2px 9px",fontSize:11,fontWeight:700}},user.classe),
      !isProf&&!user.classe&&h("button",{onClick:function(){setShowClasseModal(true);},style:{background:"rgba(239,68,68,.2)",color:"#f87171",border:"1px solid rgba(239,68,68,.3)",borderRadius:20,padding:"2px 9px",fontSize:11,fontWeight:700,cursor:"pointer"}},"‚ö†Ô∏è Scegli classe"),
      !isProf&&user.classe&&h("button",{onClick:function(){setShowClasseModal(true);},style:{background:"rgba(255,255,255,.06)",color:"rgba(255,255,255,.4)",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:"2px 8px",fontSize:10,fontWeight:700,cursor:"pointer"}},"‚úèÔ∏è"),
      simulaSt&&h("span",{style:{background:"rgba(249,115,22,.25)",color:"#fb923c",border:"1px solid rgba(249,115,22,.5)",borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:800}},"üëÅÔ∏è VISTA STUDENTE"),
      h("div",{style:{flex:1}}),
      isProf&&h("button",{onClick:function(){setAskKey(true);},style:{background:orKey?"rgba(34,197,94,.15)":"rgba(249,115,22,.15)",border:"1px solid "+(orKey?"rgba(34,197,94,.3)":"rgba(249,115,22,.3)"),borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:12,color:orKey?"#4ade80":"#fb923c"}},orKey?"üîë":"‚ö†Ô∏è"),
      isProf&&h("button",{onClick:function(){setShowResetOpt(true);},style:{background:"rgba(255,255,255,.06)",border:"1px solid rgba(239,68,68,.3)",borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:14,color:"#f87171"}},"üóëÔ∏è"),
      isProf&&!simulaSt&&h("button",{onClick:function(){setShowExport(true);},style:{background:"rgba(255,255,255,.06)",border:"1px solid rgba(99,102,241,.3)",borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:14,color:"#a5b4fc"},title:"Esporta PDF"},"üìÑ"),
      h("button",{onClick:function(){setSQR(true);},style:{background:"rgba(255,255,255,.06)",border:"1px solid rgba(255,255,255,.1)",borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:14,color:"rgba(255,255,255,.7)"}},"‚óÜ"),
      isProf&&h("button",{onClick:function(){setPreviewSt(function(v){return !v;});},style:{background:simulaSt?"rgba(249,115,22,.3)":"rgba(255,255,255,.07)",border:"1px solid "+(simulaSt?"rgba(249,115,22,.6)":"rgba(255,255,255,.15)"),borderRadius:8,padding:"5px 10px",cursor:"pointer",fontSize:12,fontWeight:700,color:simulaSt?"#fb923c":"rgba(255,255,255,.6)"}},simulaSt?"üîô Prof":"üëÅÔ∏è Studente"),
      isProf&&!simulaSt&&h("div",{style:{display:"flex",gap:2,background:"rgba(255,255,255,.05)",borderRadius:9,padding:3,border:"1px solid rgba(255,255,255,.08)"}},
        [{k:"bacheca",i:"üìå"},{k:"analisi",i:"ü§ñ"},{k:"studenti",i:"üë•"}].map(function(t){
          return h("button",{key:t.k,onClick:function(){setView(t.k);setViewStudenti(t.k==="studenti");},style:{padding:"4px 11px",borderRadius:7,border:"none",background:view===t.k?"rgba(99,102,241,.4)":"transparent",color:view===t.k?"#fff":"rgba(255,255,255,.4)",fontWeight:700,cursor:"pointer",fontSize:13}},t.i);
        })
      ),
      !simulaSt&&h("button",{onClick:function(){setEditMode(null);setForm(Object.assign({},FORM0));setSM(true);},style:{background:"linear-gradient(135deg,#6366f1,#8b5cf6)",border:"none",borderRadius:20,width:34,height:34,cursor:"pointer",color:"#fff",fontSize:20,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800}},"+"),
      h("button",{onClick:logout,style:{background:"none",border:"1px solid rgba(255,255,255,.1)",borderRadius:7,padding:"4px 9px",cursor:"pointer",fontSize:11,color:"rgba(255,255,255,.3)"}},"Esci")
    ),

    // BACHECA
    (view==="bacheca"||simulaSt)&&h(Fragment,null,
      h("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:8,padding:"7px 14px",background:"rgba(255,255,255,.03)",borderBottom:"1px solid rgba(255,255,255,.06)",flexWrap:"wrap"}},
        h("span",{className:"pulse",style:{width:7,height:7,background:"#22c55e",borderRadius:"50%",display:"inline-block"}}),
        h("span",{style:{fontSize:11,fontWeight:800,letterSpacing:3,color:"rgba(255,255,255,.5)"}},"LIVE"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.3)"}},"‚Ä¢"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.4)"}},cards.filter(function(c){return !c.proposta;}).length+" card"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.3)"}},"‚Ä¢"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.4)"}},totC+" commenti"),
        isProf&&!simulaSt&&proposte.length>0&&h("span",{style:{background:"rgba(239,68,68,.2)",color:"#f87171",borderRadius:20,padding:"2px 8px",fontSize:11,fontWeight:800,border:"1px solid rgba(239,68,68,.3)"}},"‚è≥ "+proposte.length+" in attesa")
      ),
      isProf&&!simulaSt&&view==="bacheca"&&h("div",{style:{display:"flex",gap:6,padding:"8px 14px",background:"rgba(255,255,255,.02)",borderBottom:"1px solid rgba(255,255,255,.06)",flexWrap:"wrap",alignItems:"center"}},
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.35)",fontWeight:700,letterSpacing:1}},"CLASSE:"),
        h("button",{onClick:function(){setFilterClasse("tutte");},style:S.filterBtn(filterClasse==="tutte")},"üè´ TUTTE"),
        CLASSI_DEFAULT.map(function(cl){return h("button",{key:cl,onClick:function(){setFilterClasse(cl);},style:S.filterBtn(filterClasse===cl)},cl);}),
        h("button",{onClick:function(){setFilterClasse("_solo");},style:S.filterBtn(filterClasse==="_solo")},"Solo prof"),
        CLASSI_LIST.filter(function(cl){return CLASSI_DEFAULT.indexOf(cl)<0;}).map(function(cl){
          var sel=filterClasse===cl;
          var cc=classeColor(cl,classiCustom);
          return h("span",{key:"custom-"+cl,style:{display:"flex",alignItems:"center",gap:0,borderRadius:20,overflow:"hidden",border:"1px solid "+(sel?cc:"rgba(255,255,255,.15)"),background:sel?cc+"33":"rgba(255,255,255,.04)"}},
            h("button",{onClick:function(){setFilterClasse(cl);},style:{padding:"3px 2px 3px 9px",background:"none",border:"none",fontSize:12,fontWeight:700,cursor:"pointer",display:"flex",alignItems:"center",gap:5},title:"Clicca per filtrare ‚Äî doppio clic per rinominare",onDoubleClick:function(e){e.stopPropagation();apriRinomina(cl);}},
              h("span",{style:{width:8,height:8,borderRadius:"50%",background:cc,display:"inline-block",flexShrink:0}}),
              h("span",{style:{color:sel?"#fff":"rgba(255,255,255,.7)"}},cl)
            ),
            h("button",{onClick:function(e){e.stopPropagation();apriRinomina(cl);},title:"Rinomina",style:{padding:"3px 5px",background:"none",border:"none",color:"rgba(255,255,255,.3)",fontSize:10,cursor:"pointer",lineHeight:1}},"‚úèÔ∏è"),
            h("button",{onClick:function(e){e.stopPropagation();removeClasseCustom(cl);if(filterClasse===cl)setFilterClasse("tutte");},title:"Rimuovi classe",style:{padding:"3px 7px 3px 2px",background:"none",border:"none",color:"rgba(255,255,255,.3)",fontSize:10,cursor:"pointer",lineHeight:1}},"√ó")
          );
        }),
        addingClasse
          ?h("div",{style:{display:"flex",gap:4,alignItems:"center"}},
              h("input",{value:newClasseInput,onInput:function(e){setNewClasseInput(e.target.value.toUpperCase());},onKeyDown:function(e){if(e.key==="Enter")addClasseCustom();if(e.key==="Escape"){setAddingClasse(false);setNewClasseInput("");}},placeholder:"es. 1AX",autoFocus:true,maxLength:20,style:{width:120,padding:"3px 8px",border:"1px solid #6366f1",borderRadius:8,fontSize:12,background:"rgba(255,255,255,.1)",color:"#f1f5f9"}}),
              h("button",{onClick:addClasseCustom,style:{background:"#6366f1",color:"#fff",border:"none",borderRadius:8,padding:"3px 9px",cursor:"pointer",fontSize:12,fontWeight:700}},"‚úì"),
              h("button",{onClick:function(){setAddingClasse(false);setNewClasseInput("");},style:{background:"rgba(255,255,255,.07)",color:"rgba(255,255,255,.4)",border:"none",borderRadius:8,padding:"3px 9px",cursor:"pointer",fontSize:12}},"‚úï")
            )
          :h("button",{onClick:function(){setAddingClasse(true);},style:{display:"flex",alignItems:"center",gap:4,padding:"3px 10px",borderRadius:20,border:"1px dashed rgba(99,102,241,.5)",background:"rgba(99,102,241,.08)",color:"#a5b4fc",fontSize:12,fontWeight:700,cursor:"pointer"}},"+")
      ),
      isProf&&!simulaSt&&proposte.length>0&&h("div",{style:{padding:"10px 14px",background:"rgba(249,115,22,.06)",borderBottom:"1px solid rgba(249,115,22,.15)"}},
        h("div",{style:{fontWeight:700,color:"#fb923c",fontSize:11,marginBottom:7,letterSpacing:1}},"‚è≥ PROPOSTE IN ATTESA"),
        proposte.map(function(c){return h("div",{key:c.id,style:{background:"rgba(255,255,255,.04)",border:"1px solid rgba(249,115,22,.2)",borderRadius:9,padding:"8px 12px",marginBottom:5,display:"flex",alignItems:"center",gap:8}},
          h("span",{style:{flex:1,fontSize:13,color:"rgba(255,255,255,.8)",fontWeight:600}},h("span",{style:{fontSize:10,color:"#fb923c",fontWeight:800,marginRight:6,background:"rgba(249,115,22,.15)",padding:"1px 6px",borderRadius:10}},c.autore||"Studente"),c.titolo),
          h("button",{onClick:function(){appCard(c.id);},style:{background:"rgba(34,197,94,.2)",color:"#4ade80",border:"1px solid rgba(34,197,94,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:12,fontWeight:700}},"‚úì"),
          h("button",{onClick:function(){delCard(c.id);},style:{background:"rgba(239,68,68,.15)",color:"#f87171",border:"none",borderRadius:7,padding:"3px 8px",cursor:"pointer",fontSize:12}},"‚úï")
        );})
      ),
      !isProf&&!simulaSt&&preferiti.length>0&&(function(){
        var prefCards=visible.filter(function(c){return preferiti.indexOf(String(c.id))>=0;});
        if(!prefCards.length)return null;
        return h("div",{style:{padding:"8px 14px",background:"rgba(245,158,11,.04)",borderBottom:"1px solid rgba(245,158,11,.12)"}},
          h("div",{style:{fontSize:11,fontWeight:700,color:"#fbbf24",marginBottom:7,letterSpacing:1}},"‚òÖ I TUOI PREFERITI"),
          h("div",{style:{display:"flex",gap:8,flexWrap:"wrap"}},
            prefCards.map(function(c){return h("button",{key:c.id,onClick:function(){setSC(c);markSeen(c.id);setNc({testo:""});setEditingCm(null);setCardQErr("");setCardQ("");},style:{background:"rgba(245,158,11,.12)",border:"1px solid rgba(245,158,11,.25)",borderRadius:8,padding:"4px 12px",cursor:"pointer",fontSize:12,color:"#fbbf24",fontWeight:700,maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},c.titolo);})
          )
        );
      })(),
      h("div",{style:{flex:1,padding:"18px 14px"}},
        visible.length===0
          ?h("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"80px 20px",color:"rgba(255,255,255,.2)"}},h("div",{style:{fontSize:48,marginBottom:8}},"üìå"),h("div",{style:{fontWeight:600}},"Nessun contenuto visibile"))
          :h("div",{style:{columns:"300px",columnGap:16}},
            visible.map(function(c){
              var totV=c.opzioni?c.opzioni.reduce(function(a,o){return a+o.voti.length;},0):0;
              var liked=myLikes.current.has(String(c.id));
              var aiD=aiMap[String(c.id)];
              var cRes=aiD&&aiD.analisi;
              var cOpen=cardAiOpen===c.id,cLoad=cardAiLoad===c.id;
              var isOwner=!isProf&&user&&c.autore===myName(user)&&!c.proposta;
              var cardLinks=normalizeLinks(c);
              var nascosta=c.visibile===false,nuova=!seenRef.current.has(String(c.id));
              var cc=c.classi||["TUTTE"];
              return h("div",{
                id:"card-"+c.id,key:c.id,className:"card-wrap fadein",
                draggable:isProf&&!simulaSt,
                onDragStart:isProf&&!simulaSt?function(e){onDragStart(e,c.id);}:undefined,
                onDragEnd:isProf&&!simulaSt?function(e){onDragEnd(e,c.id);}:undefined,
                onDragOver:isProf&&!simulaSt?function(e){onDragOver(e,c.id);}:undefined,
                onDragLeave:isProf&&!simulaSt?function(e){onDragLeave(e,c.id);}:undefined,
                onDrop:isProf&&!simulaSt?function(e){onDrop(e,c.id);}:undefined,
                style:{breakInside:"avoid",marginBottom:16,background:nascosta?"rgba(255,255,255,.03)":"rgba(255,255,255,.06)",backdropFilter:"blur(10px)",border:"1px solid "+(nascosta?"rgba(255,255,255,.06)":"rgba(255,255,255,.1)"),borderRadius:16,overflow:"hidden",opacity:nascosta?.5:1}
              },
                h("div",{style:{cursor:"pointer"},onClick:function(){setSC(c);markSeen(c.id);setNc({testo:""});setEditingCm(null);setCardQErr("");setCardQ("");}},
                  h("div",{style:{padding:"12px 14px 6px"}},
                    h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6,gap:4}},
                      h("div",{style:{display:"flex",gap:4,alignItems:"center",flexWrap:"wrap"}},
                        h("span",{style:{background:badgeBg(c.tipo),color:"#fff",borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:800}},tipoIcon(c.tipo)+" "+c.tipo.toUpperCase()),
                        isProf&&cc.indexOf("TUTTE")<0&&cc.length>0&&h("span",{style:{display:"inline-flex",alignItems:"center",gap:3,background:"rgba(255,255,255,.07)",borderRadius:6,padding:"2px 7px",fontSize:10,fontWeight:700,color:"rgba(255,255,255,.7)"}},
                          cc.slice(0,3).map(function(cl,i){var isCustom=CLASSI_DEFAULT.indexOf(cl)<0;var ccc=isCustom?classeColor(cl,classiCustom):"#fb923c";return h("span",{key:i,style:{display:"inline-flex",alignItems:"center",gap:3}},h("span",{style:{width:6,height:6,borderRadius:"50%",background:ccc,display:"inline-block"}}),cl,(i<Math.min(cc.length,3)-1?", ":""));}),
                          cc.length>3&&"‚Ä¶"
                        ),
                        isProf&&cc.length===0&&h("span",{style:{background:"rgba(239,68,68,.2)",color:"#f87171",borderRadius:6,padding:"2px 7px",fontSize:10,fontWeight:700}},"Solo prof"),
                        nuova&&h("span",{style:{background:"rgba(34,197,94,.25)",color:"#4ade80",borderRadius:6,padding:"2px 6px",fontSize:9,fontWeight:800,border:"1px solid rgba(34,197,94,.4)"}},"NUOVO"),
                        nascosta&&isProf&&h("span",{style:{background:"rgba(239,68,68,.2)",color:"#f87171",borderRadius:6,padding:"2px 6px",fontSize:9,fontWeight:800}},"NASCOSTA")
                      ),
                      isProf&&!simulaSt&&h("span",{title:nascosta?"Rendi visibile":"Nascondi",style:{cursor:"pointer",fontSize:16},onClick:function(e){toggleVisibile(c,e);}},nascosta?"üö´":"üëÅÔ∏è")
                    ),
                    isProf&&!simulaSt&&h("div",{style:{fontSize:11,color:"rgba(255,255,255,.2)",marginBottom:4,cursor:"grab",userSelect:"none"}},"‚ò∞ trascina per riordinare"),
                    h("div",{style:{fontWeight:800,fontSize:13,color:nascosta?"rgba(255,255,255,.4)":"#f1f5f9",lineHeight:1.4,marginBottom:5}},c.titolo),
                    c.testo&&h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",lineHeight:1.5,overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"}},c.testo),
                    cardLinks.length>0&&h("div",{style:{marginTop:5,fontSize:10,color:"#60a5fa"}},"üîó "+cardLinks.length+" link"),
                    c.tipo==="sondaggio"&&c.opzioni&&h("div",{style:{marginTop:8}},
                      c.opzioni.map(function(o){var pct=totV>0?Math.round(o.voti.length/totV*100):0;return h("div",{key:o.id,style:{marginBottom:4}},
                        h("div",{style:{display:"flex",justifyContent:"space-between",fontSize:10,color:"rgba(255,255,255,.4)",marginBottom:2}},h("span",null,o.testo),h("span",null,pct+"%")),
                        h("div",{style:{height:3,background:"rgba(255,255,255,.1)",borderRadius:3}},h("div",{style:{height:3,background:"#6366f1",borderRadius:3,width:pct+"%"}})));
                      }).concat([h("div",{key:"voti",style:{fontSize:9,color:"rgba(255,255,255,.3)",marginTop:3}},totV+" voti")])
                    )
                  )
                ),
                h("div",{style:{padding:"6px 14px 10px",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}},
                  h("button",{onClick:function(e){e.stopPropagation();toggleLike(c.id);},style:{background:liked?"rgba(99,102,241,.3)":"rgba(255,255,255,.08)",border:"1px solid "+(liked?"rgba(99,102,241,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"3px 8px",cursor:"pointer",fontSize:12,color:liked?"#a5b4fc":"rgba(255,255,255,.5)",display:"flex",alignItems:"center",gap:4}},"üëç",h("span",{style:{fontSize:11,fontWeight:700}},c.likes||0)),
                  h("button",{onClick:function(e){e.stopPropagation();setSC(c);markSeen(c.id);setNc({testo:""});setEditingCm(null);setCardQErr("");setCardQ("");setTimeout(function(){var ta=document.getElementById("cm-textarea");if(ta){ta.scrollIntoView({behavior:"smooth",block:"center"});ta.focus();}},150);},style:{background:"rgba(99,102,241,.15)",border:"1px solid rgba(99,102,241,.3)",borderRadius:20,padding:"3px 10px",cursor:"pointer",fontSize:12,color:"#a5b4fc",display:"flex",alignItems:"center",gap:4,fontWeight:700}},"üí¨ Commenta",h("span",{style:{fontSize:11,background:"rgba(99,102,241,.3)",borderRadius:10,padding:"0 5px",marginLeft:2}},(c.commenti||[]).length||"0")),
                  !isProf&&!simulaSt&&h("button",{onClick:function(e){e.stopPropagation();togglePreferito(c.id);},style:{background:preferiti.indexOf(String(c.id))>=0?"rgba(245,158,11,.3)":"rgba(255,255,255,.06)",border:"1px solid "+(preferiti.indexOf(String(c.id))>=0?"rgba(245,158,11,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"3px 9px",cursor:"pointer",fontSize:13,color:preferiti.indexOf(String(c.id))>=0?"#fbbf24":"rgba(255,255,255,.3)"}},preferiti.indexOf(String(c.id))>=0?"‚òÖ":"‚òÜ"),
                  h("span",{style:{flex:1}}),
                  h("span",{style:{fontSize:10,color:"rgba(255,255,255,.3)"}},fmt(c.data)),
                  isProf&&!simulaSt&&h("button",{onClick:function(e){e.stopPropagation();editCard(c);},style:{background:"rgba(59,130,246,.2)",border:"1px solid rgba(59,130,246,.4)",borderRadius:20,padding:"3px 9px",cursor:"pointer",fontSize:11,color:"#60a5fa",fontWeight:700}},"‚úèÔ∏è"),
                  isOwner&&h("button",{onClick:function(e){e.stopPropagation();editCard(c);},style:{background:"rgba(59,130,246,.2)",border:"1px solid rgba(59,130,246,.4)",borderRadius:20,padding:"3px 9px",cursor:"pointer",fontSize:11,color:"#60a5fa",fontWeight:700}},"‚úèÔ∏è"),
                  isProf&&!simulaSt&&h("button",{onClick:function(e){apriDuplica(c,e);},style:{background:"rgba(245,158,11,.15)",border:"1px solid rgba(245,158,11,.3)",borderRadius:20,padding:"3px 9px",cursor:"pointer",fontSize:11,color:"#fbbf24",fontWeight:700}},"üìã"),
                  isProf&&!simulaSt&&h("button",{onClick:function(e){runCardAI(c,e);},style:{background:cOpen?"rgba(99,102,241,.4)":"rgba(99,102,241,.18)",border:"1px solid rgba(99,102,241,.4)",borderRadius:20,padding:"3px 11px",cursor:"pointer",fontSize:11,color:"#a5b4fc",fontWeight:700,display:"flex",alignItems:"center",gap:4}},
                    cLoad?h("span",{style:{display:"inline-block",animation:"spin 1s linear infinite"}},"‚öôÔ∏è"):"ü§ñ",h("span",null,cLoad?"‚Ä¶":(cRes?"‚Üª AI":"AI")))
                ),
                isProf&&!simulaSt&&cOpen&&h("div",{style:{borderTop:"1px solid rgba(99,102,241,.25)",background:"rgba(30,30,60,.7)",padding:"10px 14px"}},
                  cLoad&&h("div",{style:{textAlign:"center",padding:"8px 0",color:"rgba(255,255,255,.4)",fontSize:12}},"‚öôÔ∏è Analisi in corso‚Ä¶"),
                  !cLoad&&cRes&&h(Fragment,null,
                    cRes.data&&h("div",{style:{fontSize:9,color:"rgba(255,255,255,.25)",marginBottom:8}},"Salvata il "+fmtDT(cRes.data)),
                    cRes.sintesi&&h("div",{style:{marginBottom:8}},h("div",{style:{fontSize:9,fontWeight:800,color:"#a5b4fc",letterSpacing:1,marginBottom:3}},"üìã SINTESI"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.8)",lineHeight:1.6,whiteSpace:"pre-wrap"}},cRes.sintesi)),
                    cRes.dinamica&&h("div",{style:{marginBottom:8}},h("div",{style:{fontSize:9,fontWeight:800,color:"#93c5fd",letterSpacing:1,marginBottom:3}},"üí¨ DINAMICA"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.75)",lineHeight:1.6}},cRes.dinamica)),
                    cRes.spunto&&h("div",{style:{background:"rgba(34,197,94,.08)",borderRadius:7,padding:"7px 10px",border:"1px solid rgba(34,197,94,.15)"}},h("div",{style:{fontSize:9,fontWeight:800,color:"#4ade80",letterSpacing:1,marginBottom:3}},"üí° SPUNTO"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.8)",lineHeight:1.6,fontStyle:"italic"}},cRes.spunto))
                  ),
                  !cLoad&&!cRes&&h("div",{style:{color:"rgba(255,255,255,.3)",fontSize:11,textAlign:"center"}},"Premi ü§ñ AI per avviare"),
                  h("button",{onClick:function(e){e.stopPropagation();setCardAiOpen(null);},style:{marginTop:8,background:"none",border:"none",color:"rgba(255,255,255,.3)",fontSize:10,cursor:"pointer"}},"‚úï chiudi")
                )
              );
            })
          )
      )
    ),

    // ANALISI
    view==="analisi"&&isProf&&!simulaSt&&h("div",{style:{flex:1,padding:"18px 14px",maxWidth:820,margin:"0 auto",width:"100%"}},
      h("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginBottom:16}},
        [{l:"Card",v:cards.length,i:"üìå",c:"#6366f1"},{l:"Domande",v:cards.filter(function(c){return c.tipo==="domanda";}).length,i:"üí¨",c:"#8b5cf6"},
         {l:"Note",v:cards.filter(function(c){return c.tipo==="nota";}).length,i:"üìÑ",c:"#f59e0b"},{l:"Sondaggi",v:cards.filter(function(c){return c.tipo==="sondaggio";}).length,i:"üó≥Ô∏è",c:"#22c55e"},
         {l:"Commenti",v:totC,i:"‚úçÔ∏è",c:"#ef4444"}].map(function(s){return h("div",{key:s.l,style:{flex:1,minWidth:90,background:"rgba(255,255,255,.05)",borderRadius:11,padding:"10px 12px",border:"1px solid rgba(255,255,255,.08)",borderTop:"3px solid "+s.c}},h("div",{style:{fontSize:18}},s.i),h("div",{style:{fontSize:22,fontWeight:800,color:"#f1f5f9"}},s.v),h("div",{style:{fontSize:10,color:"rgba(255,255,255,.4)"}},s.l));})
      ),
      h("div",{style:{background:"rgba(255,255,255,.05)",borderRadius:11,padding:16,border:"1px solid rgba(255,255,255,.08)"}},
        h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:8}},
          h("div",{style:{fontWeight:700,color:"#f1f5f9",fontSize:14}},"ü§ñ Analisi AI globale"),
          h("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},
            h("select",{value:aiTarget,onChange:function(e){setAIT(e.target.value);setAiR(null);setAiErr("");},style:{padding:"5px 10px",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,fontSize:12,color:"#f1f5f9",background:"rgba(30,41,59,1)",maxWidth:220}},
              h("option",{value:"tutte"},"üìã Tutte le card"),
              cards.filter(function(c){return !c.proposta;}).map(function(c){return h("option",{key:c.id,value:String(c.id)},tipoIcon(c.tipo)+" "+c.titolo.slice(0,35)+(c.titolo.length>35?"‚Ä¶":""));})
            ),
            h("button",{onClick:runAI,disabled:aiRunning,style:{background:aiRunning?"rgba(255,255,255,.1)":"linear-gradient(135deg,#6366f1,#8b5cf6)",color:aiRunning?"rgba(255,255,255,.3)":"#fff",border:"none",borderRadius:8,padding:"6px 16px",cursor:aiRunning?"not-allowed":"pointer",fontSize:12,fontWeight:700}},aiRunning?"‚è≥ Analisi‚Ä¶":"‚ñ∂ Avvia")
          )
        ),
        !aiResult&&!aiRunning&&!aiErr&&h("div",{style:{textAlign:"center",padding:28,color:"rgba(255,255,255,.2)"}},h("div",{style:{fontSize:36}},"üìä"),h("div",{style:{fontWeight:600,fontSize:14,marginTop:8}},"Seleziona e premi Avvia")),
        aiRunning&&h("div",{style:{textAlign:"center",padding:28}},h("div",{style:{fontSize:32,animation:"spin 2s linear infinite",display:"inline-block"}},"‚öôÔ∏è"),h("div",{style:{marginTop:8,fontWeight:600,color:"rgba(255,255,255,.6)"}},"Analisi in corso‚Ä¶")),
        aiErr&&h("div",{style:{color:"#f87171",padding:12,background:"rgba(239,68,68,.1)",borderRadius:9,fontSize:13,marginBottom:8}},aiErr),
        aiResult&&!aiErr&&h(Fragment,null,
          h("div",{style:{background:"rgba(99,102,241,.15)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(99,102,241,.2)"}},h("div",{style:{fontWeight:700,color:"#a5b4fc",marginBottom:8,fontSize:11,letterSpacing:1}},"üìã RIEPILOGO"),h("div",{style:{color:"rgba(255,255,255,.85)",fontSize:13,lineHeight:1.8,whiteSpace:"pre-wrap"}},aiResult.riepilogo||"‚Äî")),
          aiResult.dibattito&&h("div",{style:{background:"rgba(59,130,246,.12)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(59,130,246,.2)"}},h("div",{style:{fontWeight:700,color:"#93c5fd",marginBottom:8,fontSize:11,letterSpacing:1}},"üí¨ DINAMICA"),h("div",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.8,whiteSpace:"pre-wrap"}},aiResult.dibattito)),
          aiResult.punti_chiave&&aiResult.punti_chiave.length>0&&h("div",{style:{background:"rgba(245,158,11,.08)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(245,158,11,.2)"}},
            h("div",{style:{fontWeight:700,color:"#fbbf24",marginBottom:10,fontSize:11,letterSpacing:1}},"üîë PUNTI CHIAVE"),
            aiResult.punti_chiave.map(function(s,i){return h("div",{key:i,style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"}},h("span",{style:{background:"#f59e0b",color:"#1a1a2e",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:800,flexShrink:0,marginTop:2}},i+1),h("span",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.6}},s));})),
          aiResult.spunti_dibattito&&aiResult.spunti_dibattito.length>0&&h("div",{style:{background:"rgba(34,197,94,.08)",borderRadius:10,padding:14,border:"1px solid rgba(34,197,94,.15)"}},
            h("div",{style:{fontWeight:700,color:"#4ade80",marginBottom:10,fontSize:11,letterSpacing:1}},"üí° SPUNTI"),
            aiResult.spunti_dibattito.map(function(s,i){return h("div",{key:i,style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"}},h("span",{style:{background:"#22c55e",color:"#fff",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:800,flexShrink:0,marginTop:2}},i+1),h("span",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.6,fontStyle:"italic"}},s));})
          )
        )
      )
    ),

    // STUDENTI
    view==="studenti"&&isProf&&!simulaSt&&h("div",{style:{flex:1,padding:"18px 14px",overflowY:"auto"}},
      h("div",{style:{maxWidth:700,margin:"0 auto"}},
        h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}},
          h("div",{style:{fontWeight:800,color:"#f1f5f9",fontSize:16}},"üë• Gestione Studenti"),
          h("button",{onClick:loadStudenti,style:{background:"rgba(99,102,241,.2)",border:"1px solid rgba(99,102,241,.3)",color:"#a5b4fc",borderRadius:8,padding:"6px 12px",fontSize:12,fontWeight:700,cursor:"pointer"}},"üîÑ Aggiorna")
        ),
        h("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:14}},
          h("button",{onClick:function(){setFilterClasse("tutte");},style:S.filterBtn(filterClasse==="tutte")},"TUTTI"),
          CLASSI_LIST.map(function(cl){return h("button",{key:cl,onClick:function(){setFilterClasse(cl);},style:S.filterBtn(filterClasse===cl)},cl);})
        ),
        studenti.length===0&&h("div",{style:{textAlign:"center",color:"rgba(255,255,255,.3)",padding:40}},"Nessuno studente. Clicca Aggiorna."),
        studenti.filter(function(s){return filterClasse==="tutte"||(s.classe===filterClasse);}).map(function(s){
          return h("div",{key:s.uid,style:{background:"rgba(255,255,255,.04)",border:"1px solid rgba(255,255,255,.08)",borderRadius:12,padding:"10px 14px",marginBottom:8,display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}},
            h("div",{style:{flex:1,minWidth:140}},h("div",{style:{fontWeight:700,color:"#f1f5f9",fontSize:13}},(s.nome||"")+" "+(s.cognome||"")),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.35)"}},s.email),s.classe&&h("span",{style:{background:"rgba(251,146,60,.2)",color:"#fb923c",borderRadius:6,padding:"1px 7px",fontSize:10,fontWeight:700}},s.classe)),
            h("select",{value:s.classe||"",onChange:function(e){aggiornaClasseStudente(s.uid,e.target.value);},style:{background:"#1e293b",color:"#f1f5f9",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,padding:"4px 8px",fontSize:12,cursor:"pointer"}},
              h("option",{value:""},"-- nessuna --"),CLASSI_LIST.map(function(cl){return h("option",{key:cl,value:cl},(CLASSI_DEFAULT.indexOf(cl)<0?"‚òÖ ":"")+cl);})),
            h("button",{onClick:function(){rimuoviStudente(s.uid);},style:{background:"rgba(239,68,68,.1)",border:"1px solid rgba(239,68,68,.2)",color:"#f87171",borderRadius:8,padding:"4px 8px",fontSize:11,cursor:"pointer",fontWeight:700}},"Rimuovi")
          );
        })
      )
    ),

    // MODAL DUPLICA
    showDuplica&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setShowDuplica(null);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:26,maxWidth:420,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:36,marginBottom:6,textAlign:"center"}},"üìã"),
        h("h3",{style:{margin:"0 0 4px",color:"#f1f5f9",fontSize:16,fontWeight:800,textAlign:"center"}},"Duplica card"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:12,marginBottom:4,textAlign:"center"}},'"'+showDuplica.titolo+'"'),
        h("p",{style:{color:"rgba(255,255,255,.3)",fontSize:11,marginBottom:14,textAlign:"center"}},"Copia indipendente ‚Äî commenti e voti originali restano intatti."),
        h("div",{style:{display:"flex",flexWrap:"wrap",gap:6,marginBottom:16}},
          CLASSI_LIST.map(function(cl){var sel=duplicaClassi.indexOf(cl)>=0;return h("button",{key:cl,type:"button",onClick:function(){setDuplicaClassi(function(p){return sel?p.filter(function(x){return x!==cl;}):[].concat(p,[cl]);});},style:{padding:"5px 11px",borderRadius:8,border:"1px solid "+(sel?"#6366f1":"rgba(255,255,255,.15)"),background:sel?"#6366f1":"rgba(255,255,255,.05)",color:sel?"#fff":"rgba(255,255,255,.6)",fontSize:12,fontWeight:700,cursor:"pointer"}},cl);})
        ),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setShowDuplica(null);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:confermaDuplica,style:{flex:2,padding:11,background:duplicaClassi.length?"linear-gradient(135deg,#f59e0b,#f97316)":"rgba(255,255,255,.06)",color:duplicaClassi.length?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:duplicaClassi.length?"pointer":"not-allowed"}},duplicaClassi.length?"üìã Duplica in "+duplicaClassi.length+" class"+(duplicaClassi.length===1?"e":"i"):"Seleziona almeno 1 classe")
        )
      )
    ),

    // MODAL SCEGLI CLASSE
    showClasseModal&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.85)",zIndex:400,display:"flex",alignItems:"center",justifyContent:"center",padding:20}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:420,width:"100%"}},
        h("div",{style:{fontSize:40,marginBottom:10,textAlign:"center"}},"üè´"),
        h("h3",{style:{margin:"0 0 6px",color:"#f1f5f9",fontSize:18,fontWeight:800,textAlign:"center"}},"Seleziona la tua classe"),
        h("p",{style:{color:"rgba(255,255,255,.45)",fontSize:12,marginBottom:18,textAlign:"center"}},"Vedrai solo i contenuti a te destinati."),
        h("div",{style:{display:"flex",flexWrap:"wrap",gap:7,marginBottom:18,justifyContent:"center"}},
          CLASSI_LIST.map(function(cl){
            var isCustom=CLASSI_DEFAULT.indexOf(cl)<0;
            var cc=isCustom?classeColor(cl,classiCustom):null;
            var sel=classeInput===cl;
            return h("button",{key:cl,type:"button",onClick:function(){setClasseInput(cl);},style:{padding:"7px 13px",borderRadius:9,border:"1px solid "+(sel?(cc||"#6366f1"):"rgba(255,255,255,.15)"),background:sel?(cc||"#6366f1")+"33":"rgba(255,255,255,.05)",color:sel?"#fff":"rgba(255,255,255,.6)",fontSize:13,fontWeight:700,cursor:"pointer",display:"inline-flex",alignItems:"center",gap:5}},
              isCustom&&h("span",{style:{width:8,height:8,borderRadius:"50%",background:cc,display:"inline-block",flexShrink:0}}),
              cl
            );
          })
        ),
        h("div",{style:{display:"flex",gap:10}},
          user&&user.classe&&h("button",{onClick:function(){setShowClasseModal(false);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:saveClasse,style:{flex:2,padding:11,background:classeInput?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:classeInput?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:classeInput?"pointer":"not-allowed"}},classeInput?"Conferma: "+classeInput:"Seleziona una classe")
        )
      )
    ),

    // RINOMINA CLASSE
    rinominaClasse&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",zIndex:400,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setRinominaClasse(null);setRinominaConferma(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:380,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:36,marginBottom:10,textAlign:"center"}},"‚úèÔ∏è"),
        h("h3",{style:{margin:"0 0 6px",color:"#f1f5f9",fontSize:17,fontWeight:800,textAlign:"center"}},"Rinomina classe"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:12,marginBottom:16,textAlign:"center"}},"Il nome verr√† aggiornato in tutte le card e gli studenti assegnati."),
        !rinominaConferma&&h("input",{value:rinominaInput,onInput:function(e){setRinominaInput(e.target.value.toUpperCase());},onKeyDown:function(e){if(e.key==="Enter")eseguiRinomina();if(e.key==="Escape"){setRinominaClasse(null);setRinominaConferma(false);}},maxLength:20,autoFocus:true,style:Object.assign({},S.input,{marginBottom:14,fontSize:16,textAlign:"center",fontWeight:700})}),
        rinominaConferma&&h("div",{style:{background:"rgba(239,68,68,.12)",border:"1px solid rgba(239,68,68,.3)",borderRadius:10,padding:"12px 16px",marginBottom:14,textAlign:"center"}},
          h("div",{style:{color:"#f87171",fontWeight:700,fontSize:13,marginBottom:4}},"‚ö†Ô∏è Conferma rinomina"),
          h("div",{style:{color:"rgba(255,255,255,.5)",fontSize:12}},'"'+rinominaClasse+'" ‚Üí "'+rinominaInput+'"'),
          h("div",{style:{color:"rgba(255,255,255,.35)",fontSize:11,marginTop:4}},"Verranno aggiornate "+cards.filter(function(c){return(c.classi||[]).indexOf(rinominaClasse)>=0;}).length+" card")
        ),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setRinominaClasse(null);setRinominaConferma(false);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:eseguiRinomina,style:{flex:2,padding:11,background:rinominaInput.trim()&&rinominaInput.trim()!==rinominaClasse?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:rinominaInput.trim()&&rinominaInput.trim()!==rinominaClasse?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:rinominaInput.trim()&&rinominaInput.trim()!==rinominaClasse?"pointer":"not-allowed"}},rinominaConferma?"‚úì Confermato ‚Äî Rinomina":"Rinomina")
        )
      )
    ),

    // QR
    showQR&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setSQR(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:26,maxWidth:300,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontWeight:800,color:"#f1f5f9",fontSize:17,marginBottom:4}},"QR Code Bacheca"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:12,marginBottom:14}},"Mostra agli studenti"),
        h("div",{style:{background:"#fff",borderRadius:12,padding:10,display:"inline-block",marginBottom:14}},h("img",{src:qrUrl,alt:"QR",width:200,height:200})),
        h("button",{onClick:function(){setSQR(false);},style:{background:"linear-gradient(135deg,#6366f1,#8b5cf6)",color:"#fff",border:"none",borderRadius:10,padding:"9px 24px",cursor:"pointer",fontSize:13,fontWeight:700,width:"100%"}},"Chiudi")
      )
    ),

    // RESET OPZIONI
    showResetOpt&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setShowResetOpt(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:360,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:44,marginBottom:10,textAlign:"center"}},"üóëÔ∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800,textAlign:"center"}},"Opzioni Reset"),
        h("div",{style:{display:"flex",flexDirection:"column",gap:10,marginBottom:16}},
          h("button",{onClick:resetComments,style:{padding:14,background:"rgba(239,68,68,.15)",color:"#f87171",border:"1px solid rgba(239,68,68,.3)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},h("span",{style:{fontSize:20}},"üí¨"),h("div",{style:{flex:1}},h("div",{style:{fontWeight:800}},"Reset commenti"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Rimuove tutti i commenti"))),
          h("button",{onClick:resetVotes,style:{padding:14,background:"rgba(245,158,11,.15)",color:"#fbbf24",border:"1px solid rgba(245,158,11,.3)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},h("span",{style:{fontSize:20}},"üó≥Ô∏è"),h("div",{style:{flex:1}},h("div",{style:{fontWeight:800}},"Reset voti"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Azzera i voti dei sondaggi"))),
          h("button",{onClick:function(){setShowResetOpt(false);setSR(true);},style:{padding:14,background:"rgba(239,68,68,.2)",color:"#f87171",border:"1px solid rgba(239,68,68,.4)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},h("span",{style:{fontSize:20}},"üî•"),h("div",{style:{flex:1}},h("div",{style:{fontWeight:800}},"Reset completo"),h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Elimina tutte le card")))
        ),
        h("button",{onClick:function(){setShowResetOpt(false);},style:{width:"100%",padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla")
      )
    ),

    showReset&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setSR(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:320,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:44,marginBottom:10}},"üóëÔ∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},"Reset bacheca"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:13,marginBottom:24}},"Elimina tutte le card. Azione irreversibile."),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setSR(false);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:resetAll,style:{flex:1,padding:11,background:"#ef4444",color:"#fff",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:"pointer"}},"S√¨, resetta")
        )
      )
    ),

    confirmDel&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:350,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setConfirmDel(null);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:340,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:48,marginBottom:10}},confirmDel.type==="resetCard"?"üîÑ":"‚ö†Ô∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},confirmDel.type==="resetCard"?"Reset card":"Conferma eliminazione"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:13,marginBottom:24,lineHeight:1.5}},confirmDel.type==="card"?"Eliminare questa card?":confirmDel.type==="comment"?"Eliminare questo commento?":confirmDel.type==="resetCard"?"Azzerare commenti e voti di questa card?":"Eliminare questa risposta?"),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setConfirmDel(null);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:function(){
            if(confirmDel.type==="card"){fbDel(confirmDel.id);setSC(null);}
            else if(confirmDel.type==="comment")executeDelCom(confirmDel.cardId,confirmDel.id);
            else if(confirmDel.type==="reply")executeDelReply(confirmDel.cmId,confirmDel.id,confirmDel.cardId);
            else if(confirmDel.type==="resetCard")resetSondaggio(confirmDel.cardId);
            setConfirmDel(null);
          },style:{flex:1,padding:11,background:confirmDel.type==="resetCard"?"#f97316":"#ef4444",color:"#fff",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:"pointer"}},confirmDel.type==="resetCard"?"üîÑ Resetta":"Elimina")
        )
      )
    ),

    // EXPORT PDF
    showExport&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.8)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setShowExport(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:420,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:36,marginBottom:8,textAlign:"center"}},"üìÑ"),
        h("h3",{style:{margin:"0 0 4px",color:"#f1f5f9",fontSize:17,fontWeight:800,textAlign:"center"}},"Esporta PDF"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:12,marginBottom:18,textAlign:"center"}},"Scegli cosa includere, poi stampa come PDF"),
        h("div",{style:{marginBottom:14}},
          h("label",{style:{fontSize:11,fontWeight:700,color:"rgba(255,255,255,.4)",letterSpacing:1,display:"block",marginBottom:8}},"üè´ CLASSE"),
          h("div",{style:{display:"flex",flexWrap:"wrap",gap:5}},
            h("button",{type:"button",onClick:function(){setExportFiltro("tutte");},style:Object.assign({},S.filterBtn(exportFiltro==="tutte"),{fontSize:11,padding:"3px 9px"})},"Tutte"),
            CLASSI_LIST.map(function(cl){return h("button",{type:"button",key:cl,onClick:function(){setExportFiltro(cl);},style:Object.assign({},S.filterBtn(exportFiltro===cl),{fontSize:11,padding:"3px 9px"})},cl);})
          )
        ),
        h("div",{style:{marginBottom:14}},
          h("label",{style:{fontSize:11,fontWeight:700,color:"rgba(255,255,255,.4)",letterSpacing:1,display:"block",marginBottom:8}},"üìå TIPO CARD"),
          h("div",{style:{display:"flex",gap:5,flexWrap:"wrap"}},
            [{v:"tutti",l:"Tutti"},{v:"domanda",l:"üí¨ Domande"},{v:"nota",l:"üìÑ Note"},{v:"sondaggio",l:"üó≥Ô∏è Sondaggi"}].map(function(t){return h("button",{type:"button",key:t.v,onClick:function(){setExportTipo(t.v);},style:Object.assign({},S.filterBtn(exportTipo===t.v),{fontSize:11,padding:"3px 9px"})},t.l);})
          )
        ),
        h("div",{style:{display:"flex",gap:10,marginBottom:18}},
          h("label",{style:{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"rgba(255,255,255,.7)"}},
            h("input",{type:"checkbox",checked:exportIncludiCommenti,onChange:function(e){setExportIncludiCommenti(e.target.checked);},style:{width:16,height:16,cursor:"pointer"}}),
            "Includi commenti"),
          h("label",{style:{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"rgba(255,255,255,.7)"}},
            h("input",{type:"checkbox",checked:exportIncludiVoti,onChange:function(e){setExportIncludiVoti(e.target.checked);},style:{width:16,height:16,cursor:"pointer"}}),
            "Includi risultati sondaggi"),
          h("label",{style:{display:"flex",alignItems:"center",gap:8,cursor:"pointer",fontSize:13,color:"rgba(255,255,255,.7)"}},
            h("input",{type:"checkbox",checked:exportIncludiAI,onChange:function(e){setExportIncludiAI(e.target.checked);},style:{width:16,height:16,cursor:"pointer"}}),
            "Includi analisi AI")
        ),
        (function(){
          var sel=cards.filter(function(c){if(c.proposta)return false;if(exportTipo!=="tutti"&&c.tipo!==exportTipo)return false;if(exportFiltro==="tutte")return true;var cc=c.classi||["TUTTE"];return cc.indexOf("TUTTE")>=0||cc.indexOf(exportFiltro)>=0;});
          var conAI=sel.filter(function(c){var aiD=aiMap[String(c.id)];return aiD&&aiD.analisi&&(aiD.analisi.sintesi||aiD.analisi.dinamica||aiD.analisi.spunto);}).length;
          return h("div",{style:{background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.2)",borderRadius:8,padding:"8px 12px",marginBottom:16,fontSize:12,color:"rgba(255,255,255,.5)",textAlign:"center"}},
            sel.length+" card selezionate",
            exportIncludiAI&&conAI>0&&h("span",{style:{marginLeft:8,color:"#a5b4fc",fontWeight:700}},"¬∑ "+conAI+" con analisi AI ‚úì"),
            exportIncludiAI&&conAI===0&&h("span",{style:{marginLeft:8,color:"rgba(255,255,255,.3)"}},"¬∑ nessuna analisi AI presente")
          );
        })(),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setShowExport(false);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:generaPDF,style:{flex:2,padding:11,background:"linear-gradient(135deg,#6366f1,#8b5cf6)",color:"#fff",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:"pointer"}},"üì• Genera e stampa")
        )
      )
    ),

    askKey&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setAskKey(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:400,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:36,marginBottom:10}},"üîë"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},"Chiave Groq"),
        h("p",{style:{color:"rgba(255,255,255,.5)",fontSize:12,marginBottom:16,lineHeight:1.5}},"Gratuita (30 req/min). Ottienila su console.groq.com ‚Üí API Keys"),
        orKey&&h("div",{style:{background:"rgba(34,197,94,.1)",border:"1px solid rgba(34,197,94,.3)",borderRadius:8,padding:10,marginBottom:14}},h("div",{style:{color:"#4ade80",fontSize:11,fontWeight:700}},"‚úì Chiave gi√† impostata")),
        h("input",{type:"password",value:akInput,onInput:function(e){setAkInput(e.target.value);},placeholder:"gsk_‚Ä¶",style:Object.assign({},S.input,{marginBottom:12})}),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setAskKey(false);setAkInput("");},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:saveAIKey,style:{flex:1,padding:11,background:akInput.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:akInput.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:akInput.trim()?"pointer":"not-allowed"}},"Salva")
        )
      )
    ),

    // DETTAGLIO CARD
    showCard&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",padding:12},onClick:closeCard},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,width:"100%",maxWidth:520,maxHeight:"92vh",overflow:"auto"},onClick:function(e){e.stopPropagation();}},

        h("div",{style:{background:"linear-gradient(135deg,rgba(99,102,241,.3),rgba(139,92,246,.2))",borderRadius:"20px 20px 0 0",padding:18}},
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}},
            h("span",{style:{background:badgeBg(showCard.tipo),color:"#fff",borderRadius:7,padding:"3px 9px",fontSize:11,fontWeight:800}},tipoIcon(showCard.tipo)+" "+showCard.tipo.toUpperCase()),
            h("button",{onClick:closeCard,style:{background:"rgba(255,255,255,.1)",border:"none",borderRadius:"50%",width:28,height:28,cursor:"pointer",fontSize:15,color:"rgba(255,255,255,.7)"}},"√ó")
          ),
          h("h2",{style:{margin:"0 0 8px",color:"#fff",fontSize:17,fontWeight:800,lineHeight:1.3}},showCard.titolo),
          showCard.testo&&h("p",{style:{margin:"0 0 8px",color:"rgba(255,255,255,.65)",fontSize:12,lineHeight:1.7,whiteSpace:"pre-wrap"}},showCard.testo),
          renderLinks(showCard),
          showCard.tipo==="sondaggio"&&showCard.opzioni&&(function(){
            var totV=showCard.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
            var vn=myName(user);
            var myVote=showCard.opzioni.find(function(o){return o.voti.indexOf(vn)>=0;});
            return h("div",{style:{marginTop:12}},
              showCard.opzioni.map(function(o){
                var pct=totV>0?Math.round(o.voti.length/totV*100):0,isMine=myVote&&myVote.id===o.id;
                return h("div",{key:o.id,onClick:function(){vote(showCard.id,o.id);},style:{background:isMine?"rgba(99,102,241,.3)":"rgba(255,255,255,.06)",border:"1px solid "+(isMine?"rgba(99,102,241,.6)":"rgba(255,255,255,.1)"),borderRadius:9,padding:"8px 12px",marginBottom:6,cursor:"pointer",position:"relative",overflow:"hidden"}},
                  h("div",{style:{position:"absolute",left:0,top:0,bottom:0,width:pct+"%",background:"rgba(99,102,241,.2)"}}),
                  h("div",{style:{position:"relative",display:"flex",justifyContent:"space-between",alignItems:"center"}},
                    h("span",{style:{fontSize:13,fontWeight:isMine?700:400,color:"#f1f5f9"}},o.testo),
                    h("div",{style:{display:"flex",alignItems:"center",gap:6}},isMine&&h("span",{style:{fontSize:10,color:"#a5b4fc",fontWeight:700}},"‚úì tuo voto"),h("span",{style:{fontSize:12,color:"rgba(255,255,255,.4)"}},pct+"% ("+o.voti.length+")")))
                );
              }).concat([h("div",{key:"tot",style:{fontSize:11,color:"rgba(255,255,255,.3)",textAlign:"right",marginTop:4}},totV+" voti")])
            );
          })(),
          h("div",{style:{marginTop:12,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8}},
            h("button",{onClick:function(e){e.stopPropagation();toggleLike(showCard.id);},style:{background:myLikes.current.has(String(showCard.id))?"rgba(99,102,241,.3)":"rgba(255,255,255,.08)",border:"1px solid "+(myLikes.current.has(String(showCard.id))?"rgba(99,102,241,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"5px 14px",cursor:"pointer",fontSize:14,color:myLikes.current.has(String(showCard.id))?"#a5b4fc":"rgba(255,255,255,.5)",display:"flex",alignItems:"center",gap:6,fontWeight:700}},"üëç ",(showCard.likes||0)),
            !isProf&&h("button",{onClick:function(){togglePreferito(showCard.id);},style:{background:preferiti.indexOf(String(showCard.id))>=0?"rgba(245,158,11,.3)":"rgba(255,255,255,.06)",border:"1px solid "+(preferiti.indexOf(String(showCard.id))>=0?"rgba(245,158,11,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"5px 12px",cursor:"pointer",fontSize:15,color:preferiti.indexOf(String(showCard.id))>=0?"#fbbf24":"rgba(255,255,255,.3)",fontWeight:700}},preferiti.indexOf(String(showCard.id))>=0?"‚òÖ Preferita":"‚òÜ Aggiungi"),
            h("span",{style:{fontSize:10,color:"rgba(255,255,255,.3)"}},fmt(showCard.data))
          ),
          !isProf&&showCard.autore===myName(user)&&!showCard.proposta&&h("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginTop:10}},
            h("button",{onClick:function(){editCard(showCard);setSC(null);},style:{background:"rgba(59,130,246,.2)",color:"#60a5fa",border:"1px solid rgba(59,130,246,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"‚úèÔ∏è Modifica")
          ),
          isProf&&!simulaSt&&h("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginTop:10}},
            h("button",{onClick:function(){editCard(showCard);setSC(null);},style:{background:"rgba(59,130,246,.2)",color:"#60a5fa",border:"1px solid rgba(59,130,246,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"‚úèÔ∏è Modifica"),
            h("button",{onClick:function(){apriDuplica(showCard,{stopPropagation:function(){}});setSC(null);},style:{background:"rgba(245,158,11,.2)",color:"#fbbf24",border:"1px solid rgba(245,158,11,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"üìã Duplica"),
            h("button",{onClick:function(){delCard(showCard.id);},style:{background:"rgba(239,68,68,.12)",color:"#f87171",border:"none",borderRadius:7,padding:"3px 9px",cursor:"pointer",fontSize:11,fontWeight:700}},"üóëÔ∏è Elimina"),
            h("button",{onClick:function(e){toggleVisibile(showCard,e);},style:{background:showCard.visibile===false?"rgba(34,197,94,.15)":"rgba(255,255,255,.08)",color:showCard.visibile===false?"#4ade80":"rgba(255,255,255,.5)",border:"1px solid "+(showCard.visibile===false?"rgba(34,197,94,.3)":"rgba(255,255,255,.1)"),borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},showCard.visibile===false?"üëÅÔ∏è Mostra":"üö´ Nascondi"),
            h("button",{onClick:function(){setConfirmDel({type:"resetCard",cardId:showCard.id});},style:{background:"rgba(249,115,22,.15)",color:"#fb923c",border:"1px solid rgba(249,115,22,.35)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"üîÑ Reset")
          )
        ),

        // ‚îÄ‚îÄ AI DOMANDA LIBERA ‚îÄ‚îÄ
        isProf&&!simulaSt&&(function(){
          var aiD=aiMap[String(showCard.id)];
          var domande=(aiD&&Array.isArray(aiD.domande)?aiD.domande:(aiD&&aiD.domanda?[aiD.domanda]:[]));
          return h("div",{style:{borderTop:"1px solid rgba(99,102,241,.2)",background:"rgba(15,15,40,.7)",padding:"12px 16px"}},
            h("div",{style:{fontWeight:700,color:"#a5b4fc",fontSize:12,marginBottom:8,display:"flex",alignItems:"center",gap:6}},
              "ü§ñ Chiedi all'AI su questa card",
              domande.length>0&&h("span",{style:{background:"rgba(99,102,241,.35)",color:"#e0e7ff",borderRadius:10,padding:"1px 7px",fontSize:10,fontWeight:800}},domande.length)
            ),
            domande.length>0&&h("div",{style:{marginBottom:10}},
              domande.map(function(d,idx){
                var isOpen=cardQOpen[d.id||idx];
                return h("div",{key:d.id||idx,style:{background:"rgba(99,102,241,.07)",border:"1px solid rgba(99,102,241,.18)",borderRadius:9,marginBottom:6,overflow:"hidden"}},
                  h("div",{
                    onClick:function(){setCardQOpen(function(prev){var n=Object.assign({},prev);n[d.id||idx]=!n[d.id||idx];return n;});},
                    style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",cursor:"pointer",userSelect:"none"}
                  },
                    h("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1,minWidth:0}},
                      h("span",{style:{fontSize:10,color:"rgba(255,255,255,.3)",flexShrink:0}},fmtDT(d.data)),
                      h("span",{style:{fontSize:11,color:"#a5b4fc",fontWeight:700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}},"‚ùì "+d.q)
                    ),
                    h("div",{style:{display:"flex",alignItems:"center",gap:6,flexShrink:0}},
                      h("button",{
                        onClick:function(e){e.stopPropagation();var aggiornate=domande.filter(function(_,i){return i!==idx;});aiSave(showCard.id,{domande:aggiornate});},
                        style:{background:"none",border:"none",color:"rgba(255,255,255,.2)",fontSize:12,cursor:"pointer",padding:"0 2px",lineHeight:1}
                      },"√ó"),
                      h("span",{style:{color:"rgba(255,255,255,.3)",fontSize:12,transition:"transform .2s",display:"inline-block",transform:isOpen?"rotate(180deg)":"rotate(0deg)"}},"‚ñæ")
                    )
                  ),
                  isOpen&&h("div",{style:{padding:"0 12px 10px"}},
                    h("div",{style:{fontSize:12,color:"rgba(255,255,255,.85)",lineHeight:1.75,whiteSpace:"pre-wrap",borderTop:"1px solid rgba(99,102,241,.15)",paddingTop:8}},d.risposta)
                  )
                );
              })
            ),
            h("div",{style:{display:"flex",gap:6,marginBottom:cardQErr?8:0}},
              h("input",{
                value:cardQ,
                onInput:function(e){setCardQ(e.target.value);},
                onKeyDown:function(e){if(e.key==="Enter"&&!cardQLoad&&cardQ.trim())runCardQ();},
                placeholder:"Es. C'√® consenso? Chi ha partecipato di pi√π?",
                style:Object.assign({},S.input,{flex:1,fontSize:12})
              }),
              h("button",{onClick:runCardQ,disabled:cardQLoad||!cardQ.trim(),
                style:{background:cardQ.trim()&&!cardQLoad?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.08)",color:cardQ.trim()&&!cardQLoad?"#fff":"rgba(255,255,255,.3)",border:"none",borderRadius:8,padding:"0 14px",cursor:cardQ.trim()&&!cardQLoad?"pointer":"not-allowed",fontSize:12,fontWeight:700,whiteSpace:"nowrap",flexShrink:0,minHeight:38}
              },cardQLoad?h("span",{style:{display:"inline-block",animation:"spin 1s linear infinite"}},"‚öôÔ∏è"):"Chiedi")
            ),
            cardQErr&&h("div",{style:{color:"#f87171",fontSize:11,background:"rgba(239,68,68,.1)",padding:"6px 10px",borderRadius:6}},cardQErr)
          );
        })(),

        // COMMENTI
        h("div",{style:{padding:"14px 16px"}},
          h("div",{style:{fontWeight:700,color:"rgba(255,255,255,.7)",fontSize:13,marginBottom:10}},"üí¨ Commenti ("+(showCard.commenti||[]).length+")"),
          (showCard.commenti||[]).length===0&&h("div",{style:{color:"rgba(255,255,255,.25)",fontSize:12,textAlign:"center",padding:"12px 0"}},"Nessun commento. Sii il primo!"),
          (function(){
            function renderThread(item,depth,parentId){
              var isMyCm=item.autore===myName(user),isEditing=editingCm&&editingCm.id===item.id,isReplying=replyTo&&replyTo.id===item.id,isTopLevel=depth===0;
              return h("div",{key:item.id,style:{marginLeft:Math.min(depth,4)*14,marginTop:depth>0?5:10}},
                h("div",{style:{background:"rgba(255,255,255,"+(Math.max(0.01,0.05-depth*0.01))+")",borderRadius:9,padding:"8px 10px",border:"1px solid rgba(255,255,255,"+(Math.max(0.03,0.08-depth*0.015))+")"}},
                  h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}},
                    h("span",{style:{fontWeight:700,fontSize:depth===0?12:11,color:isMyCm?"#a5b4fc":"rgba(255,255,255,.55)"}},depth>0&&h("span",{style:{color:"rgba(99,102,241,.5)",marginRight:4,fontSize:10}},"‚Ü≥"),item.autore+(item.modificato?" ‚úé":"")),
                    h("div",{style:{display:"flex",gap:6,alignItems:"center"}},
                      h("span",{style:{fontSize:9,color:"rgba(255,255,255,.2)"}},fmt(item.data)),
                      (isMyCm||isProf)&&!isEditing&&isTopLevel&&h("button",{onClick:function(){setEditingCm({id:item.id,testo:item.testo});},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(99,102,241,.7)",fontSize:12}},"‚úèÔ∏è"),
                      (isMyCm||isProf)&&h("button",{onClick:function(){setConfirmDel(isTopLevel?{type:"comment",cardId:showCard.id,id:item.id}:{type:"reply",cmId:parentId||item.id,id:item.id,cardId:showCard.id});},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,.2)",fontSize:13}},"√ó")
                    )
                  ),
                  isEditing?h("div",null,
                    h("textarea",{value:editingCm.testo,onInput:function(e){setEditingCm(function(p){return Object.assign({},p,{testo:e.target.value});});},rows:2,style:Object.assign({},S.input,{resize:"none",marginBottom:6,fontSize:12})}),
                    h("div",{style:{display:"flex",gap:6}},
                      h("button",{onClick:function(){saveEditCm(showCard.id);},style:{flex:1,padding:"5px 0",background:"linear-gradient(135deg,#6366f1,#8b5cf6)",color:"#fff",border:"none",borderRadius:7,fontSize:12,fontWeight:700,cursor:"pointer"}},"Salva"),
                      h("button",{onClick:function(){setEditingCm(null);},style:{padding:"5px 10px",background:"rgba(255,255,255,.07)",color:"rgba(255,255,255,.4)",border:"none",borderRadius:7,fontSize:12,cursor:"pointer"}},"Annulla")
                    ))
                  :h("div",null,
                      h("div",{style:{fontSize:depth===0?12:11,color:"rgba(255,255,255,.65)",lineHeight:1.5,marginBottom:5}},item.testo),
                      h("button",{onClick:function(){setReplyTo({id:item.id,autore:item.autore});setReplyTesto("");},style:{background:"rgba(99,102,241,.08)",border:"1px solid rgba(99,102,241,.2)",borderRadius:6,padding:"2px 8px",cursor:"pointer",fontSize:10,color:"#a5b4fc",fontWeight:700}},"‚Ü©Ô∏è Rispondi")
                    )
                ),
                isReplying&&h("div",{style:{marginLeft:14,marginTop:5,background:"rgba(99,102,241,.07)",borderRadius:8,padding:8,border:"1px solid rgba(99,102,241,.18)"}},
                  h("div",{style:{fontSize:10,color:"#a5b4fc",marginBottom:4,fontWeight:700}},"‚Ü©Ô∏è Rispondi a "+replyTo.autore),
                  h("textarea",{value:replyTesto,onInput:function(e){setReplyTesto(e.target.value);},rows:2,placeholder:"Scrivi una risposta‚Ä¶",style:Object.assign({},S.input,{resize:"none",marginBottom:6,fontSize:11})}),
                  h("div",{style:{display:"flex",gap:6}},
                    h("button",{onClick:function(){addReply(item.id);},style:{flex:1,padding:"5px 0",background:replyTesto.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:replyTesto.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:7,fontSize:11,fontWeight:700,cursor:replyTesto.trim()?"pointer":"not-allowed"}},"Invia"),
                    h("button",{onClick:function(){setReplyTo(null);setReplyTesto("");},style:{padding:"5px 10px",background:"rgba(255,255,255,.07)",color:"rgba(255,255,255,.4)",border:"none",borderRadius:7,fontSize:11,cursor:"pointer"}},"Annulla")
                  )
                ),
                (item.risposte||[]).length>0&&h("div",null,(item.risposte||[]).map(function(r){return renderThread(r,depth+1,isTopLevel?item.id:parentId);}))
              );
            }
            return (showCard.commenti||[]).map(function(cm){return renderThread(cm,0,null);});
          })(),
          h("div",{style:{marginTop:10,background:"rgba(255,255,255,.03)",borderRadius:10,padding:12,border:"1px solid rgba(255,255,255,.07)"}},
            h("div",{style:{fontSize:11,fontWeight:700,color:"#a5b4fc",marginBottom:7,padding:"4px 9px",background:"rgba(99,102,241,.15)",borderRadius:7}},"üë§ "+myName(user)),
            h("textarea",{id:"cm-textarea",value:nc.testo,onInput:function(e){setNc({testo:e.target.value});},rows:2,placeholder:"Scrivi un commento‚Ä¶",style:Object.assign({},S.input,{resize:"none",marginBottom:7})}),
            h("button",{onClick:addCom,style:{width:"100%",padding:8,background:nc.testo.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:nc.testo.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer"}},"Pubblica commento")
          )
        )
      )
    ),

    // MODAL NUOVA CARD
    showModal&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",zIndex:200,display:"flex",alignItems:"flex-end",justifyContent:"center"},onClick:function(){setSM(false);setEditMode(null);}},
      h("div",{style:{background:"#1e293b",borderRadius:"20px 20px 0 0",padding:20,width:"100%",maxWidth:540,maxHeight:"90vh",overflow:"auto",border:"1px solid rgba(255,255,255,.1)",borderBottom:"none"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{width:32,height:3,background:"rgba(255,255,255,.15)",borderRadius:4,margin:"0 auto 16px"}}),
        h("h3",{style:{margin:"0 0 4px",color:"#f1f5f9",fontSize:15,fontWeight:800}},editMode?"‚úèÔ∏è Modifica card":(!isProf?"üí° Proponi una discussione":"Nuova card")),
        !isProf&&!editMode&&h("p",{style:{margin:"0 0 14px",color:"rgba(255,255,255,.3)",fontSize:11}},"Visibile dopo approvazione del professore"),
        isProf&&h("div",{style:{display:"flex",gap:7,marginBottom:14}},
          [{v:"domanda",i:"üí¨"},{v:"nota",i:"üìÑ"},{v:"sondaggio",i:"üó≥Ô∏è"}].map(function(t){
            return h("button",{key:t.v,onClick:function(){setForm(function(p){return Object.assign({},p,{tipo:t.v});});},style:{flex:1,padding:"8px 4px",border:"1px solid "+(form.tipo===t.v?"#6366f1":"rgba(255,255,255,.1)"),borderRadius:10,background:form.tipo===t.v?"rgba(99,102,241,.25)":"rgba(255,255,255,.04)",cursor:"pointer",fontWeight:700,fontSize:12,color:form.tipo===t.v?"#a5b4fc":"rgba(255,255,255,.4)"}},t.i+" "+t.v);
          })
        ),
        h("div",{style:{marginBottom:10}},h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"TITOLO *"),h("input",{value:form.titolo,onInput:function(e){setForm(function(p){return Object.assign({},p,{titolo:e.target.value});});},placeholder:"Es. Riflessione su‚Ä¶",style:S.input})),
        h("div",{style:{marginBottom:10}},h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"TESTO"),h("textarea",{value:form.testo,onInput:function(e){setForm(function(p){return Object.assign({},p,{testo:e.target.value});});},rows:3,placeholder:"Descrizione, spunti‚Ä¶",style:Object.assign({},S.input,{resize:"vertical"})})),
        isProf&&h("div",{style:{marginBottom:10}},
          h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",letterSpacing:1,display:"block",marginBottom:6}},"üè´ VISIBILE A"),
          h("p",{style:{fontSize:10,color:"rgba(255,255,255,.3)",marginBottom:8}},"Nessuna selezione = visibile solo al prof."),
          h("div",{style:{display:"flex",flexWrap:"wrap",gap:5}},
            h("button",{type:"button",onClick:function(){setForm(function(f){var isAll=f.classi&&f.classi.indexOf("TUTTE")>=0;return Object.assign({},f,{classi:isAll?[]:["TUTTE"]});});},style:Object.assign({},S.filterBtn(form.classi&&form.classi.indexOf("TUTTE")>=0),{fontSize:11,padding:"3px 9px"})},(form.classi&&form.classi.indexOf("TUTTE")>=0?"‚úì ":"")+"TUTTE LE CLASSI"),
            CLASSI_LIST.map(function(cl){
              var sel=form.classi&&form.classi.indexOf(cl)>=0&&form.classi.indexOf("TUTTE")<0;
              return h("button",{type:"button",key:cl,onClick:function(){setForm(function(f){var cur=(f.classi||[]).filter(function(x){return x!=="TUTTE";});var idx=cur.indexOf(cl);var next=idx>=0?cur.filter(function(x){return x!==cl;}):[].concat(cur,[cl]);return Object.assign({},f,{classi:next});});},style:Object.assign({},S.filterBtn(sel),{fontSize:11,padding:"3px 9px"})},(sel?"‚úì ":"")+cl);
            })
          ),
          form.classi&&form.classi.length===0&&h("div",{style:{marginTop:6,fontSize:10,color:"#f87171",background:"rgba(239,68,68,.1)",padding:"4px 8px",borderRadius:6}},"‚ö†Ô∏è Nessuna classe: visibile solo al prof")
        ),
        h("div",{style:{marginBottom:10}},
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
            h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",letterSpacing:1}},"üîó LINK"),
            (form.links||[]).length<5&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{links:(p.links||[]).concat([{url:"",label:""}])});});},style:{background:"rgba(99,102,241,.2)",border:"1px solid rgba(99,102,241,.4)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,color:"#a5b4fc",fontWeight:700}},"+ Aggiungi")
          ),
          (form.links||[]).map(function(l,i){return h("div",{key:i,style:{background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.08)",borderRadius:9,padding:"8px 10px",marginBottom:6}},
            h("div",{style:{display:"flex",gap:5,marginBottom:5}},
              h("input",{value:l.url,onInput:function(e){setForm(function(p){var ls=p.links.map(function(x,j){return j===i?Object.assign({},x,{url:e.target.value}):x;});return Object.assign({},p,{links:ls});});},placeholder:"https://‚Ä¶",style:Object.assign({},S.input,{flex:1})}),
              (form.links||[]).length>1&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{links:p.links.filter(function(_,j){return j!==i;})});});},style:{background:"rgba(239,68,68,.2)",color:"#f87171",border:"none",borderRadius:7,padding:"0 9px",cursor:"pointer",fontSize:16,flexShrink:0}},"√ó")
            ),
            h("input",{value:l.label,onInput:function(e){setForm(function(p){var ls=p.links.map(function(x,j){return j===i?Object.assign({},x,{label:e.target.value}):x;});return Object.assign({},p,{links:ls});});},placeholder:"Etichetta (es. Wikipedia, Video‚Ä¶)",style:Object.assign({},S.input,{fontSize:11})})
          );})
        ),
        form.tipo==="sondaggio"&&h("div",{style:{marginBottom:10}},
          h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"OPZIONI"),
          form.opzioni.map(function(o,i){return h("div",{key:i,style:{display:"flex",gap:5,marginBottom:6}},
            h("input",{value:o,onInput:function(e){setForm(function(p){var ops=p.opzioni.slice();ops[i]=e.target.value;return Object.assign({},p,{opzioni:ops});});},placeholder:"Opzione "+(i+1),style:S.input}),
            form.opzioni.length>2&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{opzioni:p.opzioni.filter(function(_,j){return j!==i;})});});},style:{background:"rgba(239,68,68,.2)",color:"#f87171",border:"none",borderRadius:7,padding:"0 9px",cursor:"pointer",fontSize:16}},"√ó")
          );}),
          form.opzioni.length<6&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{opzioni:p.opzioni.concat([""])});});},style:{background:"rgba(255,255,255,.04)",border:"1px dashed rgba(255,255,255,.15)",borderRadius:7,padding:"5px 12px",cursor:"pointer",fontSize:12,color:"rgba(255,255,255,.4)",width:"100%"}},"+ Aggiungi opzione")
        ),
        h("button",{onClick:addCard,style:{width:"100%",padding:13,marginTop:4,background:form.titolo.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:form.titolo.trim()?"#fff":"rgba(255,255,255,.2)",border:"none",borderRadius:12,fontSize:14,fontWeight:800,cursor:form.titolo.trim()?"pointer":"not-allowed"}},editMode?"üíæ Salva modifiche":(!isProf?"üì© Invia proposta":"üìå Pubblica card"))
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(h(App,null));
})();
/*
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  FIRESTORE SECURITY RULES ‚Äî incolla nella Firebase Console
  Percorso: Firebase Console ‚Üí Firestore Database ‚Üí Rules
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Tutti gli autenticati possono leggere e scrivere
    // (necessario per proposte studenti, like, commenti, voti)
    match /cards/{cardId} {
      allow read, write: if request.auth != null;
    }

    // ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Ogni utente legge/modifica solo il proprio documento
    // Il prof pu√≤ leggere tutti
    match /users/{userId} {
      allow read: if request.auth != null &&
        (request.auth.uid == userId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "prof");
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ‚îÄ‚îÄ CONFIG (classi custom, ecc.) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Tutti possono leggere (serve per vedere le classi)
    // Solo il prof pu√≤ scrivere
    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "prof";
    }

    // ‚îÄ‚îÄ AI RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Solo il prof pu√≤ leggere e scrivere
    match /ai_results/{docId} {
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "prof";
    }

    // ‚îÄ‚îÄ PREFERITI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Ogni utente pu√≤ leggere e scrivere solo i propri preferiti
    match /preferiti/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

  }
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
*/
</script>
</body>
</html>
