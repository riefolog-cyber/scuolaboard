<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ScuolaBoard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#1a1a2e}
textarea,input,select,button{font-family:inherit}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes fadein{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pulse{animation:pulse 2s infinite}
.fadein{animation:fadein .3s ease}
.card-wrap{transition:opacity .2s,transform .2s}
.card-wrap.dragging{opacity:.35;transform:scale(.97)}
.card-wrap.drag-over{outline:2px dashed #6366f1;border-radius:16px;outline-offset:2px}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
(function(){
firebase.initializeApp({
  apiKey:"AIzaSyDIC39upI9VnY10MdP7__7l3omyGqspHNA",
  authDomain:"scuolaboard-874d4.firebaseapp.com",
  projectId:"scuolaboard-874d4",
  storageBucket:"scuolaboard-874d4.firebasestorage.app",
  messagingSenderId:"249372381209",
  appId:"1:249372381209:web:737697d4d10b3ae06eda88"
});
var db=firebase.firestore(),auth=firebase.auth();
var h=React.createElement,useState=React.useState,useEffect=React.useEffect,useRef=React.useRef,Fragment=React.Fragment;
var PROF_TOKEN="sb_prof_2025_xK9mNpQr";
var CLASSI_LIST=["1AO","1AI","1BO","1CO","2AO","2AI","2BO","2CO","3AO","3AI","3BO","4AO","4AI","4BO","5AO","5AA","5AI","5BO"];
var FORM0={tipo:"domanda",titolo:"",testo:"",opzioni:["",""],links:[{url:"",label:""}],classi:["TUTTE"]};

function fmt(d){return new Date(d).toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"});}
function fmtDt(ts){
  if(!ts)return"";
  var d=ts.toDate?ts.toDate():new Date(ts);
  return d.toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"})+" "+d.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
}
function isNew(d){return Date.now()-new Date(d).getTime()<86400000;}
function badgeBg(t){return t==="domanda"?"#6366f1":t==="nota"?"#f59e0b":t==="sondaggio"?"#22c55e":"#94a3b8";}
function tipoIcon(t){return t==="domanda"?"ðŸ’¬":t==="nota"?"ðŸ“„":t==="sondaggio"?"ðŸ—³ï¸":"ðŸ“Œ";}
function fbSave(c){return db.collection("cards").doc(String(c.id)).set(c);}
function fbDel(id){return db.collection("cards").doc(String(id)).delete();}
function fbListen(cb){return db.collection("cards").orderBy("ordine","asc").onSnapshot(function(s){var a=[];s.forEach(function(d){a.push(d.data());});cb(a);});}
function normalizeLinks(c){
  if(c.links&&Array.isArray(c.links))return c.links;
  if(c.linkEsterno&&typeof c.linkEsterno==="string")return[{url:c.linkEsterno,label:""}];
  return[];
}

// â”€â”€ Firestore AI results â”€â”€
function aiSaveQ(cardId,domanda,risposta){
  return db.collection("ai_results").doc(String(cardId)).set({
    domanda:domanda,risposta:risposta,
    aggiornatoQ:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
}
function aiSaveInline(cardId,res){
  return db.collection("ai_results").doc(String(cardId)).set({
    inline:res,
    aggiornatoInline:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
}
function aiLoadAll(cb){
  return db.collection("ai_results").onSnapshot(function(s){
    var m={};s.forEach(function(d){m[d.id]=d.data();});cb(m);
  });
}

// â”€â”€ Groq â”€â”€
var GROQ_MODELS=["llama-3.3-70b-versatile","llama3-70b-8192","llama3-8b-8192"];
function callGroqJSON(k,prompt,mx){return _groq(k,prompt,mx||700,0,true);}
function callGroqText(k,prompt,mx){return _groq(k,prompt,mx||600,0,false);}
function _groq(k,prompt,mx,mi,json){
  if(mi>=GROQ_MODELS.length)return Promise.reject(new Error("Nessun modello disponibile."));
  return fetch("https://api.groq.com/openai/v1/chat/completions",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+k},
    body:JSON.stringify({
      model:GROQ_MODELS[mi],max_tokens:mx,temperature:0.7,
      messages:[
        {role:"system",content:json?"Sei un assistente pedagogico italiano. Rispondi SOLO con JSON valido. Nessun testo, nessun markdown.":"Sei un assistente pedagogico italiano. Rispondi in italiano in modo diretto e utile."},
        {role:"user",content:prompt}
      ]
    })
  }).then(function(r){
    if(r.status===429||r.status===503)return _groq(k,prompt,mx,mi+1,json);
    if(!r.ok)return r.json().then(function(e){throw new Error(e.error&&e.error.message||"Errore "+r.status);});
    return r.json();
  }).then(function(d){
    var raw=(d.choices&&d.choices[0]&&d.choices[0].message&&d.choices[0].message.content||"").trim();
    if(!raw)return _groq(k,prompt,mx,mi+1,json);
    if(!json)return raw;
    raw=raw.replace(/^```(?:json)?[\r\n]*/i,"").replace(/[\r\n]*```$/,"").trim();
    var m=raw.match(/\{[\s\S]*\}/);
    if(!m)return _groq(k,prompt,mx,mi+1,json);
    try{return JSON.parse(m[0]);}catch(e){return _groq(k,prompt,mx,mi+1,json);}
  });
}

var S={
  input:{width:"100%",padding:"8px 10px",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,fontSize:13,background:"rgba(255,255,255,.08)",color:"#f1f5f9"},
  filterBtn:function(a){return{display:"flex",alignItems:"center",gap:4,padding:"5px 12px",borderRadius:20,border:"1px solid "+(a?"#6366f1":"rgba(255,255,255,.15)"),background:a?"#6366f1":"rgba(255,255,255,.05)",color:a?"#fff":"rgba(255,255,255,.6)",fontSize:12,fontWeight:700,cursor:"pointer"};}
};

function renderLinks(card){
  var links=normalizeLinks(card);
  if(!links.length)return null;
  return h("div",{style:{marginTop:8,display:"flex",flexDirection:"column",gap:5}},
    links.map(function(l,i){
      if(!l.url)return null;
      return h("a",{key:i,href:l.url,target:"_blank",rel:"noopener noreferrer",
        style:{display:"inline-flex",alignItems:"center",gap:6,background:"rgba(59,130,246,.15)",color:"#60a5fa",padding:"5px 10px",borderRadius:7,textDecoration:"none",fontSize:11,fontWeight:600,border:"1px solid rgba(59,130,246,.3)"}},
        "ðŸ”— "+(l.label||"Approfondisci"));
    })
  );
}

// â”€â”€ Contesto card per AI â”€â”€
function buildCardContext(card){
  var commTxt=(card.commenti||[]).length
    ?(card.commenti||[]).map(function(cm){
        var r="  - "+cm.autore+": \""+cm.testo+"\"";
        if(cm.risposte&&cm.risposte.length)r+=cm.risposte.map(function(rep){return"\n    â†³ "+rep.autore+": \""+rep.testo+"\"";}).join("");
        return r;
      }).join("\n")
    :"nessun commento";
  var votiTxt="";
  if(card.opzioni){
    var tv=card.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
    votiTxt="\nVoti sondaggio (totale "+tv+"):\n"+card.opzioni.map(function(o){var p=tv>0?Math.round(o.voti.length/tv*100):0;return"  - \""+o.testo+"\": "+o.voti.length+" ("+p+"%)";}).join("\n");
  }
  return 'Titolo: "'+card.titolo+'"\nTipo: '+card.tipo+'\nTesto: '+(card.testo||"(nessuno)")+'\nLike: '+(card.likes||0)+votiTxt+'\nCommenti:\n'+commTxt;
}

function App(){
  var [user,setUser]=useState(null);
  var [authLoad,setAuthLoad]=useState(true);
  var [cards,setCards]=useState([]);
  var [view,setView]=useState("bacheca");
  var [previewSt,setPreviewSt]=useState(false);
  var [showModal,setSM]=useState(false);
  var [showCard,setSC]=useState(null);
  var [showQR,setSQR]=useState(false);
  var [showReset,setSR]=useState(false);
  var [form,setForm]=useState(Object.assign({},FORM0));
  var [editMode,setEditMode]=useState(null);
  var [nc,setNc]=useState({testo:""});
  var [editingCm,setEditingCm]=useState(null);
  var [replyTo,setReplyTo]=useState(null);
  var [replyTesto,setReplyTesto]=useState("");
  var [confirmDel,setConfirmDel]=useState(null);
  var [showResetOpt,setShowResetOpt]=useState(false);
  var [orKey,setOrKey]=useState(localStorage.getItem("groq_key")||"");
  var [askKey,setAskKey]=useState(false);
  var [akInput,setAkInput]=useState("");
  var [aiLoad,setAiLoad]=useState(false);
  var [aiResult,setAiR]=useState(null);
  var [aiTarget,setAIT]=useState("tutte");
  var [aiErr,setAiErr]=useState("");
  // AI inline card
  var [cardAiLoad,setCardAIL]=useState(null);
  var [cardAiOpen,setCardAiOpen]=useState(null);
  // AI domanda libera
  var [cardQ,setCardQ]=useState("");
  var [cardQLoad,setCardQLoad]=useState(false);
  var [cardQErr,setCardQErr]=useState("");
  // Firestore AI results: { cardId: { domanda, risposta, aggiornatoQ, inline, aggiornatoInline } }
  var [aiMap,setAiMap]=useState({});
  // Classe
  var [showClasseModal,setShowClasseModal]=useState(false);
  var [classeInput,setClasseInput]=useState("");
  var [filterClasse,setFilterClasse]=useState("tutte");
  var [studenti,setStudenti]=useState([]);
  var [viewStudenti,setViewStudenti]=useState(false);
  // Duplica
  var [showDuplica,setShowDuplica]=useState(null);
  var [duplicaClassi,setDuplicaClassi]=useState([]);
  var myLikes=useRef(new Set());
  var nextOrd=useRef(100);
  var dragId=useRef(null);

  function myName(u){return u?(u.role==="prof"?"Prof":(u.nome+" "+u.cognome).trim()||u.email):"?";}
  function closeCard(){setSC(null);setEditingCm(null);setReplyTo(null);setCardQErr("");setCardQ("");}

  useEffect(function(){
    auth.getRedirectResult().then(function(cr){
      if(!cr||!cr.user)return;
      var fu=cr.user;
      db.collection("users").doc(fu.uid).get().then(function(ud){
        if(!ud.exists){var np=(fu.displayName||"").split(" ");db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google"});}
      });
    }).catch(function(){});
    var unsub=auth.onAuthStateChanged(function(fu){
      if(fu){
        db.collection("users").doc(fu.uid).get().then(function(doc){
          var base={uid:fu.uid,email:fu.email,displayName:fu.displayName,photoURL:fu.photoURL};
          if(doc.exists){var d=doc.data();setUser(Object.assign({},base,{role:d.role||"studente",nome:d.nome||"Utente",cognome:d.cognome||"",classe:d.classe||null}));}
          else{setUser(Object.assign({},base,{role:"studente",nome:fu.displayName?fu.displayName.split(" ")[0]:"Utente",cognome:"",classe:null}));}
          setAuthLoad(false);
        }).catch(function(){setAuthLoad(false);});
      }else{setUser(null);setAuthLoad(false);}
    });
    return unsub;
  },[]);

  useEffect(function(){
    if(!user)return;
    var u1=fbListen(function(remote){
      if(remote.length===0&&user.role==="prof"){
        [{id:"demo1",tipo:"domanda",titolo:"Benvenuto in ScuolaBoard",testo:"Questa Ã¨ una card demo!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:1,commenti:[],links:[],visibile:true,classi:["TUTTE"]},
         {id:"demo2",tipo:"sondaggio",titolo:"Ti piace questa bacheca?",testo:"Vota!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:2,commenti:[],links:[],visibile:true,classi:["TUTTE"],opzioni:[{id:"o1",testo:"SÃ¬, molto!",voti:[]},{id:"o2",testo:"CosÃ¬ cosÃ¬",voti:[]},{id:"o3",testo:"Da migliorare",voti:[]}]}
        ].forEach(function(c){fbSave(c);});
      }else{
        nextOrd.current=Math.max.apply(null,remote.map(function(c){return c.ordine||0;}).concat([0]))+1;
        setCards(remote);
        setSC(function(prev){return prev?remote.find(function(c){return c.id===prev.id;})||null:null;});
      }
    });
    // Carica AI results solo per prof
    var u2=null;
    if(user.role==="prof"){u2=aiLoadAll(setAiMap);}
    return function(){u1();if(u2)u2();};
  },[user]);

  async function loginGoogle(){
    try{
      var provider=new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:"select_account"});
      var cr=await auth.signInWithPopup(provider);
      var fu=cr.user,ud=await db.collection("users").doc(fu.uid).get();
      if(!ud.exists){var np=(fu.displayName||"").split(" ");await db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google"});}
    }catch(e){if(e.code==="auth/popup-blocked"){try{await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());}catch(e2){}}}
  }
  function logout(){auth.signOut();setUser(null);localStorage.removeItem("groq_key");}

  function saveClasse(){
    if(!classeInput)return;
    db.collection("users").doc(user.uid).update({classe:classeInput}).then(function(){
      setUser(function(u){return Object.assign({},u,{classe:classeInput});});
      setShowClasseModal(false);
    });
  }
  function loadStudenti(){
    db.collection("users").where("role","==","studente").get().then(function(snap){
      var arr=[];snap.forEach(function(d){arr.push(Object.assign({uid:d.id},d.data()));});
      arr.sort(function(a,b){return(a.cognome||"").localeCompare(b.cognome||"","it");});
      setStudenti(arr);
    });
  }
  function aggiornaClasseStudente(uid,cl){
    db.collection("users").doc(uid).update({classe:cl||null}).then(function(){
      setStudenti(function(prev){return prev.map(function(s){return s.uid===uid?Object.assign({},s,{classe:cl||null}):s;});});
    });
  }
  function rimuoviStudente(uid){
    if(!window.confirm("Rimuovere?"))return;
    db.collection("users").doc(uid).update({classe:null}).then(function(){
      setStudenti(function(prev){return prev.map(function(s){return s.uid===uid?Object.assign({},s,{classe:null}):s;});});
    });
  }

  function toggleVisibile(card,e){e.stopPropagation();fbSave(Object.assign({},card,{visibile:card.visibile===false}));}

  function onDragStart(e,id){dragId.current=id;e.dataTransfer.effectAllowed="move";setTimeout(function(){var el=document.getElementById("card-"+id);if(el)el.classList.add("dragging");},0);}
  function onDragEnd(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("dragging");document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});}
  function onDragOver(e,id){e.preventDefault();if(String(dragId.current)===String(id))return;var el=document.getElementById("card-"+id);if(el)el.classList.add("drag-over");}
  function onDragLeave(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("drag-over");}
  function onDrop(e,targetId){
    e.preventDefault();document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});
    var fromId=dragId.current;if(!fromId||String(fromId)===String(targetId))return;
    var arr=cards.slice().sort(function(a,b){return(a.ordine||0)-(b.ordine||0);});
    var fi=arr.findIndex(function(c){return String(c.id)===String(fromId);});
    var ti=arr.findIndex(function(c){return String(c.id)===String(targetId);});
    if(fi<0||ti<0)return;
    var moved=arr.splice(fi,1)[0];arr.splice(ti,0,moved);
    arr.forEach(function(c,i){fbSave(Object.assign({},c,{ordine:i+1}));});
    dragId.current=null;
  }

  function apriDuplica(card,e){e.stopPropagation();setShowDuplica(card);setDuplicaClassi([]);}
  function confermaDuplica(){
    if(!showDuplica||!duplicaClassi.length)return;
    var orig=showDuplica;
    duplicaClassi.forEach(function(cl){
      var newId=Date.now()+"_"+Math.random().toString(36).slice(2,7);
      var copia=Object.assign({},orig,{id:newId,classi:[cl],ordine:nextOrd.current++,commenti:[],likes:0,data:new Date().toISOString().slice(0,10),titolo:orig.titolo+" ["+cl+"]"});
      if(orig.opzioni&&Array.isArray(orig.opzioni)){copia.opzioni=orig.opzioni.map(function(o){return Object.assign({},o,{voti:[]});});}
      else{delete copia.opzioni;}
      fbSave(copia);
    });
    setShowDuplica(null);setDuplicaClassi([]);
  }

  var totC=cards.reduce(function(a,c){return a+(c.commenti||[]).length;},0);
  var proposte=cards.filter(function(c){return c.proposta;});
  var isProf=user&&user.role==="prof";
  var simulaSt=isProf&&previewSt;

  var visible=cards.filter(function(c){
    if(simulaSt||!isProf){
      if(c.proposta||c.visibile===false)return false;
      var cc=c.classi||["TUTTE"];
      if(cc.length===0)return false;
      var stClasse=user&&user.classe;
      if(!stClasse)return cc.indexOf("TUTTE")>=0;
      return cc.indexOf("TUTTE")>=0||cc.indexOf(stClasse)>=0;
    }
    if(filterClasse!=="tutte"){
      var cc=c.classi||["TUTTE"];
      if(cc.indexOf("TUTTE")<0&&cc.indexOf(filterClasse)<0)return false;
    }
    return true;
  });

  function addCard(){
    if(!form.titolo.trim()||!user)return;
    var opzioni=null;
    if(form.tipo==="sondaggio")opzioni=form.opzioni.filter(function(o){return o.trim();}).map(function(o,i){return{id:"o"+Date.now()+"_"+i,testo:o,voti:[]};});
    var cleanLinks=(form.links||[]).filter(function(l){return l.url&&l.url.trim();}).map(function(l){return{url:l.url.trim(),label:(l.label||"").trim()};});
    var classiSalvate=form.classi&&form.classi.length?form.classi:[];
    if(editMode){
      var c=Object.assign({},editMode,{tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),links:cleanLinks,linkEsterno:null,classi:classiSalvate});
      if(opzioni)c.opzioni=opzioni;fbSave(c);setEditMode(null);
    }else{
      var c={id:Date.now(),tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),data:new Date().toISOString().slice(0,10),autore:myName(user),likes:0,commenti:[],ordine:nextOrd.current++,links:cleanLinks,linkEsterno:null,visibile:true,_token:isProf?PROF_TOKEN:null,classi:classiSalvate};
      if(opzioni)c.opzioni=opzioni;
      if(!isProf){c.proposta=true;if(user.classe)c.classi=[user.classe];}
      fbSave(c);
    }
    setSM(false);setForm(Object.assign({},FORM0));
  }
  function editCard(card){
    setEditMode(card);
    var links=normalizeLinks(card);
    setForm({tipo:card.tipo,titolo:card.titolo,testo:card.testo||"",opzioni:card.opzioni?card.opzioni.map(function(o){return o.testo;}):["",""],links:links.length?links:[{url:"",label:""}],classi:card.classi||["TUTTE"]});
    setSM(true);
  }
  function delCard(id){setConfirmDel({type:"card",id:id});}
  function appCard(id){var c=cards.find(function(x){return x.id===id;});if(c)fbSave(Object.assign({},c,{proposta:false}));}
  function toggleLike(cardId){
    var card=cards.find(function(c){return c.id===cardId;});if(!card)return;
    var key=String(cardId),liked=myLikes.current.has(key);
    liked?myLikes.current.delete(key):myLikes.current.add(key);
    fbSave(Object.assign({},card,{likes:(card.likes||0)+(liked?-1:1)}));
  }
  function vote(cid,oid){
    if(!user)return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    var vn=myName(user);
    fbSave(Object.assign({},card,{opzioni:card.opzioni.map(function(o){var voti=o.voti.filter(function(v){return v!==vn;});if(o.id===oid)voti=voti.concat([vn]);return Object.assign({},o,{voti:voti});})}));
  }
  function addCom(){
    if(!user||!nc.testo.trim())return;
    var card=cards.find(function(c){return c.id===showCard.id;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:(card.commenti||[]).concat([{id:Date.now(),autore:myName(user),testo:nc.testo.trim(),data:new Date().toISOString().slice(0,10),risposte:[]}])}));
    setNc({testo:""});
  }
  function addReply(cmId){
    if(!user||!replyTesto.trim())return;
    var card=cards.find(function(c){return String(c.id)===String(showCard.id);});if(!card)return;
    var nuova={id:Date.now(),autore:myName(user),testo:replyTesto.trim(),data:new Date().toISOString().slice(0,10),risposte:[]};
    function ins(lista){return lista.map(function(item){if(String(item.id)===String(cmId))return Object.assign({},item,{risposte:(item.risposte||[]).concat([nuova])});if(item.risposte&&item.risposte.length)return Object.assign({},item,{risposte:ins(item.risposte)});return item;});}
    fbSave(Object.assign({},card,{commenti:ins(card.commenti)}));
    setReplyTo(null);setReplyTesto("");
  }
  function executeDelReply(cmId,rId,cardId){
    var card=cards.find(function(c){return String(c.id)===String(cardId);});if(!card)return;
    function rem(lista){return lista.map(function(item){if(String(item.id)===String(cmId))return Object.assign({},item,{risposte:(item.risposte||[]).filter(function(r){return String(r.id)!==String(rId);})});if(item.risposte&&item.risposte.length)return Object.assign({},item,{risposte:rem(item.risposte)});return item;});}
    fbSave(Object.assign({},card,{commenti:rem(card.commenti)}));
  }
  function executeDelCom(cid,cmid){var card=cards.find(function(c){return c.id===cid;});if(!card)return;fbSave(Object.assign({},card,{commenti:card.commenti.filter(function(cm){return cm.id!==cmid;})}));}
  function saveEditCm(cid){
    if(!editingCm||!editingCm.testo.trim())return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:card.commenti.map(function(cm){return cm.id===editingCm.id?Object.assign({},cm,{testo:editingCm.testo.trim(),modificato:true}):cm;})}));
    setEditingCm(null);
  }
  function resetAll(){cards.forEach(function(c){fbDel(c.id);});setAiR(null);setSR(false);}
  function resetComments(){cards.forEach(function(c){if(c.commenti&&c.commenti.length>0)fbSave(Object.assign({},c,{commenti:[]}));});setShowResetOpt(false);}
  function resetVotes(){cards.forEach(function(c){if(c.opzioni)fbSave(Object.assign({},c,{opzioni:c.opzioni.map(function(o){return Object.assign({},o,{voti:[]});})}));});setShowResetOpt(false);}
  function resetSondaggio(cardId){var card=cards.find(function(c){return String(c.id)===String(cardId);});if(!card)return;var u=Object.assign({},card,{commenti:[]});if(u.opzioni)u.opzioni=u.opzioni.map(function(o){return Object.assign({},o,{voti:[]});});fbSave(u);}
  function saveAIKey(){if(akInput.trim()){localStorage.setItem("groq_key",akInput.trim());setOrKey(akInput.trim());setAskKey(false);setAkInput("");}}

  // â”€â”€ AI analisi globale â”€â”€
  function runAI(){
    if(!orKey){setAskKey(true);return;}
    setAiLoad(true);setAiR(null);setAiErr("");
    var target=aiTarget==="tutte"?cards.filter(function(c){return !c.proposta;}):[cards.find(function(c){return String(c.id)===String(aiTarget);})].filter(Boolean);
    if(!target.length){setAiErr("Nessuna card.");setAiLoad(false);return;}
    var det=target.map(function(c){return "CARD: \""+c.titolo+"\"\n"+buildCardContext(c);}).join("\n\n---\n\n");
    var prompt='Sei un assistente pedagogico per un insegnante di Religione (scuola secondaria II grado).\nAnalizza SOLO i dati reali. Non inventare.\nRispondi con JSON:\n{"riepilogo":"...","dibattito":"...","punti_chiave":["..."],
