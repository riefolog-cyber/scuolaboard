<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ScuolaBoard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#1a1a2e}
textarea,input,select,button{font-family:inherit}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes fadein{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pulse{animation:pulse 2s infinite}
.fadein{animation:fadein .3s ease}
.card-wrap{transition:opacity .2s,transform .2s}
.card-wrap.dragging{opacity:.35;transform:scale(.97)}
.card-wrap.drag-over{outline:2px dashed #6366f1;border-radius:16px;outline-offset:2px}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
(function(){
firebase.initializeApp({
  apiKey:"AIzaSyDIC39upI9VnY10MdP7__7l3omyGqspHNA",
  authDomain:"scuolaboard-874d4.firebaseapp.com",
  projectId:"scuolaboard-874d4",
  storageBucket:"scuolaboard-874d4.firebasestorage.app",
  messagingSenderId:"249372381209",
  appId:"1:249372381209:web:737697d4d10b3ae06eda88",
  measurementId:"G-04VJPEXN5Q"
});
var db=firebase.firestore(),auth=firebase.auth();
var h=React.createElement,useState=React.useState,useEffect=React.useEffect,useRef=React.useRef,Fragment=React.Fragment;
var PROF_TOKEN="sb_prof_2025_xK9mNpQr";
var FORM0={tipo:"domanda",titolo:"",testo:"",opzioni:["",""],links:[{url:"",label:""}]};

function fmt(d){return new Date(d).toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"});}
function isNew(d){return Date.now()-new Date(d).getTime()<86400000;}
function badgeBg(t){return t==="domanda"?"#6366f1":t==="nota"?"#f59e0b":t==="sondaggio"?"#22c55e":"#94a3b8";}
function tipoIcon(t){return t==="domanda"?"üí¨":t==="nota"?"üìÑ":t==="sondaggio"?"üó≥Ô∏è":"üìå";}
function fbSave(c){return db.collection("cards").doc(String(c.id)).set(c);}
function fbDel(id){return db.collection("cards").doc(String(id)).delete();}
function fbListen(cb){return db.collection("cards").orderBy("ordine","asc").onSnapshot(function(s){var a=[];s.forEach(function(d){a.push(d.data());});cb(a);});}
function normalizeLinks(c){
  if(c.links&&Array.isArray(c.links))return c.links;
  if(c.linkEsterno&&typeof c.linkEsterno==="string")return[{url:c.linkEsterno,label:""}];
  return[];
}

// ‚îÄ‚îÄ AI: Groq API (free, 30 req/min, no 429) ‚îÄ‚îÄ
// Modelli gratuiti Groq in ordine di qualit√†
var GROQ_MODELS=["llama-3.3-70b-versatile","llama3-70b-8192","llama3-8b-8192","mixtral-8x7b-32768"];
function callAI(k,prompt,mx){
  mx=mx||600;
  if(!k)return Promise.reject(new Error("Chiave Groq non impostata."));
  return _callGroq(k,prompt,mx,0);
}
function _callGroq(k,prompt,mx,mIdx){
  if(mIdx>=GROQ_MODELS.length)return Promise.reject(new Error("Nessun modello Groq disponibile. Verifica la chiave su console.groq.com"));
  var model=GROQ_MODELS[mIdx];
  return fetch("https://api.groq.com/openai/v1/chat/completions",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+k},
    body:JSON.stringify({
      model:model,
      max_tokens:mx,
      temperature:0.7,
      messages:[
        {role:"system",content:"Sei un assistente pedagogico italiano. Rispondi ESCLUSIVAMENTE con un oggetto JSON valido. Nessun testo prima o dopo. Nessun markdown. Nessun backtick. Solo JSON puro."},
        {role:"user",content:prompt}
      ]
    })
  }).then(function(r){
    if(r.status===429||r.status===503)return _callGroq(k,prompt,mx,mIdx+1);
    if(!r.ok)return r.json().then(function(e){throw new Error(e.error&&e.error.message||"Errore Groq "+r.status);});
    return r.json();
  }).then(function(d){
    if(!d||!d.choices||!d.choices[0]||!d.choices[0].message)return _callGroq(k,prompt,mx,mIdx+1);
    var raw=(d.choices[0].message.content||"").trim();
    raw=raw.replace(/^```(?:json)?[\r\n]*/i,"").replace(/[\r\n]*```$/,"").trim();
    var match=raw.match(/\{[\s\S]*\}/);
    if(!match)return _callGroq(k,prompt,mx,mIdx+1);
    try{return JSON.parse(match[0]);}catch(e){return _callGroq(k,prompt,mx,mIdx+1);}
  });
}

var S={
  input:{width:"100%",padding:"8px 10px",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,fontSize:13,background:"rgba(255,255,255,.08)",color:"#f1f5f9"},
  filterBtn:function(a){return{display:"flex",alignItems:"center",gap:4,padding:"5px 12px",borderRadius:20,border:"1px solid "+(a?"#6366f1":"rgba(255,255,255,.15)"),background:a?"#6366f1":"rgba(255,255,255,.05)",color:a?"#fff":"rgba(255,255,255,.6)",fontSize:12,fontWeight:700,cursor:"pointer"};}
};

function renderLinks(card){
  var links=normalizeLinks(card);
  if(!links.length)return null;
  return h("div",{style:{marginTop:8,display:"flex",flexDirection:"column",gap:5}},
    links.map(function(l,i){
      if(!l.url)return null;
      return h("a",{key:i,href:l.url,target:"_blank",rel:"noopener noreferrer",
        style:{display:"inline-flex",alignItems:"center",gap:6,background:"rgba(59,130,246,.15)",color:"#60a5fa",padding:"5px 10px",borderRadius:7,textDecoration:"none",fontSize:11,fontWeight:600,border:"1px solid rgba(59,130,246,.3)"}},
        "üîó "+(l.label||"Approfondisci"));
    })
  );
}

function App(){
  var isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  var [user,setUser]=useState(null);
  var [authLoad,setAuthLoad]=useState(true);
  var [cards,setCards]=useState([]);
  var [filtro,setFiltro]=useState("tutti");
  var [view,setView]=useState("bacheca");
  var [previewSt,setPreviewSt]=useState(false);
  var [showModal,setSM]=useState(false);
  var [showCard,setSC]=useState(null);
  var cmTextareaRef=useRef(null);
  var [showQR,setSQR]=useState(false);
  var [showReset,setSR]=useState(false);
  var [form,setForm]=useState(Object.assign({},FORM0));
  var [editMode,setEditMode]=useState(null);
  var [nc,setNc]=useState({testo:""});
  var [editingCm,setEditingCm]=useState(null);
  var [replyTo,setReplyTo]=useState(null);
  var [replyTesto,setReplyTesto]=useState("");
  var [confirmDel,setConfirmDel]=useState(null);
  var [showResetOpt,setShowResetOpt]=useState(false);
  var [orKey,setOrKey]=useState(localStorage.getItem("groq_key")||"");
  var [askKey,setAskKey]=useState(false);
  var [akInput,setAkInput]=useState("");
  var [aiLoad,setAiLoad]=useState(false);
  var [aiResult,setAiR]=useState(null);
  var [aiTarget,setAIT]=useState("tutte");
  var [cardAiLoad,setCardAIL]=useState(null);
  var [cardAiRes,setCardAiRes]=useState({});
  var [cardAiOpen,setCardAiOpen]=useState(null);
  var [aiErr,setAiErr]=useState("");
  var myLikes=useRef(new Set());
  var nextOrd=useRef(100);
  var dragId=useRef(null);

  function myName(u){return u?(u.role==="prof"?"Prof":(u.nome+" "+u.cognome).trim()||u.email):"?";}

  useEffect(function(){
    auth.getRedirectResult().then(function(cr){
      if(!cr||!cr.user)return;
      var fu=cr.user;
      db.collection("users").doc(fu.uid).get().then(function(ud){
        if(!ud.exists){
          var np=(fu.displayName||"").split(" ");
          return db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google",lastLogin:firebase.firestore.FieldValue.serverTimestamp()});
        }
      }).catch(function(e){console.error("Firestore user save:",e);});
    }).catch(function(e){
      console.error("Redirect result:",e);
    });

    var unsub=auth.onAuthStateChanged(function(fu){
      if(fu){
        db.collection("users").doc(fu.uid).get().then(function(doc){
          var base={uid:fu.uid,email:fu.email,displayName:fu.displayName,photoURL:fu.photoURL};
          if(doc.exists){var d=doc.data();setUser(Object.assign({},base,{role:d.role||"studente",nome:d.nome||fu.displayName?.split(" ")[0]||"Utente",cognome:d.cognome||fu.displayName?.split(" ").slice(1).join(" ")||""}));}
          else{setUser(Object.assign({},base,{role:"studente",nome:fu.displayName?.split(" ")[0]||"Utente",cognome:fu.displayName?.split(" ").slice(1).join(" ")||""}));}
          setAuthLoad(false);
        }).catch(function(){setAuthLoad(false);});
      }else{setUser(null);setAuthLoad(false);}
    });
    return unsub;
  },[]);

  useEffect(function(){
    if(!user)return;
    var unsub=fbListen(function(remote){
      if(remote.length===0){
        if(user.role==="prof"){
          [{id:"demo1",tipo:"domanda",titolo:"Benvenuto in ScuolaBoard",testo:"Questa √® una card demo!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:1,commenti:[],links:[],visibile:true},
           {id:"demo2",tipo:"sondaggio",titolo:"Ti piace questa bacheca?",testo:"Vota!",data:new Date().toISOString().slice(0,10),autore:"Prof",_token:PROF_TOKEN,likes:0,ordine:2,commenti:[],links:[],visibile:true,opzioni:[{id:"o1",testo:"S√¨, molto!",voti:[]},{id:"o2",testo:"Cos√¨ cos√¨",voti:[]},{id:"o3",testo:"Da migliorare",voti:[]}]}
          ].forEach(function(c){fbSave(c);});
        }
      }else{
        nextOrd.current=Math.max.apply(null,remote.map(function(c){return c.ordine||0;}).concat([0]))+1;
        setCards(remote);
        setSC(function(prev){return prev?remote.find(function(c){return c.id===prev.id;})||null:null;});
      }
    });
    return unsub;
  },[user]);

  async function loginGoogle(){
    try{
      var provider=new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:"select_account"});
      var cr=await auth.signInWithPopup(provider);
      var fu=cr.user,ud=await db.collection("users").doc(fu.uid).get();
      if(!ud.exists){
        var np=(fu.displayName||"").split(" ");
        await db.collection("users").doc(fu.uid).set({nome:np[0]||"Utente",cognome:np.slice(1).join(" ")||"",email:fu.email,role:"studente",provider:"google",lastLogin:firebase.firestore.FieldValue.serverTimestamp()});
      }
    }catch(e){
      console.error("Login error:",e.code,e.message);
      if(e.code==="auth/popup-blocked"){
        try{
          await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
        }catch(e2){console.error("Redirect fallback error:",e2);}
      }
    }
  }
  function logout(){auth.signOut();setUser(null);localStorage.removeItem("groq_key");}

  function toggleVisibile(card,e){e.stopPropagation();fbSave(Object.assign({},card,{visibile:card.visibile===false}));}

  function onDragStart(e,id){dragId.current=id;e.dataTransfer.effectAllowed="move";setTimeout(function(){var el=document.getElementById("card-"+id);if(el)el.classList.add("dragging");},0);}
  function onDragEnd(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("dragging");document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});}
  function onDragOver(e,id){e.preventDefault();e.dataTransfer.dropEffect="move";if(String(dragId.current)===String(id))return;var el=document.getElementById("card-"+id);if(el)el.classList.add("drag-over");}
  function onDragLeave(e,id){var el=document.getElementById("card-"+id);if(el)el.classList.remove("drag-over");}
  function onDrop(e,targetId){
    e.preventDefault();
    document.querySelectorAll(".drag-over").forEach(function(el){el.classList.remove("drag-over");});
    var fromId=dragId.current;
    if(!fromId||String(fromId)===String(targetId))return;
    var arr=cards.slice().sort(function(a,b){return(a.ordine||0)-(b.ordine||0);});
    var fi=arr.findIndex(function(c){return String(c.id)===String(fromId);});
    var ti=arr.findIndex(function(c){return String(c.id)===String(targetId);});
    if(fi<0||ti<0)return;
    var moved=arr.splice(fi,1)[0];
    arr.splice(ti,0,moved);
    arr.forEach(function(c,i){fbSave(Object.assign({},c,{ordine:i+1}));});
    dragId.current=null;
  }

  var totC=cards.reduce(function(a,c){return a+(c.commenti||[]).length;},0);
  var proposte=cards.filter(function(c){return c.proposta;});
  var isProf=user&&user.role==="prof";
  var simulaSt=isProf&&previewSt;

  var visible=cards.filter(function(c){
    if(simulaSt||!isProf){if(c.proposta||c.visibile===false)return false;}
    if(filtro!=="tutti"&&c.tipo!==filtro)return false;
    return true;
  });

  function addCard(){
    if(!form.titolo.trim()||!user)return;
    var opzioni=null;
    if(form.tipo==="sondaggio")
      opzioni=form.opzioni.filter(function(o){return o.trim();}).map(function(o,i){return{id:"o"+Date.now()+"_"+i,testo:o,voti:[]};});
    var autore=myName(user);
    var cleanLinks=(form.links||[]).filter(function(l){return l.url&&l.url.trim();}).map(function(l){return{url:l.url.trim(),label:(l.label||"").trim()};});
    if(editMode){
      var c=Object.assign({},editMode,{tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),links:cleanLinks,linkEsterno:null});
      if(opzioni)c.opzioni=opzioni;
      fbSave(c);setEditMode(null);
    }else{
      var c={id:Date.now(),tipo:form.tipo,titolo:form.titolo.trim(),testo:form.testo.trim(),data:new Date().toISOString().slice(0,10),autore:autore,likes:0,commenti:[],ordine:nextOrd.current++,links:cleanLinks,linkEsterno:null,visibile:true,_token:isProf?PROF_TOKEN:null};
      if(opzioni)c.opzioni=opzioni;
      if(!isProf)c.proposta=true;
      fbSave(c);
    }
    setSM(false);setForm(Object.assign({},FORM0));
  }

  function editCard(card){
    setEditMode(card);
    var links=normalizeLinks(card);
    setForm({tipo:card.tipo,titolo:card.titolo,testo:card.testo||"",opzioni:card.opzioni?card.opzioni.map(function(o){return o.testo;}):["",""],links:links.length?links:[{url:"",label:""}]});
    setSM(true);
  }
  
  function delCard(id){setConfirmDel({type:"card",id:id});}
  function confirmDelete(){
    if(!confirmDel)return;
    if(confirmDel.type==="card"){fbDel(confirmDel.id);setSC(null);}
    else if(confirmDel.type==="comment"){executeDelCom(confirmDel.cardId,confirmDel.id);}
    else if(confirmDel.type==="reply"){executeDelReply(confirmDel.cmId,confirmDel.id,confirmDel.cardId);}
    setConfirmDel(null);
  }
  
  function appCard(id){var c=cards.find(function(x){return x.id===id;});if(c)fbSave(Object.assign({},c,{proposta:false}));}

  function toggleLike(cardId){
    var card=cards.find(function(c){return c.id===cardId;});if(!card)return;
    var key=String(cardId),liked=myLikes.current.has(key);
    liked?myLikes.current.delete(key):myLikes.current.add(key);
    fbSave(Object.assign({},card,{likes:(card.likes||0)+(liked?-1:1)}));
  }

  function vote(cid,oid){
    if(!user)return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    var vn=myName(user);
    var newOpzioni=card.opzioni.map(function(o){
      var voti=o.voti.filter(function(v){return v!==vn;});
      if(o.id===oid)voti=voti.concat([vn]);
      return Object.assign({},o,{voti:voti});
    });
    fbSave(Object.assign({},card,{opzioni:newOpzioni}));
  }

  function addCom(){
    if(!user||!nc.testo.trim())return;
    var card=cards.find(function(c){return c.id===showCard.id;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:(card.commenti||[]).concat([{id:Date.now(),autore:myName(user),testo:nc.testo.trim(),data:new Date().toISOString().slice(0,10),risposte:[]}])}));
    setNc({testo:""});
  }
  
  function addReply(cmId){
    if(!user||!replyTesto.trim())return;
    var card=cards.find(function(c){return c.id===showCard.id;});if(!card)return;
    var nuova={id:Date.now(),autore:myName(user),testo:replyTesto.trim(),data:new Date().toISOString().slice(0,10)};
    fbSave(Object.assign({},card,{commenti:card.commenti.map(function(cm){
      return cm.id===cmId?Object.assign({},cm,{risposte:(cm.risposte||[]).concat([nuova])}):cm;
    })}));
    setReplyTo(null);setReplyTesto("");
  }
  
  function delReply(cmId,rId){
    setConfirmDel({type:"reply",cmId:cmId,id:rId,cardId:showCard.id});
  }
  
  function executeDelReply(cmId,rId,cardId){
    var card=cards.find(function(c){return c.id===cardId;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:card.commenti.map(function(cm){
      return cm.id===cmId?Object.assign({},cm,{risposte:(cm.risposte||[]).filter(function(r){return r.id!==rId;})}):cm;
    })}));
  }
  
  function delCom(cid,cmid){
    setConfirmDel({type:"comment",cardId:cid,id:cmid});
  }
  
  function executeDelCom(cid,cmid){
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:card.commenti.filter(function(cm){return cm.id!==cmid;})}));
  }
  
  function saveEditCm(cid){
    if(!editingCm||!editingCm.testo.trim())return;
    var card=cards.find(function(c){return c.id===cid;});if(!card)return;
    fbSave(Object.assign({},card,{commenti:card.commenti.map(function(cm){
      return cm.id===editingCm.id?Object.assign({},cm,{testo:editingCm.testo.trim(),modificato:true}):cm;
    })}));
    setEditingCm(null);
  }

  function resetAll(){cards.forEach(function(c){fbDel(c.id);});setAiR(null);setSR(false);}
  function resetComments(){
    cards.forEach(function(c){
      if(c.commenti&&c.commenti.length>0)fbSave(Object.assign({},c,{commenti:[]}));
    });
    setShowResetOpt(false);
  }
  function resetVotes(){
    cards.forEach(function(c){
      if(c.opzioni){
        fbSave(Object.assign({},c,{opzioni:c.opzioni.map(function(o){return Object.assign({},o,{voti:[]});})}));
      }
    });
    setShowResetOpt(false);
  }
  
  function resetSondaggio(cardId){
    var card=cards.find(function(c){return String(c.id)===String(cardId);});
    if(!card)return;
    var updated=Object.assign({},card,{commenti:[]});
    if(updated.opzioni&&Array.isArray(updated.opzioni)){
      updated.opzioni=updated.opzioni.map(function(o){return Object.assign({},o,{voti:[]});});
    }else{
      delete updated.opzioni;
    }
    fbSave(updated);
  }

  function saveAIKey(){if(akInput.trim()){localStorage.setItem("groq_key",akInput.trim());setOrKey(akInput.trim());setAskKey(false);setAkInput("");}}

  function runAI(){
    if(!orKey){setAskKey(true);return;}
    setAiLoad(true);setAiR(null);setAiErr("");
    var target=aiTarget==="tutte"?cards.filter(function(c){return !c.proposta;}):[cards.find(function(c){return String(c.id)===String(aiTarget);})].filter(Boolean);
    if(!target.length){setAiErr("Nessuna card selezionata.");setAiLoad(false);return;}

    var dettaglio=target.map(function(c){
      var riga="CARD: \""+c.titolo+"\" (tipo: "+c.tipo+", like: "+(c.likes||0)+")";
      if(c.testo)riga+="\nTesto: "+c.testo;
      if(c.tipo==="sondaggio"&&c.opzioni){
        var totV=c.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
        riga+="\nVoti totali: "+totV;
        c.opzioni.forEach(function(o){
          var pct=totV>0?Math.round(o.voti.length/totV*100):0;
          riga+="\n  - \""+o.testo+"\": "+o.voti.length+" voti ("+pct+"%)";
          if(o.voti.length)riga+=" ["+o.voti.join(", ")+"]";
        });
      }
      if(c.commenti&&c.commenti.length){
        riga+="\nCommenti ("+c.commenti.length+"):";
        c.commenti.forEach(function(cm){riga+="\n  - "+cm.autore+": \""+cm.testo+"\"";});
      }else{riga+="\nCommenti: nessuno";}
      return riga;
    }).join("\n\n---\n\n");

    var prompt='Sei un assistente pedagogico esperto che supporta un insegnante di Religione in una scuola secondaria di secondo grado.\n\nAnalizza ESCLUSIVAMENTE i dati reali delle card qui sotto. Non inventare nulla. Non aggiungere considerazioni generiche sulla religione o sulla didattica che non siano direttamente collegate a ci√≤ che gli studenti hanno scritto o votato.\n\nRispondi con un oggetto JSON con queste 4 chiavi:\n\n{\n  "riepilogo": "Descrizione puntuale e dettagliata di cosa hanno scritto e votato gli studenti, card per card. Cita esplicitamente i commenti pi√π significativi e i risultati dei sondaggi con le percentuali reali.",\n  "dibattito": "Analisi del tipo di interazione emersa nei commenti: c\'√® confronto di opinioni? accordo generale? posizioni contrastanti? chi ha partecipato di pi√π? quali idee si ripetono?",\n  "punti_chiave": ["punto concreto 1 emerso davvero dai dati", "punto concreto 2", "punto concreto 3", "punto concreto 4"],\n  "spunti_dibattito": ["Domanda o attivit√† concreta da usare in classe basata su ci√≤ che hanno scritto gli studenti 1", "spunto 2", "spunto 3"]\n}\n\nDATI REALI DELLE CARD:\n\n'+dettaglio.slice(0,2500);

    callAI(orKey,prompt,900)
      .then(function(r){
        if(r&&(r.riepilogo||r.dibattito))setAiR(r);
        else setAiErr("Risposta AI non valida. Riprova.");
      })
      .catch(function(e){setAiErr(e.message||"Errore AI.");})
      .then(function(){setAiLoad(false);});
  }

  function runCardAI(card,e){
    e.stopPropagation();
    if(!orKey){setAskKey(true);return;}
    setCardAIL(card.id);setCardAiOpen(card.id);
    setCardAiRes(function(p){return Object.assign({},p,{[card.id]:null});});

    var commTxt=(card.commenti||[]).length
      ?card.commenti.map(function(cm){return"  - "+cm.autore+": \""+cm.testo+"\"";}).join("\n")
      :"nessun commento";
    var votiTxt="";
    if(card.opzioni){
      var totV=card.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
      votiTxt="\nVoti totali: "+totV+"\n"+card.opzioni.map(function(o){
        var pct=totV>0?Math.round(o.voti.length/totV*100):0;
        return"  - \""+o.testo+"\": "+o.voti.length+" voti ("+pct+"%)";
      }).join("\n");
    }

    var prompt='Sei un assistente pedagogico esperto che supporta un insegnante di Religione.\n\nAnalizza SOLO i dati reali di questa card. Non inventare. Non generalizzare.\n\nRispondi con un oggetto JSON con queste 3 chiavi:\n\n{\n  "sintesi": "Cosa hanno scritto/votato DAVVERO gli studenti su questa card. Cita i commenti reali e le percentuali dei voti.",\n  "dinamica": "Come si sono confrontati gli studenti nei commenti: ci sono posizioni diverse? accordo? chi ha detto cosa di rilevante?",\n  "spunto": "Una domanda o attivit√† concreta da usare in classe, ispirata direttamente da ci√≤ che hanno scritto questi studenti (non generica)."\n}\n\nDATI REALI:\nTitolo: "'+card.titolo+'"\nTipo: '+card.tipo+'\nTesto: '+(card.testo||"(nessun testo)")+'\nLike: '+(card.likes||0)+votiTxt+'\nCommenti:\n'+commTxt;

    callAI(orKey,prompt,600)
      .then(function(r){setCardAiRes(function(p){return Object.assign({},p,{[card.id]:r||{error:"Risposta non valida"}});});})
      .catch(function(e){setCardAiRes(function(p){return Object.assign({},p,{[card.id]:{error:e.message}});});})
      .then(function(){setCardAIL(null);});
  }

  var qrUrl="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data="+encodeURIComponent(window.location.href);

  if(authLoad)return h("div",{style:{minHeight:"100vh",background:"linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}},
    h("div",{style:{width:48,height:48,border:"3px solid rgba(255,255,255,.2)",borderTop:"3px solid #6366f1",borderRadius:"50%",animation:"spin 1s linear infinite"}}),
    h("div",{style:{color:"rgba(255,255,255,.8)",fontWeight:700,fontSize:16,letterSpacing:2}},"SCUOLABOARD")
  );

  if(!user)return h("div",{style:{minHeight:"100vh",background:"linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)",display:"flex",alignItems:"center",justifyContent:"center",padding:20}},
    h("div",{style:{background:"rgba(255,255,255,.05)",backdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,.1)",borderRadius:24,padding:36,width:"100%",maxWidth:420,textAlign:"center"}},
      h("div",{style:{fontSize:48,marginBottom:12}},"üéì"),
      h("h1",{style:{margin:"0 0 4px",color:"#fff",fontSize:24,fontWeight:800,letterSpacing:1}},"ScuolaBoard"),
      h("p",{style:{margin:"0 0 28px",color:"rgba(255,255,255,.5)",fontSize:13}},"Bacheca digitale interattiva con AI"),
      h("button",{onClick:loginGoogle,style:{padding:14,background:"#fff",border:"1px solid rgba(0,0,0,.1)",borderRadius:14,cursor:"pointer",fontSize:15,fontWeight:700,color:"#333",display:"flex",alignItems:"center",justifyContent:"center",gap:8,width:"100%"}},
        h("img",{src:"https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg",width:20,height:20,alt:"G"}),"Accedi con Google"),
      h("div",{style:{margin:"16px 0",color:"rgba(255,255,255,.3)",fontSize:12}},"üîí Accesso sicuro ‚Äì su mobile verr√† reindirizzato a Google"),
      h("div",{style:{background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.2)",borderRadius:10,padding:12,textAlign:"left"}},
        h("div",{style:{fontSize:11,color:"rgba(255,255,255,.5)",lineHeight:1.5}},"üìù Dopo il primo accesso, contatta l'amministratore per il ruolo 'prof' su Firestore.")
      )
    )
  );

  return h("div",{style:{minHeight:"100vh",background:"linear-gradient(160deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)",display:"flex",flexDirection:"column"}},

    h("div",{style:{background:"rgba(255,255,255,.04)",backdropFilter:"blur(12px)",borderBottom:"1px solid rgba(255,255,255,.08)",padding:"8px 14px",display:"flex",alignItems:"center",gap:8,position:"sticky",top:0,zIndex:50,flexWrap:"wrap"}},
      h("span",{style:{fontWeight:900,fontSize:16,color:"#fff",letterSpacing:2}},"SCUOLA"),
      h("span",{style:{fontWeight:900,fontSize:16,color:"#6366f1",letterSpacing:2}},"BOARD"),
      h("span",{style:{background:isProf?"rgba(99,102,241,.2)":"rgba(34,197,94,.15)",color:isProf?"#a5b4fc":"#4ade80",borderRadius:20,padding:"2px 9px",fontSize:11,fontWeight:700,display:"flex",alignItems:"center",gap:4}},
        user.photoURL&&h("img",{src:user.photoURL,alt:"",style:{width:16,height:16,borderRadius:"50%"}}),
        isProf?"üë®‚Äçüè´ Prof":"üéí "+user.nome
      ),
      simulaSt&&h("span",{style:{background:"rgba(249,115,22,.25)",color:"#fb923c",border:"1px solid rgba(249,115,22,.5)",borderRadius:20,padding:"2px 10px",fontSize:11,fontWeight:800}},"üëÅÔ∏è VISTA STUDENTE"),
      h("div",{style:{flex:1}}),
      isProf&&h("button",{onClick:function(){setAskKey(true);},title:orKey?"Chiave Groq ‚úì":"Imposta chiave Groq",style:{background:orKey?"rgba(34,197,94,.15)":"rgba(249,115,22,.15)",border:"1px solid "+(orKey?"rgba(34,197,94,.3)":"rgba(249,115,22,.3)"),borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:12,color:orKey?"#4ade80":"#fb923c"}},orKey?"üîë":"‚ö†Ô∏è"),
      isProf&&h("button",{onClick:function(){setShowResetOpt(true);},style:{background:"rgba(255,255,255,.06)",border:"1px solid rgba(239,68,68,.3)",borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:14,color:"#f87171"}},"üóëÔ∏è"),
      h("button",{onClick:function(){setSQR(true);},style:{background:"rgba(255,255,255,.06)",border:"1px solid rgba(255,255,255,.1)",borderRadius:8,padding:"5px 9px",cursor:"pointer",fontSize:14,color:"rgba(255,255,255,.7)"}},"‚óÜ"),
      isProf&&h("button",{onClick:function(){setPreviewSt(function(v){return!v;});},style:{background:simulaSt?"rgba(249,115,22,.3)":"rgba(255,255,255,.07)",border:"1px solid "+(simulaSt?"rgba(249,115,22,.6)":"rgba(255,255,255,.15)"),borderRadius:8,padding:"5px 10px",cursor:"pointer",fontSize:12,fontWeight:700,color:simulaSt?"#fb923c":"rgba(255,255,255,.6)"}},simulaSt?"üîô Prof":"üëÅÔ∏è Studente"),
      isProf&&!simulaSt&&h("div",{style:{display:"flex",gap:2,background:"rgba(255,255,255,.05)",borderRadius:9,padding:3,border:"1px solid rgba(255,255,255,.08)"}},
        [{k:"bacheca",i:"üìå"},{k:"analisi",i:"ü§ñ"}].map(function(t){
          return h("button",{key:t.k,onClick:function(){setView(t.k);},style:{padding:"4px 11px",borderRadius:7,border:"none",background:view===t.k?"rgba(99,102,241,.4)":"transparent",color:view===t.k?"#fff":"rgba(255,255,255,.4)",fontWeight:700,cursor:"pointer",fontSize:13}},t.i);
        })
      ),
      !simulaSt&&h("button",{onClick:function(){setEditMode(null);setForm(Object.assign({},FORM0));setSM(true);},style:{background:"linear-gradient(135deg,#6366f1,#8b5cf6)",border:"none",borderRadius:20,width:34,height:34,cursor:"pointer",color:"#fff",fontSize:20,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800}},"+"),
      h("button",{onClick:logout,style:{background:"none",border:"1px solid rgba(255,255,255,.1)",borderRadius:7,padding:"4px 9px",cursor:"pointer",fontSize:11,color:"rgba(255,255,255,.3)"}},"Esci")
    ),

    (view==="bacheca"||simulaSt)&&h(Fragment,null,
      h("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:8,padding:"7px 14px",background:"rgba(255,255,255,.03)",borderBottom:"1px solid rgba(255,255,255,.06)",flexWrap:"wrap"}},
        h("span",{className:"pulse",style:{width:7,height:7,background:"#22c55e",borderRadius:"50%",display:"inline-block"}}),
        h("span",{style:{fontSize:11,fontWeight:800,letterSpacing:3,color:"rgba(255,255,255,.5)"}},"LIVE"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.3)"}},"‚Ä¢"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.4)"}},cards.filter(function(c){return !c.proposta;}).length+" card"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.3)"}},"‚Ä¢"),
        h("span",{style:{fontSize:11,color:"rgba(255,255,255,.4)"}},totC+" commenti"),
        isProf&&!simulaSt&&proposte.length>0&&h("span",{style:{background:"rgba(239,68,68,.2)",color:"#f87171",borderRadius:20,padding:"2px 8px",fontSize:11,fontWeight:800,border:"1px solid rgba(239,68,68,.3)"}},"‚è≥ "+proposte.length+" in attesa")
      ),
      isProf&&!simulaSt&&proposte.length>0&&h("div",{style:{padding:"10px 14px",background:"rgba(249,115,22,.06)",borderBottom:"1px solid rgba(249,115,22,.15)"}},
        h("div",{style:{fontWeight:700,color:"#fb923c",fontSize:11,marginBottom:7,letterSpacing:1}},"‚è≥ PROPOSTE IN ATTESA"),
        proposte.map(function(c){return h("div",{key:c.id,style:{background:"rgba(255,255,255,.04)",border:"1px solid rgba(249,115,22,.2)",borderRadius:9,padding:"8px 12px",marginBottom:5,display:"flex",alignItems:"center",gap:8}},
          h("span",{style:{flex:1,fontSize:13,color:"rgba(255,255,255,.8)",fontWeight:600}},h("span",{style:{fontSize:10,color:"#fb923c",fontWeight:800,marginRight:6,background:"rgba(249,115,22,.15)",padding:"1px 6px",borderRadius:10}},c.autore||"Studente"),c.titolo),
          h("button",{onClick:function(){appCard(c.id);},style:{background:"rgba(34,197,94,.2)",color:"#4ade80",border:"1px solid rgba(34,197,94,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:12,fontWeight:700}},"‚úì"),
          h("button",{onClick:function(){delCard(c.id);},style:{background:"rgba(239,68,68,.15)",color:"#f87171",border:"none",borderRadius:7,padding:"3px 8px",cursor:"pointer",fontSize:12,fontWeight:700}},"‚úï")
        );})
      ),

      h("div",{style:{flex:1,padding:"18px 14px"}},
        visible.length===0
          ?h("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"80px 20px",color:"rgba(255,255,255,.2)"}},h("div",{style:{fontSize:48,marginBottom:8}},"üìå"),h("div",{style:{fontWeight:600}},"Nessun contenuto"))
          :h("div",{style:{columns:"300px",columnGap:16}},
            visible.map(function(c){
              var totV=c.opzioni?c.opzioni.reduce(function(a,o){return a+o.voti.length;},0):0;
              var liked=myLikes.current.has(String(c.id));
              var cRes=cardAiRes[c.id],cOpen=cardAiOpen===c.id,cLoad=cardAiLoad===c.id;
              var cardLinks=normalizeLinks(c);
              var nascosta=c.visibile===false,nuova=isNew(c.data),isProp=c.proposta;
              return h("div",{
                id:"card-"+c.id,key:c.id,className:"card-wrap fadein",
                draggable:isProf&&!simulaSt,
                onDragStart:isProf&&!simulaSt?function(e){onDragStart(e,c.id);}:undefined,
                onDragEnd:isProf&&!simulaSt?function(e){onDragEnd(e,c.id);}:undefined,
                onDragOver:isProf&&!simulaSt?function(e){onDragOver(e,c.id);}:undefined,
                onDragLeave:isProf&&!simulaSt?function(e){onDragLeave(e,c.id);}:undefined,
                onDrop:isProf&&!simulaSt?function(e){onDrop(e,c.id);}:undefined,
                style:{breakInside:"avoid",marginBottom:16,background:nascosta?"rgba(255,255,255,.03)":"rgba(255,255,255,.06)",backdropFilter:"blur(10px)",border:"1px solid "+(nascosta?"rgba(255,255,255,.06)":"rgba(255,255,255,.1)"),borderRadius:16,overflow:"hidden",opacity:nascosta?0.5:1}
              },
                h("div",{style:{cursor:"pointer"},onClick:function(){setSC(c);setNc({testo:""});setEditingCm(null);}},
                  h("div",{style:{padding:"12px 14px 6px"}},
                    h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6,gap:4}},
                      h("div",{style:{display:"flex",gap:4,alignItems:"center",flexWrap:"wrap"}},
                        h("span",{style:{background:badgeBg(c.tipo),color:"#fff",borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:800}},tipoIcon(c.tipo)+" "+c.tipo.toUpperCase()),
                        nuova&&h("span",{style:{background:"rgba(34,197,94,.25)",color:"#4ade80",borderRadius:6,padding:"2px 6px",fontSize:9,fontWeight:800,border:"1px solid rgba(34,197,94,.4)"}},"NUOVO"),
                        isProp&&h("span",{style:{fontSize:9,fontWeight:700,color:"#fb923c"}},"‚è≥"),
                        nascosta&&isProf&&h("span",{style:{background:"rgba(239,68,68,.2)",color:"#f87171",borderRadius:6,padding:"2px 6px",fontSize:9,fontWeight:800}},"NASCOSTA")
                      ),
                      isProf&&!simulaSt&&h("span",{title:nascosta?"Rendi visibile":"Nascondi",style:{cursor:"pointer",fontSize:16},onClick:function(e){toggleVisibile(c,e);}},nascosta?"üö´":"üëÅÔ∏è")
                    ),
                    isProf&&!simulaSt&&h("div",{style:{fontSize:11,color:"rgba(255,255,255,.2)",marginBottom:4,cursor:"grab",userSelect:"none"}},"‚ò∞ trascina per riordinare"),
                    h("div",{style:{fontWeight:800,fontSize:13,color:nascosta?"rgba(255,255,255,.4)":"#f1f5f9",lineHeight:1.4,marginBottom:5}},c.titolo),
                    c.testo&&h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",lineHeight:1.5,overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"}},c.testo),
                    cardLinks.length>0&&h("div",{style:{marginTop:5,fontSize:10,color:"#60a5fa"}},"üîó "+cardLinks.length+" link"),
                    c.tipo==="sondaggio"&&c.opzioni&&h("div",{style:{marginTop:8}},
                      c.opzioni.map(function(o){
                        var pct=totV>0?Math.round(o.voti.length/totV*100):0;
                        return h("div",{key:o.id,style:{marginBottom:4}},
                          h("div",{style:{display:"flex",justifyContent:"space-between",fontSize:10,color:"rgba(255,255,255,.4)",marginBottom:2}},h("span",null,o.testo),h("span",null,pct+"%")),
                          h("div",{style:{height:3,background:"rgba(255,255,255,.1)",borderRadius:3}},h("div",{style:{height:3,background:"#6366f1",borderRadius:3,width:pct+"%"}}))
                        );
                      }).concat([h("div",{key:"voti",style:{fontSize:9,color:"rgba(255,255,255,.3)",marginTop:3}},totV+" voti")])
                    )
                  )
                ),
                h("div",{style:{padding:"6px 14px 10px",display:"flex",alignItems:"center",gap:6}},
                  h("button",{onClick:function(e){e.stopPropagation();toggleLike(c.id);},style:{background:liked?"rgba(99,102,241,.3)":"rgba(255,255,255,.08)",border:"1px solid "+(liked?"rgba(99,102,241,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"3px 8px",cursor:"pointer",fontSize:12,color:liked?"#a5b4fc":"rgba(255,255,255,.5)",display:"flex",alignItems:"center",gap:4}},
                    "üëç",h("span",{style:{fontSize:11,fontWeight:700}},c.likes||0)
                  ),
                  h("button",{onClick:function(e){
                    e.stopPropagation();
                    setSC(c);setNc({testo:""});setEditingCm(null);
                    setTimeout(function(){
                      var ta=document.getElementById("cm-textarea");
                      if(ta){ta.scrollIntoView({behavior:"smooth",block:"center"});ta.focus();}
                    },150);
                  },style:{background:"rgba(99,102,241,.15)",border:"1px solid rgba(99,102,241,.3)",borderRadius:20,padding:"3px 10px",cursor:"pointer",fontSize:12,color:"#a5b4fc",display:"flex",alignItems:"center",gap:4,fontWeight:700}},
                    "üí¨ Commenta",h("span",{style:{fontSize:11,background:"rgba(99,102,241,.3)",borderRadius:10,padding:"0 5px",marginLeft:2}},(c.commenti||[]).length||"0")
                  ),
                  h("span",{style:{flex:1}}),
                  h("span",{style:{fontSize:10,color:"rgba(255,255,255,.3)"}},fmt(c.data)),
                  isProf&&!simulaSt&&h("button",{onClick:function(e){e.stopPropagation();editCard(c);},style:{background:"rgba(59,130,246,.2)",border:"1px solid rgba(59,130,246,.4)",borderRadius:20,padding:"3px 9px",cursor:"pointer",fontSize:11,color:"#60a5fa",fontWeight:700}},"‚úèÔ∏è"),
                  isProf&&!simulaSt&&h("button",{onClick:function(e){runCardAI(c,e);},style:{background:cOpen?"rgba(99,102,241,.4)":"rgba(99,102,241,.18)",border:"1px solid rgba(99,102,241,.4)",borderRadius:20,padding:"3px 11px",cursor:"pointer",fontSize:11,color:"#a5b4fc",fontWeight:700,display:"flex",alignItems:"center",gap:4}},
                    cLoad?h("span",{style:{display:"inline-block",animation:"spin 1s linear infinite"}},"‚öôÔ∏è"):"ü§ñ",h("span",null,cLoad?"‚Ä¶":"AI")
                  )
                ),
                isProf&&!simulaSt&&cOpen&&h("div",{style:{borderTop:"1px solid rgba(99,102,241,.25)",background:"rgba(30,30,60,.7)",padding:"10px 14px"}},
                  cLoad&&h("div",{style:{textAlign:"center",padding:"8px 0",color:"rgba(255,255,255,.4)",fontSize:12}},"‚öôÔ∏è Analisi in corso‚Ä¶"),
                  !cLoad&&cRes&&!cRes.error&&h(Fragment,null,
                    cRes.sintesi&&h("div",{style:{marginBottom:8}},
                      h("div",{style:{fontSize:9,fontWeight:800,color:"#a5b4fc",letterSpacing:1,marginBottom:3}},"üìã SINTESI"),
                      h("div",{style:{fontSize:11,color:"rgba(255,255,255,.8)",lineHeight:1.6,whiteSpace:"pre-wrap"}},cRes.sintesi)
                    ),
                    cRes.dinamica&&h("div",{style:{marginBottom:8}},
                      h("div",{style:{fontSize:9,fontWeight:800,color:"#93c5fd",letterSpacing:1,marginBottom:3}},"üí¨ DINAMICA"),
                      h("div",{style:{fontSize:11,color:"rgba(255,255,255,.75)",lineHeight:1.6}},cRes.dinamica)
                    ),
                    cRes.commento_classe&&!cRes.dinamica&&h("div",{style:{marginBottom:8}},
                      h("div",{style:{fontSize:9,fontWeight:800,color:"#4ade80",letterSpacing:1,marginBottom:3}},"üë• CLASSE"),
                      h("div",{style:{fontSize:11,color:"rgba(255,255,255,.7)",lineHeight:1.6}},cRes.commento_classe)
                    ),
                    cRes.spunto&&h("div",{style:{background:"rgba(34,197,94,.08)",borderRadius:7,padding:"7px 10px",border:"1px solid rgba(34,197,94,.15)"}},
                      h("div",{style:{fontSize:9,fontWeight:800,color:"#4ade80",letterSpacing:1,marginBottom:3}},"üí° SPUNTO PER IL DIBATTITO"),
                      h("div",{style:{fontSize:11,color:"rgba(255,255,255,.8)",lineHeight:1.6,fontStyle:"italic"}},cRes.spunto)
                    )
                  ),
                  !cLoad&&cRes&&cRes.error&&h("div",{style:{color:"#f87171",fontSize:11}},cRes.error),
                  !cLoad&&!cRes&&h("div",{style:{color:"rgba(255,255,255,.3)",fontSize:11,textAlign:"center"}},"Premi ü§ñ AI per avviare"),
                  h("button",{onClick:function(e){e.stopPropagation();setCardAiOpen(null);},style:{marginTop:8,background:"none",border:"none",color:"rgba(255,255,255,.3)",fontSize:10,cursor:"pointer"}},"‚úï chiudi")
                )
              );
            })
          )
      )
    ),

    view==="analisi"&&isProf&&!simulaSt&&h("div",{style:{flex:1,padding:"18px 14px",maxWidth:820,margin:"0 auto",width:"100%"}},
      h("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginBottom:16}},
        [{l:"Card",v:cards.length,i:"üìå",c:"#6366f1"},{l:"Domande",v:cards.filter(function(c){return c.tipo==="domanda";}).length,i:"üí¨",c:"#8b5cf6"},
         {l:"Note",v:cards.filter(function(c){return c.tipo==="nota";}).length,i:"üìÑ",c:"#f59e0b"},{l:"Sondaggi",v:cards.filter(function(c){return c.tipo==="sondaggio";}).length,i:"üó≥Ô∏è",c:"#22c55e"},
         {l:"Commenti",v:totC,i:"‚úèÔ∏è",c:"#ef4444"}].map(function(s){
          return h("div",{key:s.l,style:{flex:1,minWidth:90,background:"rgba(255,255,255,.05)",borderRadius:11,padding:"10px 12px",border:"1px solid rgba(255,255,255,.08)",borderTop:"3px solid "+s.c}},
            h("div",{style:{fontSize:18}},s.i),h("div",{style:{fontSize:22,fontWeight:800,color:"#f1f5f9"}},s.v),h("div",{style:{fontSize:10,color:"rgba(255,255,255,.4)"}},s.l));
        })
      ),
      h("div",{style:{background:"rgba(255,255,255,.05)",borderRadius:11,padding:16,border:"1px solid rgba(255,255,255,.08)"}},
        h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:8}},
          h("div",{style:{fontWeight:700,color:"#f1f5f9",fontSize:14}},"ü§ñ Analisi AI globale"),
          h("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}},
            h("select",{value:aiTarget,onChange:function(e){setAIT(e.target.value);setAiR(null);setAiErr("");},style:{padding:"5px 10px",border:"1px solid rgba(255,255,255,.15)",borderRadius:8,fontSize:12,color:"#f1f5f9",background:"rgba(30,41,59,1)",maxWidth:220}},
              h("option",{value:"tutte"},"üìã Tutte le card"),
              cards.filter(function(c){return !c.proposta;}).map(function(c){return h("option",{key:c.id,value:String(c.id)},tipoIcon(c.tipo)+" "+c.titolo.slice(0,35)+(c.titolo.length>35?"‚Ä¶":""));})
            ),
            h("button",{onClick:runAI,disabled:aiLoad,style:{background:aiLoad?"rgba(255,255,255,.1)":"linear-gradient(135deg,#6366f1,#8b5cf6)",color:aiLoad?"rgba(255,255,255,.3)":"#fff",border:"none",borderRadius:8,padding:"6px 16px",cursor:aiLoad?"not-allowed":"pointer",fontSize:12,fontWeight:700}},aiLoad?"‚è≥ Analisi‚Ä¶":"‚ñ∂ Avvia")
          )
        ),
        !aiResult&&!aiLoad&&!aiErr&&h("div",{style:{textAlign:"center",padding:28,color:"rgba(255,255,255,.2)"}},h("div",{style:{fontSize:36}},"üìä"),h("div",{style:{fontWeight:600,fontSize:14,marginTop:8}},"Seleziona e premi Avvia")),
        aiLoad&&h("div",{style:{textAlign:"center",padding:28}},h("div",{style:{fontSize:32,animation:"spin 2s linear infinite",display:"inline-block"}},"‚öôÔ∏è"),h("div",{style:{marginTop:8,fontWeight:600,color:"rgba(255,255,255,.6)"}},"Analisi in corso‚Ä¶")),
        aiErr&&h("div",{style:{color:"#f87171",padding:12,background:"rgba(239,68,68,.1)",borderRadius:9,fontSize:13,marginBottom:8}},aiErr),
        aiResult&&!aiErr&&h(Fragment,null,
          h("div",{style:{background:"rgba(99,102,241,.15)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(99,102,241,.2)"}},
            h("div",{style:{fontWeight:700,color:"#a5b4fc",marginBottom:8,fontSize:11,letterSpacing:1}},"üìã RIEPILOGO PUNTUALE"),
            h("div",{style:{color:"rgba(255,255,255,.85)",fontSize:13,lineHeight:1.8,whiteSpace:"pre-wrap"}},aiResult.riepilogo||aiResult.sintesi||"‚Äî")
          ),
          aiResult.dibattito&&h("div",{style:{background:"rgba(59,130,246,.12)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(59,130,246,.2)"}},
            h("div",{style:{fontWeight:700,color:"#93c5fd",marginBottom:8,fontSize:11,letterSpacing:1}},"üí¨ DINAMICA DEL DIBATTITO"),
            h("div",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.8,whiteSpace:"pre-wrap"}},aiResult.dibattito)
          ),
          aiResult.punti_chiave&&aiResult.punti_chiave.length>0&&h("div",{style:{background:"rgba(245,158,11,.08)",borderRadius:10,padding:14,marginBottom:12,border:"1px solid rgba(245,158,11,.2)"}},
            h("div",{style:{fontWeight:700,color:"#fbbf24",marginBottom:10,fontSize:11,letterSpacing:1}},"üîë PUNTI CHIAVE EMERSI"),
            aiResult.punti_chiave.map(function(s,i){return h("div",{key:i,style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"}},
              h("span",{style:{background:"#f59e0b",color:"#1a1a2e",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:800,flexShrink:0,marginTop:2}},i+1),
              h("span",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.6}},s)
            );})
          ),
          aiResult.spunti_dibattito&&aiResult.spunti_dibattito.length>0&&h("div",{style:{background:"rgba(34,197,94,.08)",borderRadius:10,padding:14,border:"1px solid rgba(34,197,94,.15)"}},
            h("div",{style:{fontWeight:700,color:"#4ade80",marginBottom:10,fontSize:11,letterSpacing:1}},"üí° SPUNTI PER IL DIBATTITO IN CLASSE"),
            aiResult.spunti_dibattito.map(function(s,i){return h("div",{key:i,style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"}},
              h("span",{style:{background:"#22c55e",color:"#fff",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:800,flexShrink:0,marginTop:2}},i+1),
              h("span",{style:{color:"rgba(255,255,255,.8)",fontSize:13,lineHeight:1.6,fontStyle:"italic"}},s)
            );})
          ),
          aiResult.suggerimenti&&!aiResult.punti_chiave&&h("div",{style:{background:"rgba(34,197,94,.08)",borderRadius:10,padding:14,border:"1px solid rgba(34,197,94,.15)"}},
            h("div",{style:{fontWeight:700,color:"#4ade80",marginBottom:10,fontSize:11,letterSpacing:1}},"‚úÖ SUGGERIMENTI"),
            aiResult.suggerimenti.map(function(s,i){return h("div",{key:i,style:{display:"flex",gap:8,marginBottom:8,alignItems:"flex-start"}},
              h("span",{style:{background:"#22c55e",color:"#fff",borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:800,flexShrink:0,marginTop:2}},i+1),
              h("span",{style:{color:"rgba(255,255,255,.7)",fontSize:13,lineHeight:1.6}},s)
            );})
          )
        )
      )
    ),

    showQR&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setSQR(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:26,maxWidth:300,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontWeight:800,color:"#f1f5f9",fontSize:17,marginBottom:4}},"QR Code Bacheca"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:12,marginBottom:14}},"Mostra agli studenti"),
        h("div",{style:{background:"#fff",borderRadius:12,padding:10,display:"inline-block",marginBottom:14}},h("img",{src:qrUrl,alt:"QR",width:200,height:200})),
        h("button",{onClick:function(){setSQR(false);},style:{background:"linear-gradient(135deg,#6366f1,#8b5cf6)",color:"#fff",border:"none",borderRadius:10,padding:"9px 24px",cursor:"pointer",fontSize:13,fontWeight:700,width:"100%"}},"Chiudi")
      )
    ),

    showReset&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setSR(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:320,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:44,marginBottom:10}},"üóëÔ∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},"Reset bacheca"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:13,marginBottom:24,lineHeight:1.5}},"Elimina tutte le card da Firebase."),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setSR(false);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:resetAll,style:{flex:1,padding:11,background:"#ef4444",color:"#fff",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:"pointer"}},"S√¨, resetta")
        )
      )
    ),

    showResetOpt&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setShowResetOpt(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:360,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:44,marginBottom:10,textAlign:"center"}},"üóëÔ∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800,textAlign:"center"}},"Opzioni Reset"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:13,marginBottom:20,lineHeight:1.5,textAlign:"center"}},"Scegli cosa vuoi resettare"),
        h("div",{style:{display:"flex",flexDirection:"column",gap:10,marginBottom:16}},
          h("button",{onClick:resetComments,style:{padding:14,background:"rgba(239,68,68,.15)",color:"#f87171",border:"1px solid rgba(239,68,68,.3)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},
            h("span",{style:{fontSize:20}},"üí¨"),
            h("div",{style:{flex:1}},
              h("div",{style:{fontWeight:800}},"Reset tutti i commenti"),
              h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Rimuove tutti i commenti da tutte le card")
            )
          ),
          h("button",{onClick:resetVotes,style:{padding:14,background:"rgba(245,158,11,.15)",color:"#fbbf24",border:"1px solid rgba(245,158,11,.3)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},
            h("span",{style:{fontSize:20}},"üó≥Ô∏è"),
            h("div",{style:{flex:1}},
              h("div",{style:{fontWeight:800}},"Reset tutti i voti"),
              h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Azzera i voti di tutti i sondaggi")
            )
          ),
          h("button",{onClick:function(){setShowResetOpt(false);setSR(true);},style:{padding:14,background:"rgba(239,68,68,.2)",color:"#f87171",border:"1px solid rgba(239,68,68,.4)",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10}},
            h("span",{style:{fontSize:20}},"üî•"),
            h("div",{style:{flex:1}},
              h("div",{style:{fontWeight:800}},"Reset completo"),
              h("div",{style:{fontSize:11,color:"rgba(255,255,255,.4)",fontWeight:400}},"Elimina tutte le card")
            )
          )
        ),
        h("button",{onClick:function(){setShowResetOpt(false);},style:{width:"100%",padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla")
      )
    ),

    confirmDel&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:350,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setConfirmDel(null);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:340,width:"100%",textAlign:"center"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:48,marginBottom:10}},confirmDel.type==="resetCard"?"üîÑ":"‚ö†Ô∏è"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},confirmDel.type==="resetCard"?"Reset card":"Conferma eliminazione"),
        h("p",{style:{color:"rgba(255,255,255,.4)",fontSize:13,marginBottom:24,lineHeight:1.5}},
          confirmDel.type==="card"?"Eliminare questa card? L'azione √® irreversibile.":
          confirmDel.type==="comment"?"Eliminare questo commento?":
          confirmDel.type==="resetCard"?"Azzerare commenti e voti di questa card? La card rester√† intatta.":
          "Eliminare questa risposta?"
        ),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setConfirmDel(null);},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:function(){
            if(confirmDel.type==="card"){fbDel(confirmDel.id);setSC(null);}
            else if(confirmDel.type==="comment")executeDelCom(confirmDel.cardId,confirmDel.id);
            else if(confirmDel.type==="reply")executeDelReply(confirmDel.cmId,confirmDel.id,confirmDel.cardId);
            else if(confirmDel.type==="resetCard")resetSondaggio(confirmDel.cardId);
            setConfirmDel(null);
          },style:{flex:1,padding:11,background:confirmDel.type==="resetCard"?"#f97316":"#ef4444",color:"#fff",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:"pointer"}},confirmDel.type==="resetCard"?"üîÑ Resetta":"Elimina")
        )
      )
    ),

    askKey&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.7)",zIndex:300,display:"flex",alignItems:"center",justifyContent:"center",padding:20},onClick:function(){setAskKey(false);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,padding:28,maxWidth:400,width:"100%"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{fontSize:36,marginBottom:10}},"üîë"),
        h("h3",{style:{margin:"0 0 8px",color:"#f1f5f9",fontSize:18,fontWeight:800}},"Chiave Groq"),
        h("p",{style:{color:"rgba(255,255,255,.5)",fontSize:12,marginBottom:16,lineHeight:1.5}},"Gratuita (30 req/min). Ottienila su console.groq.com ‚Üí API Keys"),
        orKey&&h("div",{style:{background:"rgba(34,197,94,.1)",border:"1px solid rgba(34,197,94,.3)",borderRadius:8,padding:10,marginBottom:14}},h("div",{style:{color:"#4ade80",fontSize:11,fontWeight:700}},"‚úì Chiave gi√† impostata")),
        h("input",{type:"password",value:akInput,onInput:function(e){setAkInput(e.target.value);},placeholder:"gsk_‚Ä¶",style:Object.assign({},S.input,{marginBottom:12})}),
        h("div",{style:{display:"flex",gap:10}},
          h("button",{onClick:function(){setAskKey(false);setAkInput("");},style:{flex:1,padding:11,background:"rgba(255,255,255,.08)",color:"rgba(255,255,255,.6)",border:"none",borderRadius:11,fontSize:14,fontWeight:700,cursor:"pointer"}},"Annulla"),
          h("button",{onClick:saveAIKey,style:{flex:1,padding:11,background:akInput.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:akInput.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:11,fontSize:14,fontWeight:800,cursor:akInput.trim()?"pointer":"not-allowed"}},"Salva")
        )
      )
    ),

    showCard&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",padding:12},onClick:function(){setSC(null);setEditingCm(null);setReplyTo(null);}},
      h("div",{style:{background:"#1e293b",border:"1px solid rgba(255,255,255,.1)",borderRadius:20,width:"100%",maxWidth:520,maxHeight:"92vh",overflow:"auto"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{background:"linear-gradient(135deg,rgba(99,102,241,.3),rgba(139,92,246,.2))",borderRadius:"20px 20px 0 0",padding:18}},
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}},
            h("span",{style:{background:badgeBg(showCard.tipo),color:"#fff",borderRadius:7,padding:"3px 9px",fontSize:11,fontWeight:800}},tipoIcon(showCard.tipo)+" "+showCard.tipo.toUpperCase()),
            h("button",{onClick:function(){setSC(null);setEditingCm(null);setReplyTo(null);},style:{background:"rgba(255,255,255,.1)",border:"none",borderRadius:"50%",width:28,height:28,cursor:"pointer",fontSize:15,color:"rgba(255,255,255,.7)"}},"√ó")
          ),
          h("h2",{style:{margin:"0 0 8px",color:"#fff",fontSize:17,fontWeight:800,lineHeight:1.3}},showCard.titolo),
          showCard.testo&&h("p",{style:{margin:"0 0 8px",color:"rgba(255,255,255,.65)",fontSize:12,lineHeight:1.7,whiteSpace:"pre-wrap"}},showCard.testo),
          renderLinks(showCard),

          showCard.tipo==="sondaggio"&&showCard.opzioni&&(function(){
            var totV=showCard.opzioni.reduce(function(a,o){return a+o.voti.length;},0);
            var vn=myName(user);
            var myVote=showCard.opzioni.find(function(o){return o.voti.indexOf(vn)>=0;});
            return h("div",{style:{marginTop:12}},
              showCard.opzioni.map(function(o){
                var pct=totV>0?Math.round(o.voti.length/totV*100):0;
                var isMine=myVote&&myVote.id===o.id;
                return h("div",{key:o.id,onClick:function(){vote(showCard.id,o.id);},
                  style:{background:isMine?"rgba(99,102,241,.3)":"rgba(255,255,255,.06)",border:"1px solid "+(isMine?"rgba(99,102,241,.6)":"rgba(255,255,255,.1)"),borderRadius:9,padding:"8px 12px",marginBottom:6,cursor:"pointer",position:"relative",overflow:"hidden",transition:"all .15s"}},
                  h("div",{style:{position:"absolute",left:0,top:0,bottom:0,width:pct+"%",background:"rgba(99,102,241,.2)"}}),
                  h("div",{style:{position:"relative",display:"flex",justifyContent:"space-between",alignItems:"center"}},
                    h("span",{style:{fontSize:13,fontWeight:isMine?700:400,color:"#f1f5f9"}},o.testo),
                    h("div",{style:{display:"flex",alignItems:"center",gap:6}},
                      isMine&&h("span",{style:{fontSize:10,color:"#a5b4fc",fontWeight:700}},"‚úì tuo voto"),
                      h("span",{style:{fontSize:12,color:"rgba(255,255,255,.4)"}},pct+"% ("+o.voti.length+")")
                    )
                  )
                );
              }).concat([h("div",{key:"tot",style:{fontSize:11,color:"rgba(255,255,255,.3)",textAlign:"right",marginTop:4}},totV+" voti"+(myVote?" ¬∑ clicca per cambiare":" ¬∑ clicca per votare"))])
            );
          })(),

          h("div",{style:{marginTop:12,display:"flex",justifyContent:"space-between",alignItems:"center"}},
            h("button",{onClick:function(e){e.stopPropagation();toggleLike(showCard.id);},style:{background:myLikes.current.has(String(showCard.id))?"rgba(99,102,241,.3)":"rgba(255,255,255,.08)",border:"1px solid "+(myLikes.current.has(String(showCard.id))?"rgba(99,102,241,.5)":"rgba(255,255,255,.1)"),borderRadius:20,padding:"5px 14px",cursor:"pointer",fontSize:14,color:myLikes.current.has(String(showCard.id))?"#a5b4fc":"rgba(255,255,255,.5)",display:"flex",alignItems:"center",gap:6,fontWeight:700}},
              "üëç ",(showCard.likes||0)
            ),
            h("span",{style:{fontSize:10,color:"rgba(255,255,255,.3)"}},fmt(showCard.data))
          ),
          isProf&&!simulaSt&&h("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginTop:10}},
            h("button",{onClick:function(){editCard(showCard);setSC(null);},style:{background:"rgba(59,130,246,.2)",color:"#60a5fa",border:"1px solid rgba(59,130,246,.3)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"‚úèÔ∏è Modifica"),
            h("button",{onClick:function(){delCard(showCard.id);},style:{background:"rgba(239,68,68,.12)",color:"#f87171",border:"none",borderRadius:7,padding:"3px 9px",cursor:"pointer",fontSize:11,fontWeight:700}},"üóëÔ∏è Elimina"),
            h("button",{onClick:function(e){toggleVisibile(showCard,e);},style:{background:showCard.visibile===false?"rgba(34,197,94,.15)":"rgba(255,255,255,.08)",color:showCard.visibile===false?"#4ade80":"rgba(255,255,255,.5)",border:"1px solid "+(showCard.visibile===false?"rgba(34,197,94,.3)":"rgba(255,255,255,.1)"),borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},showCard.visibile===false?"üëÅÔ∏è Mostra":"üö´ Nascondi"),
            h("button",{onClick:function(e){e.stopPropagation();setConfirmDel({type:"resetCard",cardId:showCard.id});},style:{background:"rgba(249,115,22,.15)",color:"#fb923c",border:"1px solid rgba(249,115,22,.35)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,fontWeight:700}},"üîÑ Reset")
          )
        ),

        h("div",{style:{padding:"14px 16px"}},
          h("div",{style:{fontWeight:700,color:"rgba(255,255,255,.7)",fontSize:13,marginBottom:10}},"üí¨ Commenti ("+(showCard.commenti||[]).length+")"),
          (showCard.commenti||[]).length===0&&h("div",{style:{color:"rgba(255,255,255,.25)",fontSize:12,textAlign:"center",padding:"12px 0"}},"Nessun commento. Sii il primo!"),
          (showCard.commenti||[]).map(function(cm){
            var isMyCm=cm.autore===myName(user);
            var isEditing=editingCm&&editingCm.id===cm.id;
            var isReplying=replyTo&&replyTo.id===cm.id;
            return h("div",{key:cm.id,style:{marginBottom:10}},
              h("div",{style:{background:"rgba(255,255,255,.04)",borderRadius:9,padding:"8px 10px",border:"1px solid "+(isMyCm?"rgba(99,102,241,.2)":"rgba(255,255,255,.06)")}},
                h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}},
                  h("span",{style:{fontWeight:700,fontSize:12,color:isMyCm?"#a5b4fc":"rgba(255,255,255,.6)"}},cm.autore+(cm.modificato?" ‚úé":"")),
                  h("div",{style:{display:"flex",gap:6,alignItems:"center"}},
                    h("span",{style:{fontSize:10,color:"rgba(255,255,255,.25)"}},fmt(cm.data)),
                    (isMyCm||isProf)&&!isEditing&&h("button",{onClick:function(){setEditingCm({id:cm.id,testo:cm.testo});},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(99,102,241,.7)",fontSize:12,fontWeight:700}},"‚úèÔ∏è"),
                    isProf&&h("button",{onClick:function(){setConfirmDel({type:"comment",cardId:showCard.id,id:cm.id});},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,.2)",fontSize:13}},"√ó")
                  )
                ),
                isEditing
                  ?h("div",null,
                      h("textarea",{value:editingCm.testo,onInput:function(e){setEditingCm(function(p){return Object.assign({},p,{testo:e.target.value});});},rows:2,style:Object.assign({},S.input,{resize:"none",marginBottom:6,fontSize:12})}),
                      h("div",{style:{display:"flex",gap:6}},
                        h("button",{onClick:function(){saveEditCm(showCard.id);},style:{flex:1,padding:"5px 0",background:"linear-gradient(135deg,#6366f1,#8b5cf6)",color:"#fff",border:"none",borderRadius:7,fontSize:12,fontWeight:700,cursor:"pointer"}},"Salva"),
                        h("button",{onClick:function(){setEditingCm(null);},style:{padding:"5px 10px",background:"rgba(255,255,255,.07)",color:"rgba(255,255,255,.4)",border:"none",borderRadius:7,fontSize:12,cursor:"pointer"}},"Annulla")
                      )
                    )
                  :h("div",null,
                      h("div",{style:{fontSize:12,color:"rgba(255,255,255,.65)",lineHeight:1.5,marginBottom:6}},cm.testo),
                      h("button",{onClick:function(){setReplyTo({id:cm.id,autore:cm.autore});setReplyTesto("");},style:{background:"rgba(99,102,241,.1)",border:"1px solid rgba(99,102,241,.25)",borderRadius:6,padding:"3px 8px",cursor:"pointer",fontSize:10,color:"#a5b4fc",fontWeight:700}},"‚Ü©Ô∏è Rispondi")
                    )
              ),
              (cm.risposte||[]).length>0&&h("div",{style:{marginLeft:20,marginTop:6,display:"flex",flexDirection:"column",gap:5}},
                cm.risposte.map(function(r){
                  var isMyReply=r.autore===myName(user);
                  return h("div",{key:r.id,style:{background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.04)",borderRadius:7,padding:"6px 8px",fontSize:11}},
                    h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:2}},
                      h("span",{style:{fontWeight:700,fontSize:11,color:isMyReply?"#93c5fd":"rgba(255,255,255,.5)"}},r.autore),
                      h("div",{style:{display:"flex",gap:4,alignItems:"center"}},
                        h("span",{style:{fontSize:9,color:"rgba(255,255,255,.2)"}},fmt(r.data)),
                        (isMyReply||isProf)&&h("button",{onClick:function(){setConfirmDel({type:"reply",cmId:cm.id,id:r.id,cardId:showCard.id});},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,.2)",fontSize:11}},"√ó")
                      )
                    ),
                    h("div",{style:{color:"rgba(255,255,255,.6)",lineHeight:1.4}},r.testo)
                  );
                })
              ),
              isReplying&&h("div",{style:{marginLeft:20,marginTop:6,background:"rgba(99,102,241,.08)",borderRadius:7,padding:8,border:"1px solid rgba(99,102,241,.2)"}},
                h("div",{style:{fontSize:10,color:"#a5b4fc",marginBottom:4,fontWeight:700}},"‚Ü©Ô∏è Rispondi a "+replyTo.autore),
                h("textarea",{value:replyTesto,onInput:function(e){setReplyTesto(e.target.value);},rows:2,placeholder:"Scrivi una risposta‚Ä¶",style:Object.assign({},S.input,{resize:"none",marginBottom:6,fontSize:11})}),
                h("div",{style:{display:"flex",gap:6}},
                  h("button",{onClick:function(){addReply(cm.id);},style:{flex:1,padding:"5px 0",background:replyTesto.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:replyTesto.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:7,fontSize:11,fontWeight:700,cursor:replyTesto.trim()?"pointer":"not-allowed"}},"Invia"),
                  h("button",{onClick:function(){setReplyTo(null);setReplyTesto("");},style:{padding:"5px 10px",background:"rgba(255,255,255,.07)",color:"rgba(255,255,255,.4)",border:"none",borderRadius:7,fontSize:11,cursor:"pointer"}},"Annulla")
                )
              )
            );
          }),
          h("div",{style:{marginTop:10,background:"rgba(255,255,255,.03)",borderRadius:10,padding:12,border:"1px solid rgba(255,255,255,.07)"}},
            h("div",{style:{fontSize:11,fontWeight:700,color:"#a5b4fc",marginBottom:7,padding:"4px 9px",background:"rgba(99,102,241,.15)",borderRadius:7}},"üë§ "+myName(user)),
            h("textarea",{id:"cm-textarea",value:nc.testo,onInput:function(e){setNc({testo:e.target.value});},rows:2,placeholder:"Scrivi un commento‚Ä¶",style:Object.assign({},S.input,{resize:"none",marginBottom:7})}),
            h("button",{onClick:addCom,style:{width:"100%",padding:8,background:nc.testo.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:nc.testo.trim()?"#fff":"rgba(255,255,255,.25)",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer"}},"Pubblica commento")
          )
        )
      )
    ),

    showModal&&h("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,.75)",zIndex:200,display:"flex",alignItems:"flex-end",justifyContent:"center"},onClick:function(){setSM(false);setEditMode(null);}},
      h("div",{style:{background:"#1e293b",borderRadius:"20px 20px 0 0",padding:20,width:"100%",maxWidth:540,maxHeight:"90vh",overflow:"auto",border:"1px solid rgba(255,255,255,.1)",borderBottom:"none"},onClick:function(e){e.stopPropagation();}},
        h("div",{style:{width:32,height:3,background:"rgba(255,255,255,.15)",borderRadius:4,margin:"0 auto 16px"}}),
        h("h3",{style:{margin:"0 0 4px",color:"#f1f5f9",fontSize:15,fontWeight:800}},editMode?"‚úèÔ∏è Modifica card":(!isProf?"üí° Proponi una discussione":"Nuova card")),
        !isProf&&!editMode&&h("p",{style:{margin:"0 0 14px",color:"rgba(255,255,255,.3)",fontSize:11}},"Visibile dopo approvazione del professore"),
        isProf&&h("div",{style:{display:"flex",gap:7,marginBottom:14}},
          [{v:"domanda",i:"üí¨"},{v:"nota",i:"üìÑ"},{v:"sondaggio",i:"üó≥Ô∏è"}].map(function(t){
            return h("button",{key:t.v,onClick:function(){setForm(function(p){return Object.assign({},p,{tipo:t.v});});},
              style:{flex:1,padding:"8px 4px",border:"1px solid "+(form.tipo===t.v?"#6366f1":"rgba(255,255,255,.1)"),borderRadius:10,background:form.tipo===t.v?"rgba(99,102,241,.25)":"rgba(255,255,255,.04)",cursor:"pointer",fontWeight:700,fontSize:12,color:form.tipo===t.v?"#a5b4fc":"rgba(255,255,255,.4)"}},t.i+" "+t.v);
          })
        ),
        h("div",{style:{marginBottom:10}},
          h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"TITOLO *"),
          h("input",{value:form.titolo,onInput:function(e){setForm(function(p){return Object.assign({},p,{titolo:e.target.value});});},placeholder:"Es. Riflessione su‚Ä¶",style:S.input})
        ),
        h("div",{style:{marginBottom:10}},
          h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"TESTO"),
          h("textarea",{value:form.testo,onInput:function(e){setForm(function(p){return Object.assign({},p,{testo:e.target.value});});},rows:3,placeholder:"Descrizione, spunti‚Ä¶",style:Object.assign({},S.input,{resize:"vertical"})})
        ),
        h("div",{style:{marginBottom:10}},
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
            h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",letterSpacing:1}},"üîó LINK PER APPROFONDIRE"),
            (form.links||[]).length<5&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{links:(p.links||[]).concat([{url:"",label:""}])});});},
              style:{background:"rgba(99,102,241,.2)",border:"1px solid rgba(99,102,241,.4)",borderRadius:7,padding:"3px 10px",cursor:"pointer",fontSize:11,color:"#a5b4fc",fontWeight:700}},"+ Aggiungi")
          ),
          (form.links||[]).map(function(l,i){
            return h("div",{key:i,style:{background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.08)",borderRadius:9,padding:"8px 10px",marginBottom:6}},
              h("div",{style:{display:"flex",gap:5,marginBottom:5}},
                h("input",{value:l.url,onInput:function(e){setForm(function(p){var ls=p.links.map(function(x,j){return j===i?Object.assign({},x,{url:e.target.value}):x;});return Object.assign({},p,{links:ls});});},placeholder:"https://‚Ä¶",style:Object.assign({},S.input,{flex:1})}),
                (form.links||[]).length>1&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{links:p.links.filter(function(_,j){return j!==i;})});});},
                  style:{background:"rgba(239,68,68,.2)",color:"#f87171",border:"none",borderRadius:7,padding:"0 9px",cursor:"pointer",fontSize:16,flexShrink:0}},"√ó")
              ),
              h("input",{value:l.label,onInput:function(e){setForm(function(p){var ls=p.links.map(function(x,j){return j===i?Object.assign({},x,{label:e.target.value}):x;});return Object.assign({},p,{links:ls});});},placeholder:"Etichetta (es. Wikipedia, Video‚Ä¶)",style:Object.assign({},S.input,{fontSize:11})})
            );
          })
        ),
        form.tipo==="sondaggio"&&h("div",{style:{marginBottom:10}},
          h("label",{style:{fontSize:10,fontWeight:700,color:"rgba(255,255,255,.4)",display:"block",marginBottom:4,letterSpacing:1}},"OPZIONI"),
          form.opzioni.map(function(o,i){return h("div",{key:i,style:{display:"flex",gap:5,marginBottom:6}},
            h("input",{value:o,onInput:function(e){setForm(function(p){var ops=p.opzioni.slice();ops[i]=e.target.value;return Object.assign({},p,{opzioni:ops});});},placeholder:"Opzione "+(i+1),style:S.input}),
            form.opzioni.length>2&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{opzioni:p.opzioni.filter(function(_,j){return j!==i;})});});},style:{background:"rgba(239,68,68,.2)",color:"#f87171",border:"none",borderRadius:7,padding:"0 9px",cursor:"pointer",fontSize:16}},"√ó")
          );}),
          form.opzioni.length<6&&h("button",{onClick:function(){setForm(function(p){return Object.assign({},p,{opzioni:p.opzioni.concat([""])});});},style:{background:"rgba(255,255,255,.04)",border:"1px dashed rgba(255,255,255,.15)",borderRadius:7,padding:"5px 12px",cursor:"pointer",fontSize:12,color:"rgba(255,255,255,.4)",width:"100%"}},"+ Aggiungi opzione")
        ),
        h("button",{onClick:addCard,style:{width:"100%",padding:13,marginTop:4,background:form.titolo.trim()?"linear-gradient(135deg,#6366f1,#8b5cf6)":"rgba(255,255,255,.06)",color:form.titolo.trim()?"#fff":"rgba(255,255,255,.2)",border:"none",borderRadius:12,fontSize:14,fontWeight:800,cursor:form.titolo.trim()?"pointer":"not-allowed"}},
          editMode?"üíæ Salva modifiche":(!isProf?"üì© Invia proposta":"üìå Pubblica card"))
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(h(App,null));
})();
</script>
</body>
</html>
